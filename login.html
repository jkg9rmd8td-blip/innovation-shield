<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Innovation Shield V2 | Demo Auth</title>
  <link rel="stylesheet" href="frontend/shared/design-system/tokens.css" />
  <link rel="stylesheet" href="frontend/shared/styles/reset.css" />
  <link rel="stylesheet" href="frontend/shared/styles/base.css" />
  <link rel="stylesheet" href="frontend/shared/design-system/components.css" />
  <style>
    main {
      width: min(520px, 100% - 32px);
      margin-top: 52px;
    }
    .login-card { padding: 20px; }
    .login-card h1 { margin: 0 0 8px; }
    .field { margin-bottom: 12px; }
    .field label { display: block; margin-bottom: 6px; color: var(--muted); font-size: 13px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .error { margin-top: 8px; color: var(--danger); min-height: 20px; }
    .hint { margin-top: 10px; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <main>
    <section class="card apple-glass login-card">
      <h1>Demo Login (V2)</h1>
      <p class="muted">Bilingual-ready auth flow. Default API base: <code>http://127.0.0.1:8080</code></p>

      <div class="field">
        <label for="apiBase">API Base</label>
        <input class="input" id="apiBase" placeholder="http://127.0.0.1:8080" />
      </div>

      <div class="field">
        <label for="name">Name</label>
        <input class="input" id="name" value="Demo User" />
      </div>

      <div class="field">
        <label for="role">Role</label>
        <select class="select" id="role">
          <option value="innovator">innovator</option>
          <option value="evaluator">evaluator</option>
          <option value="manager">manager</option>
          <option value="committee">committee</option>
        </select>
      </div>

      <div class="field">
        <label for="department">Department</label>
        <input class="input" id="department" value="Innovation" />
      </div>

      <div class="actions">
        <button class="btn primary" id="loginBtn" type="button">Sign in</button>
        <button class="btn ghost" id="langBtn" type="button">AR/EN</button>
      </div>

      <div class="error" id="error"></div>
      <div class="hint">Portal mapping: innovator -> Employee, evaluator -> Judging, manager/committee -> Admin.</div>
    </section>
  </main>

  <script type="module">
    import { setApiBase, api } from "./frontend/shared/core/api-client.js";
    import { saveSession } from "./frontend/shared/core/auth-client.js";
    import { toggleLang } from "./frontend/shared/i18n/index.js";

    const mapPortal = {
      innovator: "/frontend/portals/employee/index.html",
      evaluator: "/frontend/portals/judging/index.html",
      manager: "/frontend/portals/admin/index.html",
      committee: "/frontend/portals/admin/index.html",
    };

    const apiBase = document.getElementById("apiBase");
    const error = document.getElementById("error");
    apiBase.value = localStorage.getItem("IS_API_BASE") || "http://127.0.0.1:8080";

    document.getElementById("langBtn")?.addEventListener("click", () => {
      toggleLang();
      location.reload();
    });

    document.getElementById("loginBtn")?.addEventListener("click", async () => {
      error.textContent = "";
      try {
        setApiBase(apiBase.value.trim() || "http://127.0.0.1:8080");
        const payload = {
          name: document.getElementById("name").value.trim(),
          role: document.getElementById("role").value,
          department: document.getElementById("department").value.trim(),
        };

        const res = await api("/api/v2/auth/session", { method: "POST", body: payload, auth: false });
        saveSession(res.data);
        location.href = mapPortal[payload.role] || "/frontend/portals/employee/index.html";
      } catch (err) {
        error.textContent = err.message || "Login failed";
      }
    });
  </script>
</body>
</html>
