<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <title>درع الابتكار | لوحة القيادة</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/app.css" />
    <style>
        :root {
            --cmd-bg: #0D0F12;
            --cmd-card: #161A1F;
            --cmd-border: #1F242A;
            --cmd-text: #E6E6E6;
            --cmd-muted: #AAB4C0;
            --cmd-blue: #4DA8FF;
            --cmd-risk: #FF4D6D;
            --cmd-ai: #A970FF;
            --cmd-ok: #2EDB92;
            --cmd-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
        }

        body.career-body {
            background: var(--cmd-bg);
            color: var(--cmd-text);
        }

        .platform-bg {
            opacity: 0.86;
        }

        .platform-topbar {
            border-color: var(--cmd-border);
            background: rgba(13, 15, 18, 0.78);
            animation: topFadeSlide .4s ease both;
        }

        .platform-shell .panel,
        .stat-card,
        .summary-box,
        .command-header-strip,
        .matrix-legend,
        .drop-zone {
            border-color: var(--cmd-border) !important;
            background: rgba(22, 26, 31, 0.88) !important;
            color: var(--cmd-text);
            backdrop-filter: blur(14px) saturate(120%);
            -webkit-backdrop-filter: blur(14px) saturate(120%);
            box-shadow: var(--cmd-shadow);
        }

        .panel-note,
        .topbar-sub,
        .stat-card small,
        .stage-tip,
        .timeline-horizontal small,
        .org-subtext,
        .api-hint {
            color: var(--cmd-muted) !important;
        }

        .topbar-actions {
            gap: 6px;
        }

        .topbar-actions .btn {
            padding: 7px 12px;
            font-size: 12px;
        }

        .unified-main-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .unified-main-actions .btn,
        .unified-main-actions a.btn {
            min-height: 38px;
            font-weight: 800;
        }

        .unified-main-actions .is-current {
            border-color: rgba(97, 176, 255, 0.45);
            background: rgba(77, 168, 255, 0.14);
            color: #dfefff;
            box-shadow: 0 8px 18px rgba(20, 91, 160, 0.30);
        }

        .live-pill {
            border-color: var(--cmd-border);
            color: var(--cmd-text);
            background: rgba(255, 255, 255, 0.04);
        }

        .live-pill.is-on {
            border-color: rgba(77, 168, 255, 0.42);
            color: var(--cmd-blue);
            background: rgba(77, 168, 255, 0.11);
            box-shadow: 0 0 0 1px rgba(77, 168, 255, 0.15), 0 0 18px rgba(77, 168, 255, 0.24);
        }

        .mode-pill {
            border-color: rgba(169, 112, 255, 0.35);
            color: var(--cmd-ai);
            background: rgba(169, 112, 255, 0.1);
        }

        .command-header-strip {
            border: 1px solid var(--cmd-border);
            border-radius: 16px;
            padding: 11px 12px;
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 10px;
        }

        .header-metric {
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            min-height: 64px;
            display: grid;
            gap: 2px;
        }

        .header-metric span {
            font-size: 11px;
            color: var(--cmd-muted);
            font-weight: 700;
        }

        .header-metric strong {
            font-size: 21px;
            color: var(--cmd-blue);
            font-weight: 900;
            letter-spacing: .2px;
        }

        .header-metric em {
            font-size: 11px;
            color: var(--cmd-muted);
            font-style: normal;
            font-weight: 700;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .control-grid .wide {
            grid-column: span 2;
        }

        .table-tools {
            align-items: center;
        }

        .executive-grid {
            display: grid;
            grid-template-columns: 1fr 1.1fr 1fr;
            gap: 12px;
        }

        .exec-col {
            display: grid;
            gap: 12px;
            align-content: start;
        }

        .summary-box {
            border: 1px solid var(--cmd-border);
            border-radius: 14px;
            padding: 14px;
        }

        .summary-list {
            margin: 0;
            padding-right: 18px;
            display: grid;
            gap: 6px;
            color: var(--cmd-text);
        }

        .summary-list strong {
            color: var(--cmd-blue);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .stat-card {
            position: relative;
            overflow: hidden;
            transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
        }

        .stat-card::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 0 2px 2px 0;
            background: var(--cmd-blue);
            opacity: .9;
        }

        .stat-card.indicator-ai::before {
            background: var(--cmd-ai);
        }

        .stat-card.indicator-risk::before {
            background: var(--cmd-risk);
        }

        .stat-card.indicator-approve::before {
            background: var(--cmd-ok);
        }

        .stat-card p {
            color: var(--cmd-muted);
        }

        .stat-card h3 {
            color: var(--cmd-blue);
            margin-top: 8px;
            margin-bottom: 4px;
            text-shadow: 0 0 12px rgba(77, 168, 255, 0.22);
        }

        .kpi-actions {
            margin-top: 6px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .kpi-actions .btn {
            padding: 5px 8px;
            font-size: 11px;
        }

        .matrix-table,
        .watch-table,
        .drill-table,
        .org-compare-table {
            width: 100%;
            border-collapse: collapse;
        }

        .matrix-table th,
        .matrix-table td,
        .watch-table th,
        .watch-table td,
        .drill-table th,
        .drill-table td,
        .org-compare-table th,
        .org-compare-table td {
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            padding: 8px;
            font-size: 12px;
            text-align: right;
            vertical-align: top;
        }

        .matrix-table th,
        .watch-table th,
        .drill-table th,
        .org-compare-table th {
            color: #b6c6d8;
            font-weight: 800;
            border-bottom-color: rgba(255, 255, 255, 0.12);
        }

        .matrix-table tr.top-performer {
            background: rgba(46, 219, 146, 0.07);
        }

        .matrix-table tr.high-risk-row {
            background: rgba(255, 77, 109, 0.08);
        }

        .matrix-table tr.ai-leader-row {
            background: rgba(169, 112, 255, 0.09);
        }

        .matrix-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .matrix-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 7px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            font-size: 10px;
            font-weight: 800;
        }

        .matrix-badge.top {
            border-color: rgba(46, 219, 146, 0.35);
            color: #86f5c7;
            background: rgba(46, 219, 146, 0.12);
        }

        .matrix-badge.risk {
            border-color: rgba(255, 77, 109, 0.35);
            color: #ff95aa;
            background: rgba(255, 77, 109, 0.12);
        }

        .matrix-badge.ai {
            border-color: rgba(169, 112, 255, 0.4);
            color: #c7a5ff;
            background: rgba(169, 112, 255, 0.14);
        }

        .spark-stack {
            display: grid;
            gap: 4px;
            min-width: 120px;
        }

        .spark-row {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .spark-row span {
            font-size: 10px;
            color: var(--cmd-muted);
            min-width: 24px;
        }

        .sparkline {
            width: 94px;
            height: 20px;
            flex: 1;
            display: block;
        }

        .sparkline path.line {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .sparkline path.fill {
            opacity: .18;
        }

        .spark-risk .line {
            stroke: var(--cmd-risk);
            filter: drop-shadow(0 0 4px rgba(255, 77, 109, 0.45));
        }

        .spark-risk .fill {
            fill: rgba(255, 77, 109, 0.2);
        }

        .spark-ai .line {
            stroke: var(--cmd-ai);
            filter: drop-shadow(0 0 4px rgba(169, 112, 255, 0.48));
        }

        .spark-ai .fill {
            fill: rgba(169, 112, 255, 0.2);
        }

        .spark-count .line {
            stroke: var(--cmd-blue);
            filter: drop-shadow(0 0 4px rgba(77, 168, 255, 0.48));
        }

        .spark-count .fill {
            fill: rgba(77, 168, 255, 0.2);
        }

        .heat-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        .heat-cell {
            border-radius: 12px;
            border: 1px solid var(--cmd-border);
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            transition: transform .2s ease;
        }

        .heat-cell strong {
            display: block;
            margin-bottom: 4px;
        }

        .heat-cell small {
            display: block;
            color: var(--cmd-muted);
            font-weight: 700;
        }

        .heat-1 {
            box-shadow: inset 0 0 0 1px rgba(46, 219, 146, 0.4);
        }

        .heat-2 {
            box-shadow: inset 0 0 0 1px rgba(255, 185, 73, 0.46);
        }

        .heat-3 {
            box-shadow: inset 0 0 0 1px rgba(255, 77, 109, 0.5);
        }

        .timeline-horizontal {
            display: grid;
            gap: 10px;
        }

        .timeline-track {
            height: 6px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.08);
        }

        .timeline-track span {
            display: block;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--cmd-blue), var(--cmd-ai));
            box-shadow: 0 0 12px rgba(77, 168, 255, 0.55);
            transition: width .65s ease;
        }

        .stage-nodes {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 8px;
        }

        .stage-node {
            position: relative;
            border: 1px solid var(--cmd-border);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
            padding: 8px 6px;
            text-align: center;
            cursor: default;
            display: grid;
            gap: 6px;
        }

        .stage-node .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.06);
        }

        .stage-node.active .dot {
            background: var(--cmd-blue);
            box-shadow: 0 0 0 4px rgba(77, 168, 255, 0.22), 0 0 12px rgba(77, 168, 255, 0.5);
        }

        .stage-node .label {
            font-size: 11px;
            color: #cfdae5;
            font-weight: 800;
            line-height: 1.5;
        }

        .stage-tip {
            pointer-events: none;
            opacity: 0;
            transform: translateY(4px);
            position: absolute;
            right: 50%;
            translate: 50% 0;
            top: calc(100% + 4px);
            min-width: 148px;
            border: 1px solid var(--cmd-border);
            border-radius: 10px;
            padding: 7px;
            background: rgba(13, 15, 18, 0.96);
            font-size: 11px;
            text-align: right;
            display: grid;
            gap: 2px;
            z-index: 5;
            transition: opacity .18s ease, transform .18s ease;
        }

        .stage-node:hover .stage-tip {
            opacity: 1;
            transform: translateY(0);
        }

        .event-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 6px;
        }

        .event-list li {
            border: 1px solid rgba(255, 255, 255, 0.07);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.02);
            padding: 7px 8px;
        }

        .event-list strong {
            display: block;
            margin-bottom: 2px;
            font-size: 12px;
        }

        .event-list small {
            font-size: 11px;
            color: var(--cmd-muted);
            font-weight: 700;
        }

        .ai-intel-list,
        .insight-list,
        .critical-list {
            margin: 0;
            padding-right: 18px;
            display: grid;
            gap: 6px;
        }

        .ai-intel-list li,
        .critical-card,
        .drop-zone,
        .matrix-legend {
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
            padding: 8px;
        }

        .critical-list {
            list-style: none;
            padding: 0;
            gap: 8px;
        }

        .critical-card {
            display: grid;
            gap: 6px;
        }

        .critical-head {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .critical-card p {
            margin: 0;
            color: var(--cmd-muted);
            font-size: 12px;
        }

        .critical-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .critical-actions .btn,
        .watch-table .btn,
        .matrix-table .btn,
        .drill-table .btn {
            padding: 5px 8px;
            font-size: 11px;
        }

        .broadcast-grid {
            display: grid;
            gap: 8px;
        }

        .broadcast-block {
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
            padding: 8px;
            display: grid;
            gap: 6px;
        }

        .broadcast-block strong {
            font-size: 12px;
            color: var(--cmd-blue);
        }

        .broadcast-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 6px;
        }

        .broadcast-list li {
            border: 1px solid rgba(255, 255, 255, 0.07);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.02);
            padding: 7px 8px;
            font-size: 12px;
            color: var(--cmd-text);
            line-height: 1.55;
        }

        .broadcast-list li small {
            display: block;
            color: var(--cmd-muted);
            font-size: 11px;
            margin-top: 2px;
        }

        .watch-table td small {
            color: var(--cmd-muted);
            display: block;
            margin-top: 3px;
            font-weight: 700;
        }

        .org-pool {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .org-chip {
            cursor: grab;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.04);
            color: var(--cmd-text);
            padding: 5px 9px;
            font-size: 11px;
            font-weight: 800;
        }

        .org-chip:active {
            cursor: grabbing;
        }

        .drop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .drop-zone {
            min-height: 76px;
            display: grid;
            align-content: center;
            justify-items: center;
            gap: 6px;
            text-align: center;
        }

        .drop-zone.drag-over {
            border-color: rgba(77, 168, 255, 0.55);
            box-shadow: 0 0 0 1px rgba(77, 168, 255, 0.2) inset;
        }

        .drop-zone strong {
            font-size: 12px;
        }

        .drop-zone .slot {
            color: var(--cmd-blue);
            font-weight: 900;
            font-size: 13px;
        }

        .matrix-legend {
            margin-bottom: 8px;
            font-size: 11px;
            color: var(--cmd-muted);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .table-wrap {
            border-color: rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.01);
        }

        .table-wrap table,
        .proto-table {
            color: var(--cmd-text);
        }

        .proto-table th,
        .proto-table td {
            border-bottom-color: rgba(255, 255, 255, 0.07);
        }

        .modal-card {
            background: rgba(22, 26, 31, 0.95);
            border-color: var(--cmd-border);
            color: var(--cmd-text);
        }

        .drill-table,
        .drill-table th,
        .drill-table td {
            border-bottom-color: rgba(255, 255, 255, 0.08);
        }

        .modal-headline {
            margin: 0;
            font-size: 16px;
        }

        .btn,
        .stat-card,
        .panel,
        .heat-cell {
            transform-origin: center;
            transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease, filter .2s ease;
        }

        .btn:hover,
        .stat-card:hover,
        .panel:hover,
        .heat-cell:hover {
            transform: scale(1.02);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.44);
            border-color: rgba(77, 168, 255, 0.22) !important;
        }

        #smartComparePanel.focus-mode {
            border-color: rgba(169, 112, 255, 0.55) !important;
            box-shadow: 0 0 0 1px rgba(169, 112, 255, 0.28), 0 16px 32px rgba(0, 0, 0, 0.5);
        }

        .ripple-host {
            position: relative;
            overflow: hidden;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            background: rgba(77, 168, 255, 0.3);
            animation: ripple .6s ease-out;
            pointer-events: none;
        }

        body.loading-skeleton .skeletonable {
            position: relative;
            overflow: hidden;
        }

        body.loading-skeleton .skeletonable::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.09), rgba(255, 255, 255, 0.03));
            animation: shimmer 1.1s linear infinite;
            z-index: 2;
        }

        body.loading-skeleton .skeletonable>* {
            opacity: 0.08;
            filter: grayscale(1);
        }

        .stage-bars {
            display: grid;
            gap: 8px;
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .stage-item {
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            animation: stageFade .45s ease both;
        }

        .stage-item-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .stage-item-head strong {
            color: #bed7ff;
            font-size: 12px;
        }

        .stage-track {
            height: 7px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.07);
        }

        .stage-track span {
            display: block;
            height: 100%;
            background: linear-gradient(180deg, rgba(169, 112, 255, 0.85), rgba(77, 168, 255, 0.88));
            box-shadow: 0 0 10px rgba(77, 168, 255, 0.35);
        }

        .points-line {
            margin-top: 4px;
            font-size: 11px;
            color: var(--cmd-muted);
            font-weight: 700;
        }

        body.cinematic-mode {
            --cmd-shadow: 0 14px 32px rgba(0, 0, 0, 0.55);
        }

        body.cinematic-mode .platform-bg {
            filter: saturate(1.2) brightness(.85);
        }

        body.cinematic-mode .stat-card h3,
        body.cinematic-mode .header-metric strong {
            font-size: clamp(1.5rem, 2.7vw, 2.3rem);
            letter-spacing: .3px;
        }

        body.cinematic-mode .panel-note,
        body.cinematic-mode .topbar-sub {
            opacity: .85;
        }

        body.command-mode .mode-pill {
            border-color: rgba(255, 77, 109, 0.38);
            color: #ff8fa4;
            background: rgba(255, 77, 109, 0.12);
        }

        .empty-line {
            color: var(--cmd-muted);
        }

        .empty-action-box {
            border: 1px dashed rgba(255, 255, 255, 0.24);
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.03);
            padding: 10px;
            display: grid;
            gap: 6px;
        }

        .empty-action-box p {
            margin: 0;
            font-size: 12px;
            color: var(--cmd-muted);
        }

        .empty-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        @keyframes shimmer {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(100%);
            }
        }

        @keyframes topFadeSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes stageFade {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 1240px) {
            .executive-grid {
                grid-template-columns: 1fr 1fr;
            }

            .exec-col:nth-child(3) {
                grid-column: span 2;
            }

            .stage-nodes {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }

            .command-header-strip {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .control-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .control-grid .wide {
                grid-column: span 3;
            }
        }

        @media (max-width: 900px) {
            .executive-grid {
                grid-template-columns: 1fr;
            }

            .exec-col:nth-child(3) {
                grid-column: span 1;
            }

            .drop-grid,
            .heat-grid {
                grid-template-columns: 1fr;
            }

            .stage-nodes {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .control-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .control-grid .wide {
                grid-column: span 2;
            }
        }

        @media (max-width: 640px) {
            .command-header-strip,
            .control-grid {
                grid-template-columns: 1fr;
            }

            .control-grid .wide {
                grid-column: span 1;
            }

            .stage-nodes {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body class="career-body">

    <div class="platform-bg">
        <div class="mesh mesh-1"></div>
        <div class="mesh mesh-2"></div>
        <div class="mesh mesh-3"></div>
    </div>

    <div class="platform-shell">

        <header class="platform-topbar reveal">
            <div class="topbar-brand">
                <div class="brand-mark">IS</div>
                <div>
                    <h1 class="topbar-title">لوحة القيادة التنفيذية</h1>
                    <p class="topbar-sub">Dark Premium • Cinematic Charts • Smart Compare • Command Mode</p>
                </div>
            </div>

            <nav class="nav">
                <a href="../../index.html">الرئيسية</a>
                <a href="../map/index.html">خريطة الابتكار</a>
                <a href="../prototype/index.html">النماذج الأولية</a>
                <a href="../employee/index.html">مسار الموظف</a>
                <a href="../judging/index.html">التحكيم</a>
                <a href="../command/index.html" class="active">لوحة القيادة</a>
                <a href="../policies/index.html">السياسات</a>
                <a href="../report/index.html">التقرير التنفيذي</a>
                <a href="../about/index.html">عن المنصة</a>
            </nav>

            <div class="topbar-actions">
                <span class="live-pill" id="liveState">LIVE: OFF</span>
                <span class="live-pill mode-pill" id="modeState">Standard Mode</span>
                <button class="btn btn-soft" id="btnLiveToggle">تشغيل Live</button>
                <button class="btn btn-soft" id="btnCommandMode">Command Mode: OFF</button>
                <button class="btn btn-soft" id="btnCinematicMode">Cinematic: OFF</button>
                <button class="btn btn-soft" id="btnSmartCompare">Smart Compare: OFF</button>
                <button class="btn btn-ghost" id="btnApiSettings">API</button>
                <button class="btn btn-soft" id="btnExecReport">فتح التقرير</button>
                <button class="btn btn-primary" id="btnPrint">طباعة</button>
            </div>
        </header>

        <section class="panel reveal skeletonable">
            <div class="unified-main-actions">
                <a href="../about/index.html" class="btn btn-soft">تعريف عن المنصة</a>
                <button class="btn btn-primary" id="btnUnifiedStart">بدء مبادرة</button>
                <a href="../map/index.html" class="btn btn-soft">الخريطة</a>
                <a href="../judging/index.html" class="btn btn-soft">التحكيم</a>
            </div>
        </section>

        <section class="command-header-strip reveal skeletonable">
            <div class="header-metric">
                <span>عدد المبادرات</span>
                <strong id="hbTotal">—</strong>
                <em id="hbScope">—</em>
            </div>
            <div class="header-metric">
                <span>متوسط الذكاء الاصطناعي</span>
                <strong id="hbAi">—</strong>
                <em>AI Readiness</em>
            </div>
            <div class="header-metric">
                <span>متوسط المخاطر</span>
                <strong id="hbRisk">—</strong>
                <em>Residual Risk</em>
            </div>
            <div class="header-metric">
                <span>آخر تحديث</span>
                <strong id="hbUpdated">—</strong>
                <em id="hbMode">—</em>
            </div>
        </section>

        <section class="panel reveal skeletonable">
            <div class="panel-head">
                <h3>Filters 2.0</h3>
                <span class="panel-note">بحث دلالي • مخاطر • أولوية • جهة • تاريخ</span>
            </div>

            <div class="control-grid">
                <input id="q" class="wide" placeholder="بحث نصي بالعنوان أو المعرف…" />
                <input id="qSemantic" class="wide" placeholder="بحث دلالي Semantic Search…" />
                <select id="stage">
                    <option value="">كل المراحل</option>
                </select>
                <select id="status">
                    <option value="">كل الحالات</option>
                </select>
                <select id="tag">
                    <option value="">كل التصنيفات</option>
                </select>
                <select id="priorityFilter">
                    <option value="">كل الأولويات</option>
                    <option value="حرجة">حرجة</option>
                    <option value="عالية">عالية</option>
                    <option value="متوسطة">متوسطة</option>
                    <option value="منخفضة">منخفضة</option>
                </select>
                <select id="riskFilter">
                    <option value="">كل المخاطر</option>
                    <option value="high">مرتفعة</option>
                    <option value="medium">متوسطة</option>
                    <option value="low">منخفضة</option>
                </select>
                <select id="orgFilter">
                    <option value="">كل الجهات</option>
                </select>
                <input id="dateFrom" type="date" />
                <input id="dateTo" type="date" />
            </div>

            <div class="table-tools" style="margin-top:10px;">
                <span class="table-count" id="pill">—</span>
                <button class="btn btn-soft" id="btnRefresh">تحديث لحظي</button>
                <button class="btn btn-ghost" id="btnReset">إعادة تعيين</button>
            </div>
        </section>

        <section class="panel reveal skeletonable">
            <div class="panel-head">
                <h3>Executive Summary</h3>
                <span class="panel-note" id="summaryStamp">—</span>
            </div>
            <div class="summary-box">
                <ul class="summary-list" id="summaryList"></ul>
            </div>
        </section>

        <section class="executive-grid reveal">

            <div class="exec-col">
                <section class="panel skeletonable" id="smartComparePanel">
                    <div class="panel-head">
                        <h3>KPIs</h3>
                        <span class="panel-note">العمود التنفيذي</span>
                    </div>
                    <div class="kpi-grid">
                        <div class="stat-card indicator-ai" data-drill="total">
                            <p>إجمالي المبادرات</p>
                            <h3 id="kTotal">—</h3>
                            <small>داخل نطاق الفلاتر</small>
                            <div class="kpi-actions"><button class="btn btn-soft" data-drill="total">Drill-down</button></div>
                        </div>
                        <div class="stat-card indicator-ai" data-drill="judging">
                            <p>قيد التحكيم</p>
                            <h3 id="kJudging">—</h3>
                            <small>بانتظار القرارات</small>
                            <div class="kpi-actions"><button class="btn btn-soft" data-drill="judging">Drill-down</button></div>
                        </div>
                        <div class="stat-card indicator-ai" data-drill="proto">
                            <p>Prototype Active</p>
                            <h3 id="kProto">—</h3>
                            <small>مرحلة النموذج الأولي</small>
                            <div class="kpi-actions"><button class="btn btn-soft" data-drill="proto">Drill-down</button></div>
                        </div>
                        <div class="stat-card indicator-approve" data-drill="applied">
                            <p>معتمدة / مطبقة</p>
                            <h3 id="kApplied">—</h3>
                            <small>جاهزة للتوسع</small>
                            <div class="kpi-actions"><button class="btn btn-soft" data-drill="applied">Drill-down</button></div>
                        </div>
                        <div class="stat-card indicator-risk" data-drill="riskHigh">
                            <p>مخاطر حرجة</p>
                            <h3 id="kHighRisk">—</h3>
                            <small>Residual Risk ≥ 70%</small>
                            <div class="kpi-actions"><button class="btn btn-soft" data-drill="riskHigh">Drill-down</button></div>
                        </div>
                        <div class="stat-card indicator-ai" data-drill="economic">
                            <p>الأثر الاقتصادي السنوي</p>
                            <h3 id="kEconomic">—</h3>
                            <small>Net Annual (SAR)</small>
                            <div class="kpi-actions"><button class="btn btn-soft" data-drill="economic">Drill-down</button></div>
                        </div>
                        <div class="stat-card indicator-ai" data-drill="aiHigh">
                            <p>متوسط توقع النجاح AI</p>
                            <h3 id="kAiAvg">—</h3>
                            <small>Prediction Score</small>
                            <div class="kpi-actions"><button class="btn btn-soft" data-drill="aiHigh">Drill-down</button></div>
                        </div>
                        <div class="stat-card indicator-risk" data-drill="critical">
                            <p>مبادرات حرجة</p>
                            <h3 id="kCritical">—</h3>
                            <small>أولوية + مخاطر + تعثر</small>
                            <div class="kpi-actions"><button class="btn btn-soft" data-drill="critical">Drill-down</button></div>
                        </div>
                        <div class="stat-card indicator-risk" data-drill="stalled">
                            <p>مبادرات متعثرة</p>
                            <h3 id="kStalled">—</h3>
                            <small>تقدم منخفض لفترة طويلة</small>
                            <div class="kpi-actions"><button class="btn btn-soft" data-drill="stalled">Drill-down</button></div>
                        </div>
                        <div class="stat-card indicator-approve" data-drill="post6m">
                            <p>متابعة 6 أشهر</p>
                            <h3 id="kPost6m">—</h3>
                            <small>مكتمل بعد التطبيق</small>
                            <div class="kpi-actions"><button class="btn btn-soft" data-drill="post6m">Drill-down</button></div>
                        </div>
                    </div>
                </section>

                <section class="panel skeletonable">
                    <div class="panel-head">
                        <h3>توزيع المراحل (Cinematic)</h3>
                        <span class="panel-note">Glow + Gradient + Fade</span>
                    </div>
                    <ul class="stage-bars" id="stageBars"></ul>
                </section>
            </div>

            <div class="exec-col">
                <section class="panel skeletonable">
                    <div class="panel-head">
                        <h3>Comparison Matrix</h3>
                        <span class="panel-note">Top Performer • High Risk • AI Leader</span>
                    </div>
                    <div class="table-wrap">
                        <table class="matrix-table">
                            <thead>
                                <tr>
                                    <th>الجهة</th>
                                    <th>المبادرات</th>
                                    <th>معتمد/مطبق</th>
                                    <th>AI</th>
                                    <th>Risk</th>
                                    <th>Mini Trends</th>
                                    <th>Badges</th>
                                </tr>
                            </thead>
                            <tbody id="orgRows"></tbody>
                        </table>
                    </div>
                </section>

                <section class="panel skeletonable">
                    <div class="panel-head">
                        <h3>Smart Compare</h3>
                        <span class="panel-note">اسحب جهتين للمقارنة البصرية</span>
                    </div>
                    <div class="matrix-legend">
                        <span>1) اسحب اسم الجهة</span>
                        <span>2) أفلته في المقعد A أو B</span>
                        <span>3) شاهد الفروقات التنفيذية</span>
                    </div>
                    <div class="org-pool" id="comparePool"></div>
                    <div class="drop-grid">
                        <div class="drop-zone" id="compareDropA" data-slot="a">
                            <strong>جهة A</strong>
                            <div class="slot" id="compareSlotA">اسحب جهة هنا</div>
                        </div>
                        <div class="drop-zone" id="compareDropB" data-slot="b">
                            <strong>جهة B</strong>
                            <div class="slot" id="compareSlotB">اسحب جهة هنا</div>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table class="org-compare-table">
                            <thead>
                                <tr>
                                    <th>المؤشر</th>
                                    <th>A</th>
                                    <th>B</th>
                                    <th>الفارق</th>
                                </tr>
                            </thead>
                            <tbody id="compareBody"></tbody>
                        </table>
                    </div>
                </section>

                <section class="panel skeletonable">
                    <div class="panel-head">
                        <h3>Heatmap الأولويات</h3>
                        <span class="panel-note">Priority × Risk × AI</span>
                    </div>
                    <div class="heat-grid" id="heatGrid"></div>
                </section>
            </div>

            <div class="exec-col">
                <section class="panel skeletonable">
                    <div class="panel-head">
                        <h3>التحليل الذكي</h3>
                        <span class="panel-note">AI Recommendations</span>
                    </div>
                    <ul class="ai-intel-list" id="aiIntelList"></ul>
                </section>

                <section class="panel skeletonable">
                    <div class="panel-head">
                        <h3>Smart Alerts</h3>
                        <span class="panel-note">تنبيهات فورية للإدارة</span>
                    </div>
                    <ul class="insight-list" id="smartAlerts"></ul>
                </section>

                <section class="panel skeletonable">
                    <div class="panel-head">
                        <h3>Innovation Broadcast</h3>
                        <span class="panel-note" id="broadcastStamp">نشرة أسبوعية تلقائية</span>
                    </div>
                    <div class="table-tools" style="margin-bottom:10px;">
                        <button class="btn btn-soft" id="btnGenerateBroadcast">توليد النشرة</button>
                        <button class="btn btn-ghost" id="btnCopyBroadcast">نسخ الملخص</button>
                        <span class="table-count" id="broadcastArchiveCount">0 نشرات</span>
                    </div>

                    <div class="broadcast-grid">
                        <article class="broadcast-block">
                            <strong>أفضل الأفكار</strong>
                            <ul class="broadcast-list" id="broadcastTopIdeas"></ul>
                        </article>
                        <article class="broadcast-block">
                            <strong>التحديات المفتوحة</strong>
                            <ul class="broadcast-list" id="broadcastChallenges"></ul>
                        </article>
                        <article class="broadcast-block">
                            <strong>النتائج</strong>
                            <ul class="broadcast-list" id="broadcastResults"></ul>
                        </article>
                    </div>

                    <div class="panel-head" style="margin-top:10px;">
                        <h3 style="font-size:13px;">أرشيف النشرات</h3>
                        <span class="panel-note">آخر 3 نشرات</span>
                    </div>
                    <ul class="event-list" id="broadcastArchive"></ul>
                </section>

                <section class="panel skeletonable">
                    <div class="panel-head">
                        <h3>Timeline تفاعلي</h3>
                        <span class="panel-note">Nodes • Progress • Hover Insight</span>
                    </div>
                    <div class="timeline-horizontal">
                        <div class="timeline-track"><span id="timelineProgress"></span></div>
                        <div class="stage-nodes" id="stageTimeline"></div>
                        <ul class="event-list" id="eventTimeline"></ul>
                    </div>
                </section>
            </div>

        </section>

        <section class="insights-grid reveal">
            <section class="panel skeletonable">
                <div class="panel-head">
                    <h3>Intensive Monitoring</h3>
                    <span class="panel-note">Watch Score + توصيات التدخل</span>
                </div>
                <div class="table-wrap">
                    <table class="watch-table">
                        <thead>
                            <tr>
                                <th>المعرف</th>
                                <th>المبادرة</th>
                                <th>الجهة</th>
                                <th>Watch Score</th>
                                <th>الخطر</th>
                                <th>AI</th>
                                <th>التقدم</th>
                                <th>إجراء</th>
                            </tr>
                        </thead>
                        <tbody id="monitorBody"></tbody>
                    </table>
                </div>
            </section>

            <section class="panel skeletonable">
                <div class="panel-head">
                    <h3>المبادرات الحرجة والمتعثرة</h3>
                    <span class="panel-note">إدارة سريعة للحالات العاجلة</span>
                </div>
                <ul class="critical-list" id="criticalList"></ul>
            </section>
        </section>

        <section class="panel reveal skeletonable">
            <div class="panel-head">
                <h3>قائمة المبادرات</h3>
                <span class="panel-note">Drill-ready Table</span>
            </div>

            <div class="table-wrap">
                <table class="proto-table">
                    <thead>
                        <tr>
                            <th>المعرف</th>
                            <th>العنوان</th>
                            <th>الجهة</th>
                            <th>التصنيف</th>
                            <th>المرحلة</th>
                            <th>الحالة</th>
                            <th>الأولوية</th>
                            <th>الخطر</th>
                            <th>AI</th>
                            <th>الأثر الاقتصادي</th>
                            <th>إجراء</th>
                        </tr>
                    </thead>
                    <tbody id="tb"></tbody>
                </table>
            </div>

            <div class="empty-line empty-action-box" id="empty" style="display:none; margin-top:10px;">
                <strong>لا توجد نتائج وفق الفلاتر الحالية.</strong>
                <p>ماذا أفعل الآن؟ أعد الفلاتر، أو ابدأ مبادرة جديدة، أو انتقل إلى التحكيم لمراجعة الحالات النشطة.</p>
                <div class="empty-actions">
                    <button class="btn btn-soft" id="btnEmptyReset">إعادة الفلاتر</button>
                    <button class="btn btn-primary" id="btnEmptyStart">بدء مبادرة</button>
                    <button class="btn btn-ghost" id="btnEmptyJudging">فتح التحكيم</button>
                </div>
            </div>
        </section>

        <section class="panel reveal skeletonable">
            <div class="panel-head">
                <h3>Audit Timeline</h3>
                <span class="panel-note">آخر 18 حدث</span>
            </div>
            <ul class="timeline" id="audit"></ul>
        </section>

    </div>

    <div class="modal hidden" id="modalDrill">
        <div class="modal-backdrop" data-close-drill></div>
        <div class="modal-card" style="max-width:980px; width:min(980px, calc(100vw - 24px));">
            <div class="modal-head">
                <h3 class="modal-headline" id="drillTitle">تفاصيل المؤشر</h3>
                <button class="modal-close" data-close-drill>✕</button>
            </div>
            <div class="table-wrap">
                <table class="drill-table">
                    <thead>
                        <tr>
                            <th>المعرف</th>
                            <th>العنوان</th>
                            <th>المرحلة</th>
                            <th>الحالة</th>
                            <th>سبب الظهور</th>
                            <th>إجراء</th>
                        </tr>
                    </thead>
                    <tbody id="drillBody"></tbody>
                </table>
            </div>
            <div class="empty-line empty-action-box" id="drillEmpty" style="display:none; margin-top:10px;">
                <strong>لا توجد بيانات لهذا المؤشر.</strong>
                <p>ماذا أفعل الآن؟ جرّب توسيع النطاق أو إعادة تعيين الفلاتر لعرض بيانات أكثر.</p>
                <div class="empty-actions">
                    <button class="btn btn-soft" id="btnDrillResetFilters">إعادة الفلاتر</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="modalApi">
        <div class="modal-backdrop" data-close-api></div>
        <div class="modal-card" style="max-width:560px; width:min(560px, calc(100vw - 24px));">
            <div class="modal-head">
                <h3>إعدادات API</h3>
                <button class="modal-close" data-close-api>✕</button>
            </div>
            <div class="form-grid">
                <label>API Base URL</label>
                <input id="apiBaseInput" placeholder="http://127.0.0.1:8080" dir="ltr" />
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                <button class="btn btn-soft" id="btnApiTest">اختبار الاتصال</button>
                <button class="btn btn-primary" id="btnApiSave">حفظ</button>
            </div>
            <p class="api-hint" id="apiStateHint">عند الحفظ سيتم استخدام المصدر المحلي إذا تعذر الاتصال.</p>
        </div>
    </div>

    <script src="../../assets/js/app.js"></script>
    <script>
        (() => {
            "use strict";
            const $ = (s, r = document) => r.querySelector(s);
            const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
            const IS = window.IS;
            const API_BASE_KEY = "IS_API_BASE";

            let liveMode = false;
            let liveTimer = null;
            let commandMode = false;
            let cinematicMode = false;
            let smartCompareMode = false;
            let orgStatsCache = [];
            let latestBroadcastText = "";
            const compareState = { a: "", b: "" };
            const WEEK_MS = 7 * 24 * 60 * 60 * 1000;

            const fmt = (n) => new Intl.NumberFormat("ar-SA").format(Number(n || 0));
            const esc = (v) => String(v ?? "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, "&quot;")
                .replace(/'/g, "&#39;");
            const clamp = (n, a, b) => Math.max(a, Math.min(b, Number(n || 0)));
            const nowISO = () => new Date().toISOString();
            const normalize = (t) => String(t || "").toLowerCase().trim().replace(/\s+/g, " ");

            const STATUS_OPTIONS = ["مسودة", "قيد التحكيم", "قيد التطوير", "معتمد", "مرفوض", "مطبق", "متعثر"];
            const PRIORITY_OPTIONS = ["حرجة", "عالية", "متوسطة", "منخفضة"];
            const STALLED_DAYS = 45;

            const semanticAliases = {
                تشغيل: ["تشغيلي", "عمليات", "workflow", "operation"],
                مالي: ["اقتصادي", "تكلفة", "وفر", "roi", "budget"],
                تجربة: ["مستفيد", "مريض", "رحلة", "experience"],
                رقمنة: ["تقني", "نظام", "dashboard", "automation", "ai"],
                سريري: ["clinical", "care", "جودة سريرية"],
                جودة: ["quality", "سلامة", "مؤشر"]
            };

            function getApiBase() {
                return (localStorage.getItem(API_BASE_KEY) || "http://127.0.0.1:8080").trim();
            }

            function setApiBase(v) {
                const base = String(v || "").trim().replace(/\/$/, "");
                localStorage.setItem(API_BASE_KEY, base);
                return base;
            }

            function openApiModal() {
                $("#apiBaseInput").value = getApiBase();
                $("#apiStateHint").textContent = "عند الحفظ سيتم استخدام المصدر المحلي إذا تعذر الاتصال.";
                $("#modalApi").classList.remove("hidden");
            }

            function closeApiModal() {
                $("#modalApi").classList.add("hidden");
            }

            function withTimeout(promise, timeoutMs = 3200) {
                return Promise.race([
                    promise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), timeoutMs))
                ]);
            }

            async function apiRequest(path, { method = "GET", body, timeoutMs = 3400 } = {}) {
                const res = await withTimeout(fetch(`${getApiBase()}${path}`, {
                    method,
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: body ? JSON.stringify(body) : undefined
                }), timeoutMs);
                if (!res.ok) {
                    const txt = await res.text().catch(() => "");
                    throw new Error(`HTTP ${res.status} ${txt}`);
                }
                const json = await res.json().catch(() => null);
                return json;
            }

            function nowLocal() {
                return new Date().toLocaleString("ar-SA");
            }

            function daysSince(iso) {
                if (!iso) return 999;
                const t = new Date(iso).getTime();
                if (!Number.isFinite(t)) return 999;
                return Math.floor((Date.now() - t) / (24 * 60 * 60 * 1000));
            }

            function safeOrg(i) {
                if (i.org && String(i.org).trim()) return String(i.org).trim();
                if (i.organization && String(i.organization).trim()) return String(i.organization).trim();
                return "جهة غير محددة";
            }

            function safePriority(i) {
                const raw = String(i.priority || "").trim();
                if (PRIORITY_OPTIONS.includes(raw)) return raw;
                const risk = calcRiskProfile(i.riskProfile || {}).residualPct;
                if (risk >= 80) return "حرجة";
                if (risk >= 60) return "عالية";
                if (risk >= 40) return "متوسطة";
                return "منخفضة";
            }

            function normalizeInitiative(raw) {
                const i = { ...(raw || {}) };
                i.id = String(i.id || `I-${Math.floor(1000 + Math.random() * 9000)}`);
                i.title = String(i.title || "مبادرة بدون عنوان");
                i.stage = String(i.stage || "الفكرة");
                i.status = String(i.status || "مسودة");
                i.tags = Array.isArray(i.tags) ? i.tags.map((x) => String(x || "").trim()).filter(Boolean) : [];
                i.org = safeOrg(i);
                i.priority = safePriority(i);
                i.progress = clamp(i.progress ?? i.prototype?.progress ?? 0, 0, 100);
                i.score = i.score == null ? null : clamp(i.score, 0, 100);

                i.validation = i.validation && typeof i.validation === "object" ? i.validation : {};
                i.impact = i.impact && typeof i.impact === "object" ? i.impact : {};
                i.riskProfile = i.riskProfile && typeof i.riskProfile === "object" ? i.riskProfile : {};
                i.postMonitoring = i.postMonitoring && typeof i.postMonitoring === "object" ? i.postMonitoring : {};
                i.prototype = i.prototype && typeof i.prototype === "object" ? i.prototype : null;

                i.createdAt = i.createdAt || nowISO();
                i.updatedAt = i.updatedAt || i.createdAt;
                return i;
            }

            function calcEconomicImpact(impact) {
                const model = impact || {};
                const saving = Math.max(0, Number(model.costSaving || 0));
                const implementationCost = Math.max(0, Number(model.implementationCost || 0));
                const operatingCost = Math.max(0, Number(model.operatingCost || 0));
                const horizonYears = clamp(Number(model.horizonYears || 3), 1, 5);
                const confidencePct = clamp(Number(model.confidencePct || 75), 10, 100);
                const adjustedSaving = Math.round(saving * (confidencePct / 100));
                const netAnnual = adjustedSaving - operatingCost;
                const netOverHorizon = (netAnnual * horizonYears) - implementationCost;
                const roiPct = implementationCost > 0 ? Math.round((netOverHorizon / implementationCost) * 100) : 0;
                const paybackMonths = netAnnual > 0 ? Math.round((implementationCost / netAnnual) * 12) : null;
                return { adjustedSaving, netAnnual, netOverHorizon, roiPct, paybackMonths };
            }

            function calcRiskProfile(profile) {
                const p = profile || {};
                const vals = [
                    clamp(Number(p.operational || 2), 1, 5),
                    clamp(Number(p.financial || 2), 1, 5),
                    clamp(Number(p.technical || 2), 1, 5),
                    clamp(Number(p.quality || 2), 1, 5),
                    clamp(Number(p.experience || 2), 1, 5)
                ];
                const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
                const indexPct = Math.round((avg / 5) * 100);
                const mitigationEffectivenessPct = clamp(Number(p.mitigationEffectivenessPct || 0), 0, 100);
                const residualPct = Math.round(indexPct * (1 - (mitigationEffectivenessPct / 100)));
                const level = residualPct >= 70 ? "مرتفع" : (residualPct >= 40 ? "متوسط" : "منخفض");
                return { indexPct, residualPct, level };
            }

            function rubricScoreFromObject(rubric) {
                const r = rubric || {};
                const vals = ["problem", "feasible", "impact", "prototype", "risk"]
                    .map((k) => clamp(Number(r[k] || 0), 0, 5));
                return Math.round((vals.reduce((a, b) => a + b, 0) / 25) * 100);
            }

            function calcSuccessPrediction(initiative) {
                const ini = initiative || {};
                if (ini.aiPrediction && Number.isFinite(Number(ini.aiPrediction.score))) {
                    const s = clamp(Number(ini.aiPrediction.score), 0, 100);
                    const level = String(ini.aiPrediction.level || (s >= 75 ? "مرتفع" : (s >= 55 ? "متوسط" : "منخفض")));
                    return { score: s, level, recommendation: level === "مرتفع" ? "جاهز للتوسع" : (level === "متوسط" ? "تحسين قبل الاعتماد" : "إعادة ضبط الفرضيات") };
                }

                const validation = ini.validation || {};
                const validationCompleted = ["problem", "beneficiary", "evidence"]
                    .map((k) => String(validation[k] || "").trim())
                    .filter(Boolean).length;
                const validationPct = Math.round((validationCompleted / 3) * 100);
                const rubricPct = Number.isFinite(Number(ini.score))
                    ? clamp(Number(ini.score), 0, 100)
                    : rubricScoreFromObject(ini.rubric);
                const econ = calcEconomicImpact(ini.impact || {});
                const econPct = clamp(Math.round((econ.roiPct + 100) / 2), 0, 100);
                const riskPct = 100 - calcRiskProfile(ini.riskProfile || {}).residualPct;
                const execPct = clamp(Number(ini.prototype?.progress ?? ini.progress ?? 0), 0, 100);
                const score = Math.round((rubricPct * 0.30) + (validationPct * 0.22) + (econPct * 0.22) + (riskPct * 0.18) + (execPct * 0.08));
                const level = score >= 75 ? "مرتفع" : (score >= 55 ? "متوسط" : "منخفض");
                return { score, level, recommendation: level === "مرتفع" ? "جاهز للتوسع" : (level === "متوسط" ? "تحسين قبل الاعتماد" : "إعادة ضبط الفرضيات") };
            }

            function calcPostMonitoring(postMonitoring, fallbackImpact) {
                const m = postMonitoring || {};
                const expectedAnnualSaving = Math.max(0, Number(m.expected?.annualSaving ?? fallbackImpact?.costSaving ?? 0));
                const m6AnnualSaving = (m.m6?.annualSaving == null || m.m6?.annualSaving === "") ? null : Math.max(0, Number(m.m6.annualSaving));
                const m6Done = m6AnnualSaving != null || m.m6?.timeSavingPct != null;
                const m6AchievementPct = (expectedAnnualSaving > 0 && m6AnnualSaving != null)
                    ? Math.round((m6AnnualSaving / expectedAnnualSaving) * 100)
                    : null;
                return { expectedAnnualSaving, m6AnnualSaving, m6Done, m6AchievementPct };
            }

            function isApplied(i) {
                return i.stage === "التطبيق" || i.stage === "الاعتماد" || i.status === "مطبق" || i.status === "معتمد";
            }

            function isCritical(i) {
                const risk = calcRiskProfile(i.riskProfile || {}).residualPct;
                return i.priority === "حرجة" || risk >= 70 || i.status === "متعثر";
            }

            function isStalled(i) {
                const stale = daysSince(i.updatedAt) >= STALLED_DAYS;
                const lowProgress = Number(i.progress || 0) < 45;
                const advancedStage = ["التقييم", "تشكيل الفريق", "النموذج الأولي", "التجربة", "الاعتماد", "التطبيق"].includes(i.stage);
                return stale && lowProgress && advancedStage;
            }

            function bucketRisk(i) {
                const r = calcRiskProfile(i.riskProfile || {}).residualPct;
                return r >= 70 ? "high" : (r >= 40 ? "medium" : "low");
            }

            function semanticMatch(i, query) {
                if (!query) return true;
                const tokens = normalize(query).split(" ").filter(Boolean);
                if (!tokens.length) return true;
                const hay = normalize([
                    i.id,
                    i.title,
                    i.stage,
                    i.status,
                    i.priority,
                    i.org,
                    ...(i.tags || []),
                    i.validation?.problem,
                    i.validation?.beneficiary,
                    i.validation?.evidence
                ].join(" "));
                return tokens.every((t) => {
                    if (hay.includes(t)) return true;
                    const aliases = Object.entries(semanticAliases).find(([key]) => key.includes(t) || t.includes(key));
                    return !!(aliases && aliases[1].some((a) => hay.includes(normalize(a))));
                });
            }

            function readFilters() {
                return {
                    q: normalize($("#q").value),
                    qSemantic: normalize($("#qSemantic").value),
                    stage: $("#stage").value || "",
                    status: $("#status").value || "",
                    tag: $("#tag").value || "",
                    priority: $("#priorityFilter").value || "",
                    risk: $("#riskFilter").value || "",
                    org: $("#orgFilter").value || "",
                    dateFrom: $("#dateFrom").value || "",
                    dateTo: $("#dateTo").value || ""
                };
            }

            function getFiltered(all, filters = readFilters()) {
                return (all || []).filter((i) => {
                    const hay = normalize(`${i.id} ${i.title} ${i.stage} ${i.status} ${i.priority} ${i.org} ${(i.tags || []).join(" ")}`);
                    const okQ = !filters.q || hay.includes(filters.q);
                    const okSemantic = !filters.qSemantic || semanticMatch(i, filters.qSemantic);
                    const okStage = !filters.stage || i.stage === filters.stage;
                    const okStatus = !filters.status || i.status === filters.status;
                    const okTag = !filters.tag || (i.tags || []).includes(filters.tag);
                    const okPriority = !filters.priority || i.priority === filters.priority;
                    const okRisk = !filters.risk || bucketRisk(i) === filters.risk;
                    const okOrg = !filters.org || i.org === filters.org;
                    const d = (i.createdAt || "").slice(0, 10);
                    const okDateFrom = !filters.dateFrom || !d || d >= filters.dateFrom;
                    const okDateTo = !filters.dateTo || !d || d <= filters.dateTo;
                    return okQ && okSemantic && okStage && okStatus && okTag && okPriority && okRisk && okOrg && okDateFrom && okDateTo;
                });
            }

            function fillSelectors(all) {
                const keep = {
                    stage: $("#stage").value,
                    status: $("#status").value,
                    tag: $("#tag").value,
                    org: $("#orgFilter").value
                };

                const stages = Array.from(new Set((IS.state.stages || []).concat((all || []).map((i) => i.stage)).filter(Boolean)));
                const tags = Array.from(new Set((IS.state.taxonomy || []).concat((all || []).flatMap((i) => i.tags || [])).filter(Boolean)));
                const statuses = Array.from(new Set(STATUS_OPTIONS.concat((all || []).map((i) => i.status)).filter(Boolean)));
                const orgs = Array.from(new Set((all || []).map((i) => i.org).filter(Boolean)));

                $("#stage").innerHTML = `<option value="">كل المراحل</option>` + stages.map((s) => `<option>${esc(s)}</option>`).join("");
                $("#status").innerHTML = `<option value="">كل الحالات</option>` + statuses.map((s) => `<option>${esc(s)}</option>`).join("");
                $("#tag").innerHTML = `<option value="">كل التصنيفات</option>` + tags.map((t) => `<option>${esc(t)}</option>`).join("");
                $("#orgFilter").innerHTML = `<option value="">كل الجهات</option>` + orgs.map((o) => `<option>${esc(o)}</option>`).join("");

                $("#stage").value = keep.stage;
                $("#status").value = keep.status;
                $("#tag").value = keep.tag;
                $("#orgFilter").value = keep.org;
            }

            function watchScore(i) {
                const risk = calcRiskProfile(i.riskProfile || {}).residualPct;
                const ai = calcSuccessPrediction(i).score;
                const staleDays = Math.max(0, daysSince(i.updatedAt) - 14);
                const criticalWeight = i.priority === "حرجة" ? 18 : (i.priority === "عالية" ? 10 : 0);
                const stalledWeight = isStalled(i) ? 22 : 0;
                const score = Math.round((risk * 0.42) + ((100 - i.progress) * 0.24) + ((100 - ai) * 0.18) + (Math.min(100, staleDays) * 0.08) + criticalWeight + stalledWeight);
                return clamp(score, 0, 100);
            }

            function hashNum(str) {
                let h = 0;
                const s = String(str || "");
                for (let i = 0; i < s.length; i += 1) h = ((h << 5) - h) + s.charCodeAt(i);
                return Math.abs(h);
            }

            function buildSeries(base, seed, range = 9) {
                const arr = [];
                let v = clamp(base, 0, 100);
                for (let i = 0; i < 7; i += 1) {
                    const drift = ((seed >> i) % range) - Math.floor(range / 2);
                    v = clamp(v + drift, 8, 96);
                    arr.push(Math.round(v));
                }
                return arr;
            }

            function sparklineSvg(values, kind) {
                const w = 94;
                const h = 20;
                const max = Math.max(...values, 1);
                const min = Math.min(...values, 0);
                const pad = 2;
                const xStep = (w - pad * 2) / (values.length - 1 || 1);
                const normY = (v) => {
                    const t = max === min ? 0.5 : (v - min) / (max - min);
                    return Math.round((h - pad) - (t * (h - pad * 2)));
                };
                const points = values.map((v, idx) => `${Math.round(pad + idx * xStep)},${normY(v)}`).join(" ");
                const first = points.split(" ")[0] || `${pad},${h - pad}`;
                const last = points.split(" ").slice(-1)[0] || `${w - pad},${h - pad}`;
                const fillPath = `M ${first} L ${points} L ${last.split(",")[0]},${h - pad} L ${first.split(",")[0]},${h - pad} Z`;
                return `
                    <svg viewBox="0 0 ${w} ${h}" class="sparkline spark-${kind}" aria-hidden="true">
                        <path class="fill" d="${fillPath}"></path>
                        <path class="line" d="M ${points}"></path>
                    </svg>
                `;
            }

            function renderHeaderStrip(list, all) {
                const total = list.length;
                const scope = all.length ? Math.round((list.length / all.length) * 100) : 0;
                const aiVals = list.map((i) => calcSuccessPrediction(i).score);
                const aiAvg = aiVals.length ? Math.round(aiVals.reduce((a, b) => a + b, 0) / aiVals.length) : 0;
                const riskVals = list.map((i) => calcRiskProfile(i.riskProfile).residualPct);
                const riskAvg = riskVals.length ? Math.round(riskVals.reduce((a, b) => a + b, 0) / riskVals.length) : 0;
                $("#hbTotal").textContent = fmt(total);
                $("#hbScope").textContent = `${fmt(scope)}% من المحفظة`;
                $("#hbAi").textContent = `${fmt(aiAvg)}%`;
                $("#hbRisk").textContent = `${fmt(riskAvg)}%`;
                $("#hbUpdated").textContent = nowLocal();
                $("#hbMode").textContent = commandMode ? "Command Mode" : "Standard View";
            }

            function renderSummary(list, all) {
                const critical = list.filter(isCritical).length;
                const stalled = list.filter(isStalled).length;
                const ai = list.map((i) => calcSuccessPrediction(i).score);
                const aiAvg = ai.length ? Math.round(ai.reduce((a, b) => a + b, 0) / ai.length) : 0;
                const net = list.reduce((s, i) => s + calcEconomicImpact(i.impact).netAnnual, 0);
                const applied = list.filter(isApplied).length;
                const scopePct = all.length ? Math.round((list.length / all.length) * 100) : 0;

                $("#summaryStamp").textContent = `آخر تحديث: ${nowLocal()}`;
                $("#summaryList").innerHTML = `
                    <li>النطاق الحالي يغطي <strong>${fmt(list.length)}</strong> مبادرة (${fmt(scopePct)}% من إجمالي المنصة).</li>
                    <li>عدد المبادرات الحرجة <strong>${fmt(critical)}</strong> والمتعثرة <strong>${fmt(stalled)}</strong> ويتطلب تدخلًا فوريًا.</li>
                    <li>متوسط توقع النجاح بالذكاء الاصطناعي <strong>${fmt(aiAvg)}%</strong> مع صافي أثر اقتصادي سنوي <strong>${fmt(net)} SAR</strong>.</li>
                    <li>تم اعتماد/تطبيق <strong>${fmt(applied)}</strong> مبادرة ضمن النطاق الحالي.</li>
                `;
            }

            function renderKPIs(list) {
                const total = list.length;
                const judging = list.filter((i) => i.status === "قيد التحكيم").length;
                const proto = list.filter((i) => i.stage === "النموذج الأولي" || !!i.prototype).length;
                const applied = list.filter(isApplied).length;
                const highRisk = list.filter((i) => calcRiskProfile(i.riskProfile).residualPct >= 70).length;
                const economic = list.reduce((s, i) => s + calcEconomicImpact(i.impact).netAnnual, 0);
                const aiScores = list.map((i) => calcSuccessPrediction(i).score);
                const aiAvg = aiScores.length ? Math.round(aiScores.reduce((a, b) => a + b, 0) / aiScores.length) : 0;
                const critical = list.filter(isCritical).length;
                const stalled = list.filter(isStalled).length;
                const postScope = list.filter(isApplied);
                const post6m = postScope.filter((i) => calcPostMonitoring(i.postMonitoring, i.impact).m6Done).length;

                $("#kTotal").textContent = fmt(total);
                $("#kJudging").textContent = fmt(judging);
                $("#kProto").textContent = fmt(proto);
                $("#kApplied").textContent = fmt(applied);
                $("#kHighRisk").textContent = fmt(highRisk);
                $("#kEconomic").textContent = fmt(economic);
                $("#kAiAvg").textContent = `${fmt(aiAvg)}%`;
                $("#kCritical").textContent = fmt(critical);
                $("#kStalled").textContent = fmt(stalled);
                $("#kPost6m").textContent = fmt(post6m);
            }

            function renderStageBars(list) {
                const stages = IS.state.stages || [];
                const total = list.length || 1;
                const counts = {};
                stages.forEach((s) => { counts[s] = 0; });
                list.forEach((i) => { counts[i.stage] = (counts[i.stage] || 0) + 1; });

                $("#stageBars").innerHTML = stages.map((stage) => {
                    const bucket = list.filter((i) => i.stage === stage);
                    const c = counts[stage] || 0;
                    const pct = Math.round((c / total) * 100);
                    const avgRisk = bucket.length
                        ? Math.round(bucket.reduce((sum, i) => sum + calcRiskProfile(i.riskProfile).residualPct, 0) / bucket.length)
                        : 0;
                    const avgAi = bucket.length
                        ? Math.round(bucket.reduce((sum, i) => sum + calcSuccessPrediction(i).score, 0) / bucket.length)
                        : 0;
                    return `
                        <li class="stage-item">
                            <div class="stage-item-head">
                                <span>${esc(stage)}</span>
                                <strong>${fmt(c)} • ${pct}%</strong>
                            </div>
                            <div class="stage-track"><span style="width:${pct}%"></span></div>
                            <div class="points-line">Risk: ${fmt(avgRisk)}% • AI: ${fmt(avgAi)}%</div>
                        </li>
                    `;
                }).join("");
            }

            function renderStageTimeline(list) {
                const stages = IS.state.stages || [];
                const stageStats = stages.map((s) => {
                    const bucket = list.filter((i) => i.stage === s);
                    const count = bucket.length;
                    const avgProgress = count ? Math.round(bucket.reduce((sum, x) => sum + Number(x.progress || 0), 0) / count) : 0;
                    const avgRisk = count ? Math.round(bucket.reduce((sum, x) => sum + calcRiskProfile(x.riskProfile).residualPct, 0) / count) : 0;
                    const avgAge = count ? Math.round(bucket.reduce((sum, x) => sum + daysSince(x.updatedAt), 0) / count) : 0;
                    return { stage: s, count, avgProgress, avgRisk, avgAge };
                });

                let reached = stageStats.findLastIndex((x) => x.count > 0);
                if (reached < 0) reached = 0;
                const pct = stages.length ? Math.round(((reached + 1) / stages.length) * 100) : 0;
                $("#timelineProgress").style.width = `${pct}%`;

                $("#stageTimeline").innerHTML = stageStats.map((s, idx) => {
                    const active = idx <= reached && s.count > 0;
                    return `
                        <div class="stage-node ${active ? "active" : ""}">
                            <span class="dot"></span>
                            <span class="label">${esc(s.stage)}</span>
                            <div class="stage-tip">
                                <span>عدد المبادرات: ${fmt(s.count)}</span>
                                <span>التقدم: ${fmt(s.avgProgress)}%</span>
                                <span>المخاطر: ${fmt(s.avgRisk)}%</span>
                                <span>العمر الزمني: ${fmt(s.avgAge)} يوم</span>
                            </div>
                        </div>
                    `;
                }).join("");
            }

            function renderEventTimeline() {
                const events = (IS.state.commandEvents || []).slice(0, 6);
                if (!events.length) {
                    $("#eventTimeline").innerHTML = `<li><strong>لا توجد أحداث بعد</strong><small>سيظهر هنا خط زمني التحديثات.</small></li>`;
                    return;
                }
                $("#eventTimeline").innerHTML = events.map((e) => `
                    <li>
                        <strong>${esc(e.title || "حدث")}</strong>
                        <small>${esc((e.at || "").slice(0, 19).replace("T", " • "))} • ${esc(e.meta || "")}</small>
                    </li>
                `).join("");
            }

            function renderOrgComparison(list) {
                const grouped = new Map();
                list.forEach((i) => {
                    const key = i.org || "جهة غير محددة";
                    if (!grouped.has(key)) grouped.set(key, []);
                    grouped.get(key).push(i);
                });

                const rows = Array.from(grouped.entries())
                    .map(([org, bucket]) => {
                        const applied = bucket.filter(isApplied).length;
                        const avgAi = Math.round(bucket.reduce((sum, x) => sum + calcSuccessPrediction(x).score, 0) / bucket.length);
                        const avgRisk = Math.round(bucket.reduce((sum, x) => sum + calcRiskProfile(x.riskProfile).residualPct, 0) / bucket.length);
                        const netAnnual = bucket.reduce((sum, x) => sum + calcEconomicImpact(x.impact).netAnnual, 0);
                        const criticalCount = bucket.filter((x) => isCritical(x) || isStalled(x)).length;
                        const perfScore = Math.round((applied * 30) + (avgAi * 0.5) + ((100 - avgRisk) * 0.3) + Math.min(20, bucket.length * 2));
                        const seed = hashNum(org);
                        const riskSeries = buildSeries(avgRisk, seed + 13, 11);
                        const aiSeries = buildSeries(avgAi, seed + 27, 9);
                        const countSeries = buildSeries(Math.min(100, bucket.length * 14), seed + 37, 13);
                        return { org, count: bucket.length, applied, avgAi, avgRisk, netAnnual, criticalCount, perfScore, riskSeries, aiSeries, countSeries };
                    })
                    .sort((a, b) => b.count - a.count);

                orgStatsCache = rows;

                const topPerf = rows.length ? [...rows].sort((a, b) => b.perfScore - a.perfScore)[0].org : "";
                const highRisk = rows.length ? [...rows].sort((a, b) => b.avgRisk - a.avgRisk)[0].org : "";
                const aiLeader = rows.length ? [...rows].sort((a, b) => b.avgAi - a.avgAi)[0].org : "";

                $("#orgRows").innerHTML = rows.length
                    ? rows.map((r) => {
                        const rowClasses = [
                            r.org === topPerf ? "top-performer" : "",
                            r.org === highRisk ? "high-risk-row" : "",
                            r.org === aiLeader ? "ai-leader-row" : ""
                        ].join(" ").trim();
                        const badges = [];
                        if (r.org === topPerf) badges.push(`<span class="matrix-badge top">Top Performer</span>`);
                        if (r.org === highRisk) badges.push(`<span class="matrix-badge risk">High Risk</span>`);
                        if (r.org === aiLeader) badges.push(`<span class="matrix-badge ai">AI Leader</span>`);

                        return `
                            <tr class="${rowClasses}">
                                <td>
                                    <strong>${esc(r.org)}</strong>
                                    <div class="org-subtext">Critical: ${fmt(r.criticalCount)} • Net: ${fmt(r.netAnnual)} SAR</div>
                                </td>
                                <td>${fmt(r.count)}</td>
                                <td>${fmt(r.applied)}</td>
                                <td>${fmt(r.avgAi)}%</td>
                                <td>${fmt(r.avgRisk)}%</td>
                                <td>
                                    <div class="spark-stack">
                                        <div class="spark-row"><span>Risk</span>${sparklineSvg(r.riskSeries, "risk")}</div>
                                        <div class="spark-row"><span>AI</span>${sparklineSvg(r.aiSeries, "ai")}</div>
                                        <div class="spark-row"><span>Cnt</span>${sparklineSvg(r.countSeries, "count")}</div>
                                    </div>
                                </td>
                                <td><div class="matrix-badges">${badges.join("") || "—"}</div></td>
                            </tr>
                        `;
                    }).join("")
                    : `<tr><td colspan="7">لا توجد بيانات مقارنة.</td></tr>`;

                renderSmartCompare();
            }

            function renderSmartCompare() {
                const pool = $("#comparePool");
                pool.innerHTML = orgStatsCache.map((r) => `<button class="org-chip" draggable="true" data-org="${esc(r.org)}">${esc(r.org)}</button>`).join("");
                $$('[data-org]', pool).forEach((chip) => {
                    chip.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', chip.getAttribute('data-org') || '');
                    });
                });

                const a = orgStatsCache.find((x) => x.org === compareState.a) || null;
                const b = orgStatsCache.find((x) => x.org === compareState.b) || null;

                $("#compareSlotA").textContent = a ? a.org : "اسحب جهة هنا";
                $("#compareSlotB").textContent = b ? b.org : "اسحب جهة هنا";

                if (!a || !b) {
                    $("#compareBody").innerHTML = `<tr><td colspan="4">اختر جهتين للمقارنة.</td></tr>`;
                    return;
                }

                const metrics = [
                    { label: "عدد المبادرات", a: a.count, b: b.count, suffix: "" },
                    { label: "المعتمد/المطبق", a: a.applied, b: b.applied, suffix: "" },
                    { label: "متوسط AI", a: a.avgAi, b: b.avgAi, suffix: "%" },
                    { label: "متوسط المخاطر", a: a.avgRisk, b: b.avgRisk, suffix: "%", reverse: true },
                    { label: "الأثر الاقتصادي السنوي", a: a.netAnnual, b: b.netAnnual, suffix: " SAR" },
                    { label: "الحالات الحرجة", a: a.criticalCount, b: b.criticalCount, suffix: "", reverse: true }
                ];

                $("#compareBody").innerHTML = metrics.map((m) => {
                    const delta = m.a - m.b;
                    const betterA = m.reverse ? m.a < m.b : m.a > m.b;
                    const betterB = m.reverse ? m.b < m.a : m.b > m.a;
                    const aCell = betterA ? `<span class="status-badge is-good">${fmt(m.a)}${m.suffix}</span>` : `${fmt(m.a)}${m.suffix}`;
                    const bCell = betterB ? `<span class="status-badge is-good">${fmt(m.b)}${m.suffix}</span>` : `${fmt(m.b)}${m.suffix}`;
                    const deltaTxt = `${delta > 0 ? "+" : ""}${fmt(delta)}${m.suffix}`;
                    return `
                        <tr>
                            <td>${esc(m.label)}</td>
                            <td>${aCell}</td>
                            <td>${bCell}</td>
                            <td>${deltaTxt}</td>
                        </tr>
                    `;
                }).join("");
            }

            function renderAIIntel(list) {
                if (!list.length) {
                    $("#aiIntelList").innerHTML = `<li>لا توجد بيانات ضمن النطاق الحالي.</li>`;
                    return;
                }
                const sortedAi = [...list].sort((a, b) => calcSuccessPrediction(b).score - calcSuccessPrediction(a).score);
                const top = sortedAi[0];
                const low = sortedAi[sortedAi.length - 1];
                const avgAi = Math.round(list.reduce((sum, i) => sum + calcSuccessPrediction(i).score, 0) / list.length);
                const avgRisk = Math.round(list.reduce((sum, i) => sum + calcRiskProfile(i.riskProfile).residualPct, 0) / list.length);
                const recs = [];

                recs.push(`أعلى فرصة توسع: ${top.id} (${calcSuccessPrediction(top).score}%).`);
                recs.push(`أضعف جاهزية حاليًا: ${low.id} (${calcSuccessPrediction(low).score}%).`);
                if (avgRisk >= 55) recs.push("المخاطر مرتفعة نسبيًا؛ يلزم تفعيل خطط التخفيف قبل الاعتماد.");
                if (avgAi < 60) recs.push("متوسط AI منخفض؛ يلزم تحسين ملفات التحقق والجدوى.");
                if (!recs.length) recs.push("المؤشرات الذكية مستقرة حاليًا.");

                $("#aiIntelList").innerHTML = recs.map((r) => `<li>${esc(r)}</li>`).join("");
            }

            function renderSmartAlerts(list) {
                const alerts = [];
                const critical = list.filter(isCritical).length;
                const stalled = list.filter(isStalled).length;
                const highRiskApplied = list.filter((i) => isApplied(i) && calcRiskProfile(i.riskProfile).residualPct >= 70).length;
                const lowAi = list.filter((i) => calcSuccessPrediction(i).score < 55).length;
                const lowValidation = list.filter((i) => {
                    const v = i.validation || {};
                    const done = ["problem", "beneficiary", "evidence"].filter((k) => String(v[k] || "").trim()).length;
                    return done < 2;
                }).length;

                if (critical > 0) alerts.push(`يوجد ${fmt(critical)} مبادرة حرجة؛ يوصى بتفعيل Intensive Monitoring.`);
                if (stalled > 0) alerts.push(`يوجد ${fmt(stalled)} مبادرة متعثرة لأكثر من ${fmt(STALLED_DAYS)} يوم.`);
                if (highRiskApplied > 0) alerts.push(`عدد ${fmt(highRiskApplied)} من المبادرات المطبقة ما زالت بمخاطر مرتفعة.`);
                if (lowAi > 0) alerts.push(`${fmt(lowAi)} مبادرة بتوقع نجاح منخفض (<55%).`);
                if (lowValidation > 0) alerts.push(`${fmt(lowValidation)} مبادرة ببيانات تحقق ناقصة.`);
                if (!alerts.length) alerts.push("لا توجد تنبيهات حرجة في النطاق الحالي.");

                $("#smartAlerts").innerHTML = alerts.map((a) => `<li>${esc(a)}</li>`).join("");
            }

            function renderMonitorTable(list) {
                const ranked = [...list]
                    .map((i) => ({
                        i,
                        watch: watchScore(i),
                        risk: calcRiskProfile(i.riskProfile),
                        ai: calcSuccessPrediction(i)
                    }))
                    .sort((a, b) => b.watch - a.watch)
                    .slice(0, 10);

                $("#monitorBody").innerHTML = ranked.length
                    ? ranked.map((row) => {
                        const watchClass = row.watch >= 75 ? "is-bad" : (row.watch >= 50 ? "is-mid" : "is-good");
                        return `
                            <tr>
                                <td><strong>${esc(row.i.id)}</strong></td>
                                <td>${esc(row.i.title)}</td>
                                <td>${esc(row.i.org)}</td>
                                <td><span class="status-badge ${watchClass}">${fmt(row.watch)}%</span><small>${isStalled(row.i) ? "تعثر زمني" : "متابعة معيارية"}</small></td>
                                <td>${fmt(row.risk.residualPct)}%</td>
                                <td>${fmt(row.ai.score)}%</td>
                                <td>${fmt(row.i.progress)}%</td>
                                <td><button class="btn btn-soft" data-open-map="${esc(row.i.id)}">فتح</button></td>
                            </tr>
                        `;
                    }).join("")
                    : `<tr><td colspan="8">لا توجد مبادرات للمتابعة المكثفة.</td></tr>`;
            }

            function reasonForCritical(i) {
                const reasons = [];
                const risk = calcRiskProfile(i.riskProfile).residualPct;
                if (i.priority === "حرجة") reasons.push("أولوية حرجة");
                if (risk >= 70) reasons.push(`مخاطر ${risk}%`);
                if (isStalled(i)) reasons.push("تعثر زمني");
                if (i.status === "متعثر") reasons.push("حالة متعثرة");
                return reasons.length ? reasons.join(" • ") : "متابعة روتينية";
            }

            function renderCriticalList(list) {
                const rows = [...list]
                    .filter((i) => isCritical(i) || isStalled(i))
                    .sort((a, b) => watchScore(b) - watchScore(a))
                    .slice(0, 8);

                $("#criticalList").innerHTML = rows.length
                    ? rows.map((i) => {
                        const ai = calcSuccessPrediction(i);
                        return `
                            <li class="critical-card">
                                <div class="critical-head">
                                    <strong>${esc(i.id)} — ${esc(i.title)}</strong>
                                    <span class="status-badge ${i.priority === "حرجة" ? "is-bad" : "is-mid"}">${esc(i.priority)}</span>
                                </div>
                                <p>${esc(reasonForCritical(i))}</p>
                                <p>الجهة: ${esc(i.org)} • AI: ${fmt(ai.score)}% • تقدم: ${fmt(i.progress)}%</p>
                                <div class="critical-actions">
                                    <button class="btn btn-soft" data-open-map="${esc(i.id)}">الخريطة</button>
                                    <button class="btn btn-soft" data-open-judging="${esc(i.id)}">التحكيم</button>
                                    <button class="btn btn-soft" data-open-employee="${esc(i.id)}">الموظف</button>
                                </div>
                            </li>
                        `;
                    }).join("")
                    : `<li class="critical-card"><p>لا توجد مبادرات حرجة/متعثرة في النطاق الحالي.</p></li>`;
            }

            function renderHeatmap(list) {
                const priorityOrder = ["حرجة", "عالية", "متوسطة", "منخفضة"];
                const rows = priorityOrder.map((p) => {
                    const bucket = list.filter((i) => i.priority === p);
                    const count = bucket.length;
                    const risk = count ? Math.round(bucket.reduce((s, i) => s + calcRiskProfile(i.riskProfile).residualPct, 0) / count) : 0;
                    const ai = count ? Math.round(bucket.reduce((s, i) => s + calcSuccessPrediction(i).score, 0) / count) : 0;
                    const cls = risk >= 70 ? "heat-3" : (risk >= 40 ? "heat-2" : "heat-1");
                    return `
                        <div class="heat-cell ${cls}">
                            <strong>${esc(p)}</strong>
                            <small>Count: ${fmt(count)}</small>
                            <small>Risk: ${fmt(risk)}%</small>
                            <small>AI: ${fmt(ai)}%</small>
                        </div>
                    `;
                });
                $("#heatGrid").innerHTML = rows.join("");
            }

            function renderMainTable(list) {
                $("#pill").textContent = `${fmt(list.length)} نتائج`;
                $("#empty").style.display = list.length ? "none" : "grid";

                $("#tb").innerHTML = list.map((i) => {
                    const tag = i.tags[0] || "—";
                    const risk = calcRiskProfile(i.riskProfile);
                    const ai = calcSuccessPrediction(i);
                    const eco = calcEconomicImpact(i.impact);
                    const riskClass = risk.residualPct >= 70 ? "is-bad" : (risk.residualPct >= 40 ? "is-mid" : "is-good");
                    const aiClass = ai.score >= 75 ? "is-good" : (ai.score >= 55 ? "is-mid" : "is-bad");
                    const priorityClass = i.priority === "حرجة" ? "is-bad" : (i.priority === "عالية" ? "is-mid" : "is-good");
                    return `
                        <tr>
                            <td><strong>${esc(i.id)}</strong></td>
                            <td>${esc(i.title)}</td>
                            <td>${esc(i.org)}</td>
                            <td><span class="status-badge is-low">${esc(tag)}</span></td>
                            <td><span class="status-badge is-low">${esc(i.stage)}</span></td>
                            <td><span class="status-badge is-low">${esc(i.status)}</span></td>
                            <td><span class="status-badge ${priorityClass}">${esc(i.priority)}</span></td>
                            <td><span class="status-badge ${riskClass}">${fmt(risk.residualPct)}%</span></td>
                            <td><span class="status-badge ${aiClass}">${fmt(ai.score)}%</span></td>
                            <td>${fmt(eco.netAnnual)} SAR</td>
                            <td><button class="btn btn-soft" data-open-map="${esc(i.id)}">فتح بالخريطة</button></td>
                        </tr>
                    `;
                }).join("");
            }

            function renderAudit() {
                const items = (IS.state.audit || []).slice(0, 18);
                $("#audit").innerHTML = items.map((a) => `
                    <li class="timeline-item">
                        <h4>${esc(a.title || "حدث")}</h4>
                        <p>${esc(a.meta || "")}</p>
                        <div class="time">${esc((a.at || "").slice(0, 19).replace("T", " • "))}</div>
                    </li>
                `).join("");
            }

            function pushCommandEvent(title, meta = "") {
                IS.state.commandEvents = IS.state.commandEvents || [];
                IS.state.commandEvents.unshift({ at: nowISO(), title, meta });
                IS.state.commandEvents = IS.state.commandEvents.slice(0, 60);
            }

            function ensureBroadcastState() {
                const rows = Array.isArray(IS.state.broadcasts) ? IS.state.broadcasts : [];
                IS.state.broadcasts = rows
                    .filter((x) => x && typeof x === "object")
                    .map((x) => ({
                        id: x.id || `BC-${Math.floor(1000 + Math.random() * 9000)}`,
                        generatedAt: x.generatedAt || nowISO(),
                        mode: x.mode === "manual" ? "manual" : "auto",
                        scopeCount: Math.max(0, Number(x.scopeCount || 0)),
                        topIdeas: Array.isArray(x.topIdeas) ? x.topIdeas : [],
                        challenges: Array.isArray(x.challenges) ? x.challenges : [],
                        results: Array.isArray(x.results) ? x.results : []
                    }))
                    .sort((a, b) => new Date(b.generatedAt || 0).getTime() - new Date(a.generatedAt || 0).getTime())
                    .slice(0, 12);
            }

            function buildBroadcastSnapshot(list, { mode = "auto" } = {}) {
                const scope = Array.isArray(list) ? list : [];
                const topIdeas = [...scope]
                    .sort((a, b) => {
                        const aiDiff = calcSuccessPrediction(b).score - calcSuccessPrediction(a).score;
                        if (aiDiff !== 0) return aiDiff;
                        const econDiff = calcEconomicImpact(b.impact).netAnnual - calcEconomicImpact(a.impact).netAnnual;
                        if (econDiff !== 0) return econDiff;
                        return Number(b.progress || 0) - Number(a.progress || 0);
                    })
                    .slice(0, 3)
                    .map((i) => ({
                        id: i.id,
                        title: i.title,
                        ai: calcSuccessPrediction(i).score,
                        netAnnual: calcEconomicImpact(i.impact).netAnnual,
                        risk: calcRiskProfile(i.riskProfile).residualPct,
                        org: i.org
                    }));

                const challenges = [...scope]
                    .filter((i) => isCritical(i) || isStalled(i))
                    .sort((a, b) => watchScore(b) - watchScore(a))
                    .slice(0, 3)
                    .map((i) => ({
                        id: i.id,
                        title: i.title,
                        reason: reasonForCritical(i),
                        watch: watchScore(i),
                        org: i.org
                    }));

                const results = [...scope]
                    .filter((i) => isApplied(i) || calcPostMonitoring(i.postMonitoring, i.impact).m6Done)
                    .sort((a, b) => new Date(b.updatedAt || 0).getTime() - new Date(a.updatedAt || 0).getTime())
                    .slice(0, 3)
                    .map((i) => {
                        const post = calcPostMonitoring(i.postMonitoring, i.impact);
                        return {
                            id: i.id,
                            title: i.title,
                            status: i.status,
                            stage: i.stage,
                            netAnnual: calcEconomicImpact(i.impact).netAnnual,
                            m6Done: !!post.m6Done
                        };
                    });

                return {
                    id: `BC-${Math.floor(1000 + Math.random() * 9000)}`,
                    generatedAt: nowISO(),
                    mode: mode === "manual" ? "manual" : "auto",
                    scopeCount: scope.length,
                    topIdeas,
                    challenges,
                    results
                };
            }

            function formatBroadcastText(snapshot) {
                if (!snapshot) return "";
                const stamp = new Date(snapshot.generatedAt || nowISO()).toLocaleString("ar-SA");
                const lines = [
                    `Innovation Broadcast | ${stamp}`,
                    `النطاق: ${fmt(snapshot.scopeCount || 0)} مبادرة`,
                    "",
                    "أفضل الأفكار:"
                ];
                (snapshot.topIdeas || []).forEach((x, idx) => {
                    lines.push(`${idx + 1}. ${x.id} - ${x.title} | AI ${fmt(x.ai)}% | Net ${fmt(x.netAnnual)} SAR`);
                });
                lines.push("", "التحديات المفتوحة:");
                (snapshot.challenges || []).forEach((x, idx) => {
                    lines.push(`${idx + 1}. ${x.id} - ${x.title} | ${x.reason}`);
                });
                lines.push("", "النتائج:");
                (snapshot.results || []).forEach((x, idx) => {
                    lines.push(`${idx + 1}. ${x.id} - ${x.title} | ${x.status} • ${x.stage}`);
                });
                return lines.join("\n");
            }

            function storeBroadcast(snapshot, { logEvent = true } = {}) {
                if (!snapshot) return;
                ensureBroadcastState();
                IS.state.broadcasts.unshift(snapshot);
                IS.state.broadcasts = IS.state.broadcasts.slice(0, 12);
                if (logEvent) {
                    const modeLabel = snapshot.mode === "manual" ? "Manual" : "Auto Weekly";
                    pushCommandEvent("Innovation Broadcast", `${modeLabel} • ${fmt(snapshot.scopeCount)} مبادرة`);
                    IS.audit("توليد نشرة الابتكار", `${snapshot.id} • ${modeLabel}`);
                }
                IS.save();
            }

            function ensureWeeklyBroadcast(all) {
                ensureBroadcastState();
                const latest = IS.state.broadcasts[0];
                const latestAt = latest ? new Date(latest.generatedAt || 0).getTime() : 0;
                if (!latest || !Number.isFinite(latestAt) || (Date.now() - latestAt) >= WEEK_MS) {
                    const snapshot = buildBroadcastSnapshot(all, { mode: "auto" });
                    storeBroadcast(snapshot, { logEvent: true });
                    return snapshot;
                }
                return latest;
            }

            function renderBroadcast(all) {
                const latest = ensureWeeklyBroadcast(all);
                const topIdeas = latest?.topIdeas || [];
                const challenges = latest?.challenges || [];
                const results = latest?.results || [];
                const stamp = latest ? new Date(latest.generatedAt || nowISO()).toLocaleString("ar-SA") : nowLocal();

                $("#broadcastStamp").textContent = `آخر نشرة: ${stamp} • ${latest?.mode === "manual" ? "Manual" : "Auto Weekly"}`;
                $("#broadcastArchiveCount").textContent = `${fmt((IS.state.broadcasts || []).length)} نشرات`;

                $("#broadcastTopIdeas").innerHTML = topIdeas.length
                    ? topIdeas.map((x) => `
                        <li>
                            <strong>${esc(x.id)} — ${esc(x.title)}</strong>
                            <small>AI: ${fmt(x.ai)}% • Risk: ${fmt(x.risk)}% • Net: ${fmt(x.netAnnual)} SAR</small>
                        </li>
                    `).join("")
                    : `<li>لا توجد أفكار ضمن النطاق الحالي.</li>`;

                $("#broadcastChallenges").innerHTML = challenges.length
                    ? challenges.map((x) => `
                        <li>
                            <strong>${esc(x.id)} — ${esc(x.title)}</strong>
                            <small>${esc(x.reason)} • Watch ${fmt(x.watch)}% • ${esc(x.org)}</small>
                        </li>
                    `).join("")
                    : `<li>لا توجد تحديات مفتوحة حالياً.</li>`;

                $("#broadcastResults").innerHTML = results.length
                    ? results.map((x) => `
                        <li>
                            <strong>${esc(x.id)} — ${esc(x.title)}</strong>
                            <small>${esc(x.status)} • ${esc(x.stage)} • Net ${fmt(x.netAnnual)} SAR${x.m6Done ? " • متابعة 6 أشهر مكتملة" : ""}</small>
                        </li>
                    `).join("")
                    : `<li>لا توجد نتائج معتمدة/مطبقة بعد.</li>`;

                $("#broadcastArchive").innerHTML = (IS.state.broadcasts || []).slice(0, 3).length
                    ? (IS.state.broadcasts || []).slice(0, 3).map((x) => `
                        <li>
                            <strong>${esc(x.id)} • ${x.mode === "manual" ? "Manual" : "Auto Weekly"}</strong>
                            <small>${new Date(x.generatedAt || nowISO()).toLocaleString("ar-SA")} • نطاق ${fmt(x.scopeCount || 0)} مبادرة</small>
                        </li>
                    `).join("")
                    : `<li><strong>لا يوجد أرشيف بعد</strong><small>سيتم إنشاء أول نشرة تلقائيًا.</small></li>`;

                latestBroadcastText = formatBroadcastText(latest);
            }

            async function copyBroadcastToClipboard() {
                const text = latestBroadcastText || "";
                if (!text) return false;
                if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
                    await navigator.clipboard.writeText(text);
                    return true;
                }
                const ta = document.createElement("textarea");
                ta.value = text;
                ta.setAttribute("readonly", "true");
                ta.style.position = "fixed";
                ta.style.opacity = "0";
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                const ok = document.execCommand("copy");
                ta.remove();
                return ok;
            }

            function getAll() {
                const all = (IS.state.initiatives || []).map(normalizeInitiative);
                IS.state.initiatives = all;
                return all;
            }

            function openWithInitiative(path, id) {
                localStorage.setItem("is_selected_initiative", id);
                window.location.href = path;
            }

            function openNewInitiativeFromCommand() {
                localStorage.setItem("IS_OPEN_NEW_FROM_NAV", "1");
                window.location.href = "../map/index.html";
            }

            function openJudgingFromCommand() {
                const all = getAll();
                let list = getFiltered(all);
                if (commandMode) list = list.filter((i) => isCritical(i) || isStalled(i));
                const first = list[0] || all[0];
                if (first?.id) localStorage.setItem("is_selected_initiative", first.id);
                window.location.href = "../judging/index.html";
            }

            function drillRows(type, list) {
                if (type === "total") return list.map((i) => ({ i, reason: "ضمن نطاق الفلاتر" }));
                if (type === "judging") return list.filter((i) => i.status === "قيد التحكيم").map((i) => ({ i, reason: "بانتظار قرار التحكيم" }));
                if (type === "proto") return list.filter((i) => i.stage === "النموذج الأولي" || !!i.prototype).map((i) => ({ i, reason: "مرحلة النموذج الأولي" }));
                if (type === "applied") return list.filter(isApplied).map((i) => ({ i, reason: "معتمد/مطبق" }));
                if (type === "riskHigh") return list.filter((i) => calcRiskProfile(i.riskProfile).residualPct >= 70).map((i) => ({ i, reason: `Residual Risk ${calcRiskProfile(i.riskProfile).residualPct}%` }));
                if (type === "aiHigh") return list.filter((i) => calcSuccessPrediction(i).score >= 75).map((i) => ({ i, reason: `AI ${calcSuccessPrediction(i).score}%` }));
                if (type === "critical") return list.filter((i) => isCritical(i) || isStalled(i)).map((i) => ({ i, reason: reasonForCritical(i) }));
                if (type === "stalled") return list.filter(isStalled).map((i) => ({ i, reason: `آخر تحديث منذ ${fmt(daysSince(i.updatedAt))} يوم` }));
                if (type === "post6m") return list.filter((i) => isApplied(i) && calcPostMonitoring(i.postMonitoring, i.impact).m6Done).map((i) => ({ i, reason: "متابعة 6 أشهر مكتملة" }));
                if (type === "economic") return [...list]
                    .sort((a, b) => calcEconomicImpact(b.impact).netAnnual - calcEconomicImpact(a.impact).netAnnual)
                    .slice(0, 20)
                    .map((i) => ({ i, reason: `Net Annual ${fmt(calcEconomicImpact(i.impact).netAnnual)} SAR` }));
                return [];
            }

            function drillTitle(type) {
                const map = {
                    total: "تفاصيل إجمالي المبادرات",
                    judging: "تفاصيل المبادرات قيد التحكيم",
                    proto: "تفاصيل Prototype Active",
                    applied: "تفاصيل المبادرات المعتمدة/المطبقة",
                    riskHigh: "تفاصيل المخاطر الحرجة",
                    economic: "أعلى أثر اقتصادي سنوي",
                    aiHigh: "مبادرات ذات توقع نجاح مرتفع",
                    critical: "المبادرات الحرجة",
                    stalled: "المبادرات المتعثرة",
                    post6m: "المبادرات المكتملة متابعة 6 أشهر"
                };
                return map[type] || "تفاصيل المؤشر";
            }

            function openDrill(type, list) {
                const rows = drillRows(type, list);
                $("#drillTitle").textContent = drillTitle(type);
                $("#drillBody").innerHTML = rows.map((row) => `
                    <tr>
                        <td><strong>${esc(row.i.id)}</strong></td>
                        <td>${esc(row.i.title)}</td>
                        <td>${esc(row.i.stage)}</td>
                        <td>${esc(row.i.status)}</td>
                        <td>${esc(row.reason)}</td>
                        <td><button class="btn btn-soft" data-open-map="${esc(row.i.id)}">فتح</button></td>
                    </tr>
                `).join("");
                $("#drillEmpty").style.display = rows.length ? "none" : "grid";
                $("#modalDrill").classList.remove("hidden");
            }

            function closeDrill() {
                $("#modalDrill").classList.add("hidden");
            }

            async function syncInitiativesFromApi({ silent = true } = {}) {
                try {
                    const payload = await apiRequest("/api/v2/initiatives", { method: "GET", timeoutMs: 3600 });
                    const rows = Array.isArray(payload?.items) ? payload.items : (Array.isArray(payload) ? payload : []);

                    const remote = rows.map((item) => normalizeInitiative({
                        id: item.id || item.initiativeId,
                        title: item.titleAr || item.title,
                        stage: item.stage || item.currentStage,
                        status: item.status,
                        tags: item.tags || item.taxonomy,
                        org: item.org || item.organization || item.entity,
                        priority: item.priority,
                        progress: item.progress ?? item.prototype?.progress,
                        score: item.score ?? item.rubricScore,
                        rubric: item.rubric,
                        validation: item.validation,
                        impact: item.impact,
                        riskProfile: item.riskProfile,
                        postMonitoring: item.postMonitoring,
                        prototype: item.prototype,
                        createdAt: item.createdAt,
                        updatedAt: item.updatedAt
                    })).filter((x) => x.id);

                    if (remote.length) {
                        const merged = new Map((IS.state.initiatives || []).map((i) => [i.id, normalizeInitiative(i)]));
                        remote.forEach((r) => {
                            const prev = merged.get(r.id) || {};
                            merged.set(r.id, normalizeInitiative({ ...prev, ...r }));
                        });
                        IS.state.initiatives = Array.from(merged.values());
                        IS.audit("مزامنة لوحة القيادة من API", `${fmt(remote.length)} سجل`);
                        pushCommandEvent("Live Sync", `${fmt(remote.length)} سجل من API`);
                        IS.save();
                    }

                    if (!silent) IS.toast("تمت مزامنة لوحة القيادة ✅", "ok", 1800);
                    return { ok: true, count: remote.length };
                } catch (err) {
                    if (!silent) IS.toast("تعذر الاتصال بالـ API، تم الاعتماد على البيانات المحلية.", "warn", 2300);
                    return { ok: false, error: String(err?.message || err) };
                }
            }

            function setLiveMode(next) {
                liveMode = !!next;
                const badge = $("#liveState");
                badge.textContent = `LIVE: ${liveMode ? "ON" : "OFF"}`;
                badge.classList.toggle("is-on", liveMode);
                $("#btnLiveToggle").textContent = liveMode ? "إيقاف Live" : "تشغيل Live";

                if (liveTimer) {
                    clearInterval(liveTimer);
                    liveTimer = null;
                }

                if (liveMode) {
                    pushCommandEvent("تفعيل Live Mode", "تحديث كل 20 ثانية");
                    liveTimer = setInterval(async () => {
                        await syncInitiativesFromApi({ silent: true });
                        renderAll();
                    }, 20000);
                } else {
                    pushCommandEvent("إيقاف Live Mode", "تم إيقاف التحديث اللحظي");
                }
                IS.save();
            }

            function setCommandMode(next) {
                commandMode = !!next;
                document.body.classList.toggle("command-mode", commandMode);
                $("#btnCommandMode").textContent = `Command Mode: ${commandMode ? "ON" : "OFF"}`;
                $("#modeState").textContent = commandMode ? "Command Mode" : "Standard Mode";
                pushCommandEvent(commandMode ? "تفعيل وضع القيادة" : "إيقاف وضع القيادة", commandMode ? "عرض الحالات الحرجة فقط" : "عرض جميع الحالات");
                IS.save();
                renderAll();
            }

            function setCinematicMode(next) {
                cinematicMode = !!next;
                document.body.classList.toggle("cinematic-mode", cinematicMode);
                $("#btnCinematicMode").textContent = `Cinematic: ${cinematicMode ? "ON" : "OFF"}`;
                pushCommandEvent(cinematicMode ? "تفعيل Cinematic Mode" : "إيقاف Cinematic Mode", "عرض تقديمي");
                IS.save();
            }

            function setSmartCompareMode(next) {
                smartCompareMode = !!next;
                $("#btnSmartCompare").textContent = `Smart Compare: ${smartCompareMode ? "ON" : "OFF"}`;
                const panel = $("#smartComparePanel");
                panel.classList.toggle("focus-mode", smartCompareMode);
                if (smartCompareMode) {
                    panel.scrollIntoView({ behavior: "smooth", block: "center" });
                }
                pushCommandEvent(smartCompareMode ? "تفعيل Smart Compare" : "إيقاف Smart Compare", "مقارنة الجهات بصريًا");
                IS.save();
            }

            function wireCompareDropZones() {
                ["a", "b"].forEach((slot) => {
                    const zone = document.getElementById(slot === "a" ? "compareDropA" : "compareDropB");
                    if (!zone) return;
                    zone.addEventListener("dragover", (e) => {
                        e.preventDefault();
                        zone.classList.add("drag-over");
                    });
                    zone.addEventListener("dragleave", () => zone.classList.remove("drag-over"));
                    zone.addEventListener("drop", (e) => {
                        e.preventDefault();
                        zone.classList.remove("drag-over");
                        const org = e.dataTransfer.getData("text/plain");
                        if (!org) return;
                        compareState[slot] = org;
                        renderSmartCompare();
                    });
                    zone.addEventListener("click", () => {
                        compareState[slot] = "";
                        renderSmartCompare();
                    });
                });
            }

            function wireRipple() {
                document.addEventListener("click", (e) => {
                    const host = e.target.closest(".btn, .stat-card, .panel, .heat-cell");
                    if (!host) return;
                    host.classList.add("ripple-host");
                    const rect = host.getBoundingClientRect();
                    const ripple = document.createElement("span");
                    ripple.className = "ripple";
                    const size = Math.max(rect.width, rect.height);
                    ripple.style.width = `${size}px`;
                    ripple.style.height = `${size}px`;
                    ripple.style.left = `${e.clientX - rect.left - size / 2}px`;
                    ripple.style.top = `${e.clientY - rect.top - size / 2}px`;
                    host.appendChild(ripple);
                    ripple.addEventListener("animationend", () => ripple.remove());
                }, { passive: true });
            }

            function renderAll() {
                const all = getAll();
                fillSelectors(all);
                let list = getFiltered(all);
                if (commandMode) {
                    list = list.filter((i) => isCritical(i) || isStalled(i));
                }

                renderHeaderStrip(list, all);
                renderSummary(list, all);
                renderBroadcast(all);
                renderKPIs(list);
                renderStageBars(list);
                renderStageTimeline(list);
                renderEventTimeline();
                renderOrgComparison(list);
                renderAIIntel(list);
                renderSmartAlerts(list);
                renderMonitorTable(list);
                renderCriticalList(list);
                renderHeatmap(list);
                renderMainTable(list);
                renderAudit();

                $("#pill").textContent = `${fmt(list.length)} نتائج`;

                $$('[data-open-map]').forEach((b) => {
                    b.addEventListener('click', () => openWithInitiative('../map/index.html', b.getAttribute('data-open-map')));
                });
                $$('[data-open-judging]').forEach((b) => {
                    b.addEventListener('click', () => openWithInitiative('../judging/index.html', b.getAttribute('data-open-judging')));
                });
                $$('[data-open-employee]').forEach((b) => {
                    b.addEventListener('click', () => openWithInitiative('../employee/index.html', b.getAttribute('data-open-employee')));
                });
            }

            async function init() {
                document.body.classList.add("loading-skeleton");

                IS.state.commandEvents = IS.state.commandEvents || [];
                ensureBroadcastState();
                getAll();
                IS.audit("فتح لوحة القيادة التنفيذية", "command");
                pushCommandEvent("فتح الصفحة", "لوحة القيادة التنفيذية");
                IS.save();

                wireCompareDropZones();
                wireRipple();

                await syncInitiativesFromApi({ silent: true });
                renderAll();

                setTimeout(() => {
                    document.body.classList.remove("loading-skeleton");
                }, 480);

                ["q", "qSemantic", "stage", "status", "tag", "priorityFilter", "riskFilter", "orgFilter", "dateFrom", "dateTo"]
                    .forEach((id) => {
                        const el = document.getElementById(id);
                        if (!el) return;
                        const evt = (id === "q" || id === "qSemantic") ? "input" : "change";
                        el.addEventListener(evt, renderAll);
                    });

                const resetAllFilters = () => {
                    ["q", "qSemantic", "stage", "status", "tag", "priorityFilter", "riskFilter", "orgFilter", "dateFrom", "dateTo"].forEach((id) => {
                        const el = document.getElementById(id);
                        if (el) el.value = "";
                    });
                    pushCommandEvent("إعادة تعيين الفلاتر", "Filters 2.0");
                    IS.save();
                    renderAll();
                };

                $("#btnReset").addEventListener("click", resetAllFilters);
                $("#btnEmptyReset").addEventListener("click", resetAllFilters);
                $("#btnDrillResetFilters").addEventListener("click", () => {
                    closeDrill();
                    resetAllFilters();
                });

                $("#btnUnifiedStart").addEventListener("click", openNewInitiativeFromCommand);
                $("#btnEmptyStart").addEventListener("click", openNewInitiativeFromCommand);
                $("#btnEmptyJudging").addEventListener("click", openJudgingFromCommand);

                $("#btnRefresh").addEventListener("click", async () => {
                    document.body.classList.add("loading-skeleton");
                    const res = await syncInitiativesFromApi({ silent: false });
                    pushCommandEvent("تحديث يدوي", res.ok ? `تمت مزامنة ${fmt(res.count || 0)} سجل` : "تعذر الاتصال");
                    IS.save();
                    renderAll();
                    setTimeout(() => document.body.classList.remove("loading-skeleton"), 360);
                });

                $("#btnPrint").addEventListener("click", () => {
                    IS.audit("طباعة لوحة القيادة", "command");
                    pushCommandEvent("طباعة", "تم طلب طباعة الصفحة");
                    IS.save();
                    window.print();
                });

                $("#btnExecReport").addEventListener("click", () => {
                    const all = getAll();
                    const list = commandMode
                        ? getFiltered(all).filter((i) => isCritical(i) || isStalled(i))
                        : getFiltered(all);
                    localStorage.setItem("is_exec_report_scope", JSON.stringify({
                        generatedAt: nowISO(),
                        ids: list.map((x) => x.id),
                        filters: readFilters(),
                        mode: commandMode ? "command" : "normal"
                    }));
                    IS.audit("فتح التقرير التنفيذي", `scope=${fmt(list.length)}`);
                    pushCommandEvent("فتح التقرير التنفيذي", `${fmt(list.length)} مبادرة`);
                    IS.save();
                    window.open("../report/index.html", "_blank");
                });

                $("#btnGenerateBroadcast").addEventListener("click", () => {
                    const all = getAll();
                    const snapshot = buildBroadcastSnapshot(all, { mode: "manual" });
                    storeBroadcast(snapshot, { logEvent: true });
                    renderAll();
                    IS.toast("تم توليد Innovation Broadcast ✅", "ok", 1700);
                });

                $("#btnCopyBroadcast").addEventListener("click", async () => {
                    try {
                        const ok = await copyBroadcastToClipboard();
                        if (ok) IS.toast("تم نسخ ملخص النشرة ✅", "ok", 1500);
                        else IS.toast("تعذر النسخ تلقائيًا.", "warn", 1700);
                    } catch {
                        IS.toast("تعذر النسخ تلقائيًا.", "warn", 1700);
                    }
                });

                $("#btnLiveToggle").addEventListener("click", () => {
                    setLiveMode(!liveMode);
                    renderAll();
                });

                $("#btnCommandMode").addEventListener("click", () => {
                    setCommandMode(!commandMode);
                });

                $("#btnCinematicMode").addEventListener("click", () => {
                    setCinematicMode(!cinematicMode);
                });

                $("#btnSmartCompare").addEventListener("click", () => {
                    setSmartCompareMode(!smartCompareMode);
                });

                $("#btnApiSettings").addEventListener("click", openApiModal);
                $("#btnApiSave").addEventListener("click", async () => {
                    const base = setApiBase($("#apiBaseInput").value);
                    $("#apiStateHint").textContent = `تم حفظ العنوان: ${base || "(فارغ)"}`;
                    const res = await syncInitiativesFromApi({ silent: true });
                    if (res.ok) {
                        IS.toast("تم حفظ الإعدادات والاتصال ناجح ✅", "ok", 1900);
                        closeApiModal();
                        renderAll();
                    } else {
                        IS.toast("تم حفظ الإعدادات، لكن الاتصال غير متاح حاليًا.", "warn", 2200);
                    }
                });

                $("#btnApiTest").addEventListener("click", async () => {
                    const current = setApiBase($("#apiBaseInput").value);
                    $("#apiStateHint").textContent = "جارٍ اختبار الاتصال...";
                    const res = await syncInitiativesFromApi({ silent: true });
                    if (res.ok) {
                        $("#apiStateHint").textContent = `نجاح الاتصال (${current}) • السجلات: ${fmt(res.count || 0)}`;
                        IS.toast("الاتصال ناجح ✅", "ok", 1500);
                        renderAll();
                    } else {
                        $("#apiStateHint").textContent = "فشل الاتصال، سيتم استخدام البيانات المحلية.";
                        IS.toast("الاتصال غير متاح", "warn", 1700);
                    }
                });

                $$('[data-close-api]').forEach((el) => el.addEventListener('click', closeApiModal));
                $$('[data-close-drill]').forEach((el) => el.addEventListener('click', closeDrill));

                $$('[data-drill]').forEach((el) => {
                    el.addEventListener('click', () => {
                        const all = getAll();
                        let list = getFiltered(all);
                        if (commandMode) list = list.filter((i) => isCritical(i) || isStalled(i));
                        openDrill(el.getAttribute('data-drill'), list);
                    });
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeApiModal();
                        closeDrill();
                    }
                });
            }

            document.addEventListener("DOMContentLoaded", init);
        })();
    </script>
</body>

</html>
