<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <title>درع الابتكار | مسار التحكيم</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/app.css" />
  <style>
    .judging-kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .judging-kpi-card {
      border: 1px solid rgba(255, 255, 255, .14);
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .02));
      min-height: 74px;
      padding: 8px;
      display: grid;
      align-content: center;
      gap: 4px;
    }

    .judging-kpi-card span {
      font-size: 11px;
      color: var(--muted2);
      font-weight: 700;
    }

    .judging-kpi-card strong {
      font-size: 14px;
      font-weight: 900;
    }

    .table-tools-advanced {
      display: grid;
      grid-template-columns: 1.3fr repeat(6, minmax(120px, 1fr));
      gap: 8px;
    }

    .table-tools-advanced .btn {
      min-height: 40px;
    }

    .quick-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .smart-search-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 8px;
      margin-bottom: 8px;
    }

    .row-indicators {
      display: grid;
      gap: 3px;
    }

    .row-indicators small {
      color: var(--muted2);
      font-size: 10px;
    }

    .trail-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 8px;
      max-height: 260px;
      overflow: auto;
    }

    .trail-list li {
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 12px;
      padding: 8px;
      background: rgba(255, 255, 255, .03);
    }

    .trail-list .trail-time {
      display: block;
      color: var(--muted2);
      font-size: 11px;
      margin-top: 4px;
    }

    .compare-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .audit-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .audit-metric {
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 12px;
      background: rgba(255, 255, 255, .04);
      min-height: 72px;
      padding: 8px;
      display: grid;
      align-content: center;
      gap: 4px;
    }

    .audit-metric p {
      margin: 0;
      color: var(--muted2);
      font-size: 11px;
    }

    .audit-metric strong {
      font-size: 16px;
      font-weight: 900;
    }

    .fast-judging-box {
      border: 1px solid rgba(78, 163, 255, .35);
      border-radius: 14px;
      background: linear-gradient(130deg, rgba(78, 163, 255, .18), rgba(66, 246, 231, .08));
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    .fast-judging-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .judging-score-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .judging-score-item {
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 12px;
      background: rgba(255, 255, 255, .04);
      padding: 8px;
      display: grid;
      gap: 3px;
    }

    .judging-score-item p {
      margin: 0;
      color: var(--muted2);
      font-size: 11px;
    }

    .judging-score-item strong {
      font-size: 15px;
      font-weight: 900;
    }

    .proto-table tbody tr {
      transition: background .22s ease, transform .22s ease;
    }

    .proto-table tbody tr:hover {
      background: rgba(78, 163, 255, .10);
      transform: translateY(-1px);
    }

    body.judging-fast-mode .advanced-judging-panel {
      display: none;
    }

    @media (max-width: 1100px) {
      .judging-kpi-grid,
      .audit-grid,
      .judging-score-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .table-tools-advanced,
      .compare-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body class="career-body">

  <div class="platform-bg">
    <div class="mesh mesh-1"></div>
    <div class="mesh mesh-2"></div>
    <div class="mesh mesh-3"></div>
  </div>

  <div class="platform-shell">

    <!-- TOPBAR -->
    <header class="platform-topbar reveal">
      <div class="topbar-brand">
        <div class="brand-mark">IS</div>
        <div>
          <h1 class="topbar-title">مسار التحكيم</h1>
          <p class="topbar-sub">AI Assistive Review + Human Fair Judging + Audit Trail</p>
        </div>
      </div>

      <nav class="nav">
        <a href="../../index.html">الرئيسية</a>
        <a href="../map/index.html">خريطة الابتكار</a>
        <a href="../prototype/index.html">النماذج الأولية</a>
        <a href="../employee/index.html">مسار الموظف</a>
        <a href="../judging/index.html" class="active">التحكيم</a>
        <a href="../command/index.html">لوحة القيادة</a>
        <a href="../policies/index.html">السياسات</a>
        <a href="../report/index.html">التقرير التنفيذي</a>
      </nav>

      <div class="topbar-actions">
        <span class="live-pill">⚖️ لجنة تقييم</span>
        <button class="btn btn-soft" id="btnFastMode">تحكيم سريع: OFF</button>
        <button class="btn btn-soft" id="btnSeed">عينات</button>
        <button class="btn btn-ghost" id="btnApiSettings">API</button>
        <button class="btn btn-primary" id="btnPrint">طباعة محضر</button>
      </div>
    </header>

    <section class="panel reveal">
      <div class="panel-head">
        <h3>فلسفة التحكيم في درع الابتكار</h3>
        <span class="panel-note">ذكاء اصطناعي مساعد + قرار بشري منصف</span>
      </div>
      <ul class="insight-list" style="margin:0;">
        <li>الذكاء الاصطناعي يساعد المحكم بتوقع النجاح، تحليل المخاطر، وتلخيص نقاط القوة والضعف.</li>
        <li>القرار النهائي دائمًا بشري وفق Rubric موحّد ومعايير شفافة.</li>
        <li>التحكيم يغطي الابتكار الحر وحلول التحديات الواقعية داخل التجمع بنفس العدالة.</li>
        <li>كل خطوة موثقة في سجل التدقيق لضمان النزاهة وجودة المخرجات.</li>
      </ul>
    </section>

    <!-- MAIN GRID -->
    <section class="insights-grid reveal">

      <!-- LEFT: list -->
      <section class="panel">
        <div class="panel-head">
          <h3>قائمة المبادرات</h3>
          <span class="panel-note" id="count">—</span>
        </div>

        <div class="smart-search-row">
          <input id="qAi" placeholder="بحث ذكي (عنوان، وسوم، جهة مشاركة، حالة)..." />
          <button class="btn btn-soft" id="btnSmartSearch">بحث ذكي</button>
          <button class="btn btn-ghost" id="btnVoiceSearch">بحث صوتي</button>
        </div>

        <div class="table-tools table-tools-advanced">
          <input id="q" placeholder="بحث بالعنوان أو المعرف…" />
          <select id="phase">
            <option value="">كل المراحل التحكيمية</option>
            <option>فرز أولي</option>
            <option>تحكيم</option>
            <option>تدقيق</option>
            <option>اعتماد</option>
          </select>
          <select id="innovationType">
            <option value="">نوع الابتكار</option>
          </select>
          <select id="evalState">
            <option value="">حالة التقييم</option>
            <option>بانتظار المحكم</option>
            <option>بانتظار اللجنة</option>
            <option>مكتمل</option>
            <option>يحتاج تعديل</option>
          </select>
          <select id="priority">
            <option value="">الأولوية</option>
            <option>حرجة</option>
            <option>عالية</option>
            <option>متوسطة</option>
            <option>منخفضة</option>
          </select>
          <select id="orgFilter">
            <option value="">الجهة المشاركة</option>
          </select>
          <span class="table-count" id="pill">—</span>
        </div>

        <div class="table-wrap" style="margin-top:10px;">
          <table class="proto-table">
            <thead>
              <tr>
                <th>المعرف</th>
                <th>العنوان</th>
                <th>المرحلة</th>
                <th>الأولوية</th>
                <th>الحالة</th>
                <th>مؤشرات فورية</th>
                <th>النتيجة</th>
                <th>إجراء</th>
              </tr>
            </thead>
            <tbody id="tb"></tbody>
          </table>
        </div>

        <div class="empty-line" id="empty" style="display:none; margin-top:10px;">
          لا توجد نتائج.
        </div>

        <div class="panel" style="margin-top:10px;">
          <div class="panel-head">
            <h3>مقارنة المبادرات</h3>
            <span class="panel-note">اختيار 2–3 مبادرات</span>
          </div>
          <div class="compare-grid">
            <select id="cmpA"></select>
            <select id="cmpB"></select>
            <select id="cmpC"></select>
          </div>
          <div class="quick-actions">
            <button class="btn btn-soft" id="btnCompare">مقارنة تلقائية</button>
            <button class="btn btn-ghost" id="btnClearCompare">تفريغ المقارنة</button>
          </div>
          <div class="table-wrap" style="margin-top:10px;">
            <table class="proto-table">
              <thead>
                <tr>
                  <th>المعيار</th>
                  <th>المبادرة A</th>
                  <th>المبادرة B</th>
                  <th>المبادرة C</th>
                </tr>
              </thead>
              <tbody id="compareBody"></tbody>
            </table>
          </div>
          <p class="generated" id="compareReco">—</p>
        </div>
      </section>

      <!-- RIGHT: rubric + decision -->
      <section class="panel">
        <div class="panel-head">
          <h3>Rubric التحكيم</h3>
          <span class="panel-note" id="sel">اختر مبادرة</span>
        </div>

        <div class="readiness-box">
          <div class="readiness-meta">
            <span>النتيجة الإجمالية</span>
            <strong id="score">—</strong>
          </div>
          <div class="progress-track"><span id="bar"></span></div>
          <p class="points-line" id="hint">املأ المعايير ثم احفظ القرار.</p>

          <div class="judging-kpi-grid" id="judgeKpiCards">
            <article class="judging-kpi-card"><span>النضج</span><strong>—</strong></article>
            <article class="judging-kpi-card"><span>الجاهزية</span><strong>—</strong></article>
            <article class="judging-kpi-card"><span>الأثر المتوقع</span><strong>—</strong></article>
            <article class="judging-kpi-card"><span>قابلية التوسع</span><strong>—</strong></article>
            <article class="judging-kpi-card"><span>المخاطر</span><strong>—</strong></article>
          </div>
        </div>

        <div class="fast-judging-box" style="margin-top:10px;">
          <div class="fast-judging-head">
            <strong>Fast Judging Mode</strong>
            <span class="status-badge is-low" id="fastModeState">غير مفعل</span>
          </div>
          <div id="fastSummary" class="generated">اختر مبادرة لعرض ملخص التحكيم السريع.</div>
          <div class="quick-actions">
            <button class="btn btn-primary" id="btnFastApprove">اعتماد سريع</button>
            <button class="btn btn-ghost" id="btnFastRecommend">توصية آلية</button>
          </div>
        </div>

        <div class="panel advanced-judging-panel" style="margin-top:10px;">
          <div class="panel-head">
            <h3>نظام النقاط التفاعلي</h3>
            <span class="panel-note">Auto + Judge + AI + Variance</span>
          </div>
          <div class="mgrid">
            <div class="field">
              <div class="lbl">نقاط المحكم اليدوية (0-30)</div>
              <input id="judgeManualPts" type="number" min="0" max="30" step="1" value="0">
            </div>
            <div class="field">
              <div class="lbl">وزن الذكاء الاصطناعي (%)</div>
              <input id="judgeAiWeight" type="number" min="0" max="100" step="1" value="30">
            </div>
            <div class="field">
              <div class="lbl">اسم المحكم</div>
              <input id="judgeName" value="محكم 1">
            </div>
            <div class="field">
              <div class="lbl">Variance Detection</div>
              <input id="judgeVarianceThreshold" type="number" min="5" max="40" step="1" value="15">
            </div>
          </div>

          <div class="judging-score-grid" style="margin-top:10px;">
            <article class="judging-score-item"><p>نقاط تلقائية</p><strong id="ptsAuto">—</strong></article>
            <article class="judging-score-item"><p>نقاط المحكم</p><strong id="ptsJudge">—</strong></article>
            <article class="judging-score-item"><p>نقاط AI</p><strong id="ptsAi">—</strong></article>
            <article class="judging-score-item"><p>النقاط النهائية</p><strong id="ptsTotal">—</strong></article>
          </div>
          <p class="generated" id="varianceState">—</p>
        </div>

        <div class="panel" style="margin-top:10px;">
          <div class="panel-head">
            <h3>Validation Layer</h3>
            <span class="panel-note" id="vState">غير مكتمل</span>
          </div>
          <div class="mgrid">
            <div class="field">
              <div class="lbl">المشكلة المؤكدة</div>
              <input id="vProblem" placeholder="حدد المشكلة الفعلية">
            </div>
            <div class="field">
              <div class="lbl">الفئة المستفيدة</div>
              <input id="vBeneficiary" placeholder="من المستفيد؟">
            </div>
            <div class="field" style="grid-column:1/-1;">
              <div class="lbl">الدليل/الاختبار</div>
              <textarea id="vEvidence" rows="3"
                style="width:100%; border-radius:12px; border:1px solid rgba(53,82,110,.22); padding:10px; font-family:inherit;"></textarea>
            </div>
          </div>
          <p class="generated" style="margin-top:8px;">
            لا يمكن اعتماد المبادرة قبل اكتمال بيانات التحقق من صحة الاحتياج.
          </p>
        </div>

        <div class="panel" style="margin-top:10px;">
          <div class="panel-head">
            <h3>معايير التقييم</h3>
            <span class="panel-note">0–5</span>
          </div>

          <div class="mgrid">
            <div class="field">
              <div class="lbl">وضوح المشكلة</div>
              <input class="inScore" data-k="problem" type="number" min="0" max="5" step="1" value="0">
            </div>
            <div class="field">
              <div class="lbl">قابلية التطبيق</div>
              <input class="inScore" data-k="feasible" type="number" min="0" max="5" step="1" value="0">
            </div>
            <div class="field">
              <div class="lbl">الأثر المتوقع</div>
              <input class="inScore" data-k="impact" type="number" min="0" max="5" step="1" value="0">
            </div>
            <div class="field">
              <div class="lbl">جودة النموذج الأولي</div>
              <input class="inScore" data-k="prototype" type="number" min="0" max="5" step="1" value="0">
            </div>
            <div class="field">
              <div class="lbl">المخاطر (عكسياً)</div>
              <input class="inScore" data-k="risk" type="number" min="0" max="5" step="1" value="0">
            </div>
          </div>

          <p class="generated" style="margin-top:8px;">
            * المخاطر (عكسياً): 0 = مخاطر عالية، 5 = مخاطر منخفضة.
          </p>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn btn-primary" id="btnSave">حفظ النتيجة</button>
            <button class="btn btn-soft" id="btnApprove">اعتماد</button>
            <button class="btn btn-ghost" id="btnReject">رفض</button>
            <button class="btn btn-ghost" id="btnPrize">توزيع جوائز</button>
          </div>
        </div>

        <div class="panel" style="margin-top:10px;">
          <div class="panel-head">
            <h3>Economic Impact Engine</h3>
            <span class="panel-note">ROI • Net Benefit • Payback</span>
          </div>

          <div class="mgrid">
            <div class="field">
              <div class="lbl">التوفير السنوي المتوقع (SAR)</div>
              <input id="eSaving" type="number" min="0" step="1000" value="0">
            </div>
            <div class="field">
              <div class="lbl">تكلفة التنفيذ (مرة واحدة)</div>
              <input id="eImplCost" type="number" min="0" step="1000" value="0">
            </div>
            <div class="field">
              <div class="lbl">تكلفة التشغيل السنوية</div>
              <input id="eOpex" type="number" min="0" step="1000" value="0">
            </div>
            <div class="field">
              <div class="lbl">أفق التحليل (سنوات)</div>
              <input id="eHorizon" type="number" min="1" max="5" step="1" value="3">
            </div>
            <div class="field">
              <div class="lbl">درجة الثقة (%)</div>
              <input id="eConfidence" type="number" min="10" max="100" step="1" value="75">
            </div>
            <div class="field">
              <div class="lbl">الأثر على الوقت (%)</div>
              <input id="eTimeSaving" type="number" min="0" max="100" step="1" value="0">
            </div>
          </div>

          <ul class="insight-list" style="margin-top:10px;">
            <li><strong>صافي الأثر السنوي:</strong> <span id="eNetAnnual">—</span></li>
            <li><strong>ROI على الأفق المحدد:</strong> <span id="eRoi">—</span></li>
            <li><strong>فترة الاسترداد:</strong> <span id="ePayback">—</span></li>
            <li><strong>أثر الميزانية على الأفق:</strong> <span id="eBudgetImpact">—</span></li>
          </ul>
        </div>

        <div class="panel" style="margin-top:10px;">
          <div class="panel-head">
            <h3>Innovation Risk Engine</h3>
            <span class="panel-note">Risk Index • Residual Risk • Level</span>
          </div>

          <div class="mgrid">
            <div class="field">
              <div class="lbl">مخاطر تشغيلية (1-5)</div>
              <input id="rOperational" type="number" min="1" max="5" step="1" value="2">
            </div>
            <div class="field">
              <div class="lbl">مخاطر مالية (1-5)</div>
              <input id="rFinancial" type="number" min="1" max="5" step="1" value="2">
            </div>
            <div class="field">
              <div class="lbl">مخاطر تقنية (1-5)</div>
              <input id="rTechnical" type="number" min="1" max="5" step="1" value="2">
            </div>
            <div class="field">
              <div class="lbl">مخاطر جودة (1-5)</div>
              <input id="rQuality" type="number" min="1" max="5" step="1" value="2">
            </div>
            <div class="field">
              <div class="lbl">مخاطر تجربة المستفيد (1-5)</div>
              <input id="rExperience" type="number" min="1" max="5" step="1" value="2">
            </div>
            <div class="field">
              <div class="lbl">فعالية التخفيف (%)</div>
              <input id="rMitigationPct" type="number" min="0" max="100" step="1" value="0">
            </div>
            <div class="field">
              <div class="lbl">مسؤول المخاطر</div>
              <input id="rOwner" placeholder="اسم المسؤول">
            </div>
            <div class="field">
              <div class="lbl">دورية المراجعة</div>
              <select id="rCycle" class="select">
                <option>أسبوعي</option>
                <option selected>شهري</option>
                <option>ربع سنوي</option>
              </select>
            </div>
            <div class="field" style="grid-column:1/-1;">
              <div class="lbl">خطة التخفيف</div>
              <textarea id="rPlan" rows="3"
                style="width:100%; border-radius:12px; border:1px solid rgba(53,82,110,.22); padding:10px; font-family:inherit;"></textarea>
            </div>
          </div>

          <ul class="insight-list" style="margin-top:10px;">
            <li><strong>مؤشر الخطر:</strong> <span id="rIndex">—</span></li>
            <li><strong>الخطر المتبقي:</strong> <span id="rResidual">—</span></li>
            <li><strong>مستوى الخطر:</strong> <span id="rLevel" class="status-badge is-low">—</span></li>
          </ul>
        </div>

        <div class="panel" style="margin-top:10px;">
          <div class="panel-head">
            <h3>AI Success Prediction</h3>
            <span class="panel-note">تنبؤ أولي مبني على البيانات الحالية</span>
          </div>
          <div class="readiness-box">
            <div class="readiness-meta">
              <span>نسبة نجاح متوقعة</span>
              <strong id="aiScore">—</strong>
            </div>
            <div class="progress-track"><span id="aiBar"></span></div>
            <p class="points-line" id="aiMeta">—</p>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center;">
            <span class="status-badge is-low" id="aiLevel">—</span>
            <span class="status-badge is-low" id="aiRecommendation">—</span>
          </div>
          <ul class="insight-list" id="aiReasons" style="margin-top:10px;"></ul>
        </div>

        <div class="panel" style="margin-top:10px;">
          <div class="panel-head">
            <h3>محضر التحكيم</h3>
            <span class="panel-note">يُحفظ ويُطبع</span>
          </div>

          <div class="field">
            <div class="lbl">ملاحظات اللجنة</div>
            <textarea id="minutes" rows="5"
              style="width:100%; border-radius:12px; border:1px solid rgba(53,82,110,.22); padding:10px; font-family:inherit;"></textarea>
          </div>

          <p class="generated" style="margin-top:8px;">
            تلميح: اكتب توصيات واضحة (مطلوب لتوثيق القرار).
          </p>
        </div>

        <div class="panel" style="margin-top:10px;">
          <div class="panel-head">
            <h3>Decision Trail</h3>
            <span class="panel-note">من قيّم؟ ماذا تغيّر؟</span>
          </div>
          <ul class="trail-list" id="decisionTrail"></ul>
        </div>

        <div class="panel" style="margin-top:10px;">
          <div class="panel-head">
            <h3>Advanced Audit</h3>
            <span class="panel-note">تحيز • تناقض • جودة التقييم</span>
          </div>
          <div class="audit-grid">
            <article class="audit-metric"><p>معدل الاعتماد</p><strong id="auditApproveRate">—</strong></article>
            <article class="audit-metric"><p>تباين المحكمين</p><strong id="auditVariance">—</strong></article>
            <article class="audit-metric"><p>تقييمات غير منطقية</p><strong id="auditAnomalies">—</strong></article>
            <article class="audit-metric"><p>جودة التحكيم</p><strong id="auditQuality">—</strong></article>
          </div>
          <ul class="insight-list" id="auditAlerts" style="margin-top:10px;"></ul>
        </div>

      </section>

    </section>

    <!-- Prize Modal -->
    <div class="modal hidden" id="modalPrize">
      <div class="modal-backdrop" data-close></div>

      <div class="modal-card">
        <div class="mhead">
          <div class="mtitle">توزيع الجوائز</div>
          <button class="btn btn-ghost" data-close>إغلاق</button>
        </div>

        <div class="mgrid">
          <div class="field">
            <div class="lbl">إجمالي الجائزة (ريال)</div>
            <input id="prTotal" type="number" min="0" step="100" value="100000" />
          </div>

          <div class="field">
            <div class="lbl">آلية التوزيع</div>
            <select id="prMode" class="select">
              <option value="weighted">آلي (حسب الأوزان)</option>
              <option value="manual">يدوي (النسب يحددونها)</option>
            </select>
          </div>
        </div>

        <div class="table-wrap" style="margin-top:10px;">
          <table class="proto-table">
            <thead>
              <tr>
                <th>العضو</th>
                <th>الدور</th>
                <th>الوزن/النسبة %</th>
                <th>القيمة (ريال)</th>
              </tr>
            </thead>
            <tbody id="prBody"></tbody>
          </table>
        </div>

        <div class="mfoot">
          <div class="mtext" id="prHint">المجموع يجب أن يساوي 100% في الوضع اليدوي.</div>
          <button class="btn btn-primary" id="prApply">حفظ التوزيع</button>
        </div>
      </div>
    </div>

    <div class="modal hidden" id="modalApi">
      <div class="modal-backdrop" data-close-api></div>
      <div class="modal-card">
        <div class="mhead">
          <div class="mtitle">إعدادات الربط API</div>
          <button class="btn btn-ghost" data-close-api>إغلاق</button>
        </div>
        <div class="field">
          <div class="lbl">API Base URL</div>
          <input id="apiBaseInput" placeholder="http://127.0.0.1:8080" dir="ltr" />
        </div>
        <div class="mfoot">
          <div class="mtext" id="apiStateHint">يمكن تغيير العنوان دون إعادة تحميل الصفحة.</div>
          <button class="btn btn-soft" id="btnApiTest">اختبار الاتصال</button>
          <button class="btn btn-primary" id="btnApiSave">حفظ</button>
        </div>
      </div>
    </div>

  </div>

  <script src="../../assets/js/app.js"></script>

  <script>
    (() => {
      "use strict";

      const $ = (s, r = document) => r.querySelector(s);
      const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
      const IS = window.IS;

      const fmt = (n) => new Intl.NumberFormat("ar-SA").format(Number(n || 0));
      const clamp = (n, a, b) => Math.max(a, Math.min(b, Number(n || 0)));
      const nowISO = () => new Date().toISOString();
      const fmtDate = (v) => {
        const d = new Date(v || "");
        return Number.isNaN(d.getTime()) ? "—" : d.toLocaleString("ar-SA");
      };
      const esc = (v) => String(v ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
      const normalize = (v) => String(v || "")
        .toLowerCase()
        .replace(/[أإآ]/g, "ا")
        .replace(/ة/g, "ه")
        .replace(/ى/g, "ي")
        .replace(/\s+/g, " ")
        .trim();

      const PRIORITY_RANK = { "حرجة": 4, "عالية": 3, "متوسطة": 2, "منخفضة": 1 };
      const SEARCH_ALIASES = {
        "اللجنه": "اللجنة",
        "لجنه": "اللجنة",
        "جوده": "جودة",
        "تقنيه": "تقني",
        "حرجه": "حرجة"
      };
      const API_BASE_KEY = "IS_API_BASE";
      const DEFAULT_API_BASE = localStorage.getItem(API_BASE_KEY) || "http://127.0.0.1:8080";

      let selectedId = null;
      let fastMode = false;

      const modalBackdrop = $("#modalPrize .modal-backdrop");
      function openModal() { $("#modalPrize").classList.remove("hidden"); }
      function closeModal() { $("#modalPrize").classList.add("hidden"); }
      $$('[data-close]').forEach((b) => b.addEventListener("click", closeModal));
      if (modalBackdrop) modalBackdrop.addEventListener("click", closeModal);

      function openApiModal() {
        $("#apiBaseInput").value = getApiBase();
        $("#apiStateHint").textContent = "يمكن تغيير العنوان دون إعادة تحميل الصفحة.";
        $("#modalApi").classList.remove("hidden");
      }

      function closeApiModal() { $("#modalApi").classList.add("hidden"); }
      $$("[data-close-api]").forEach((b) => b.addEventListener("click", closeApiModal));

      function getApiBase() {
        return (localStorage.getItem(API_BASE_KEY) || DEFAULT_API_BASE).replace(/\/+$/, "");
      }

      function setApiBase(nextBase) {
        const clean = String(nextBase || "").trim().replace(/\/+$/, "");
        if (!clean) return null;
        localStorage.setItem(API_BASE_KEY, clean);
        return clean;
      }

      function mapStageToLocal(stageValue) {
        const raw = normalize(stageValue || "");
        const map = {
          "idea_submission": "الفكرة",
          "screening": "التقييم",
          "evaluation": "التقييم",
          "team_formation": "التطوير",
          "prototype": "النموذج الأولي",
          "development": "التطوير",
          "pilot": "التجربة",
          "approval": "الاعتماد",
          "legal_protection": "الاعتماد",
          "launch": "التطبيق"
        };
        if (map[raw]) return map[raw];
        if (String(stageValue || "").trim()) return String(stageValue).trim();
        return "الفكرة";
      }

      function mapStatusToLocal(statusValue) {
        const raw = normalize(statusValue || "");
        const map = {
          "draft": "مسودة",
          "in_review": "قيد التحكيم",
          "in_progress": "قيد التطوير",
          "pilot": "مرحلة التجربة",
          "approved": "معتمد",
          "rejected": "مرفوض",
          "launched": "مطلق"
        };
        if (map[raw]) return map[raw];
        if (String(statusValue || "").trim()) return String(statusValue).trim();
        return "مسودة";
      }

      function mapStageToApi(stageValue) {
        const raw = normalize(stageValue || "");
        const map = {
          "الفكره": "idea_submission",
          "الفكرة": "idea_submission",
          "التقييم": "evaluation",
          "التطوير": "development",
          "النموذج الاولي": "prototype",
          "النموذج الأولي": "prototype",
          "التجربه": "pilot",
          "التجربة": "pilot",
          "الاعتماد": "approval",
          "التطبيق": "launch"
        };
        if (map[raw]) return map[raw];
        if (String(stageValue || "").includes("_")) return String(stageValue).trim();
        return "evaluation";
      }

      function mapStatusToApi(statusValue) {
        const raw = normalize(statusValue || "");
        const map = {
          "مسوده": "draft",
          "مسودة": "draft",
          "قيد التحكيم": "in_review",
          "قيد التطوير": "in_progress",
          "مرحله التجربه": "pilot",
          "مرحلة التجربة": "pilot",
          "معتمد": "approved",
          "مرفوض": "rejected",
          "مطلق": "launched"
        };
        if (map[raw]) return map[raw];
        if (String(statusValue || "").includes("_")) return String(statusValue).trim();
        return "in_review";
      }

      function withTimeout(promise, ms = 2800) {
        let timer = null;
        const timeout = new Promise((_, reject) => {
          timer = setTimeout(() => reject(new Error("REQUEST_TIMEOUT")), ms);
        });
        return Promise.race([promise, timeout]).finally(() => clearTimeout(timer));
      }

      async function apiRequest(path, { method = "GET", body, timeoutMs = 2800 } = {}) {
        const url = `${getApiBase()}${path}`;
        const res = await withTimeout(fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: body ? JSON.stringify(body) : undefined
        }), timeoutMs);

        let data = null;
        try { data = await res.json(); } catch { data = null; }
        if (!res.ok) {
          const msg = data?.error?.message || data?.message || `${res.status}`;
          throw new Error(`API_${msg}`);
        }
        return data;
      }

      function getSelected() {
        if (!selectedId) return null;
        return (IS.state.initiatives || []).find((x) => x.id === selectedId) || null;
      }

      function isValidationComplete(validation) {
        const v = validation || {};
        return !!(String(v.problem || "").trim() &&
          String(v.beneficiary || "").trim() &&
          String(v.evidence || "").trim());
      }

      function readValidationInputs() {
        return {
          problem: ($("#vProblem").value || "").trim(),
          beneficiary: ($("#vBeneficiary").value || "").trim(),
          evidence: ($("#vEvidence").value || "").trim()
        };
      }

      function readEconomicInputs() {
        return {
          costSaving: Math.max(0, Number($("#eSaving").value || 0)),
          implementationCost: Math.max(0, Number($("#eImplCost").value || 0)),
          operatingCost: Math.max(0, Number($("#eOpex").value || 0)),
          horizonYears: clamp($("#eHorizon").value || 3, 1, 5),
          confidencePct: clamp($("#eConfidence").value || 75, 10, 100),
          timeSavingPct: clamp($("#eTimeSaving").value || 0, 0, 100)
        };
      }

      function readRiskInputs() {
        return {
          operational: clamp($("#rOperational").value || 2, 1, 5),
          financial: clamp($("#rFinancial").value || 2, 1, 5),
          technical: clamp($("#rTechnical").value || 2, 1, 5),
          quality: clamp($("#rQuality").value || 2, 1, 5),
          experience: clamp($("#rExperience").value || 2, 1, 5),
          mitigationEffectivenessPct: clamp($("#rMitigationPct").value || 0, 0, 100),
          mitigationPlan: ($("#rPlan").value || "").trim(),
          owner: ($("#rOwner").value || "").trim(),
          reviewCycle: ($("#rCycle").value || "شهري").trim()
        };
      }

      function calcEconomicImpact(impact) {
        const model = impact || {};
        const saving = Math.max(0, Number(model.costSaving || 0));
        const implementationCost = Math.max(0, Number(model.implementationCost || 0));
        const operatingCost = Math.max(0, Number(model.operatingCost || 0));
        const horizonYears = clamp(model.horizonYears || 3, 1, 5);
        const confidencePct = clamp(model.confidencePct || 75, 10, 100);

        const adjustedSaving = Math.round(saving * (confidencePct / 100));
        const netAnnual = adjustedSaving - operatingCost;
        const netOverHorizon = (netAnnual * horizonYears) - implementationCost;
        const roiPct = implementationCost > 0 ? Math.round((netOverHorizon / implementationCost) * 100) : 0;
        const paybackMonths = netAnnual > 0 ? Math.round((implementationCost / netAnnual) * 12) : null;

        return { adjustedSaving, netAnnual, netOverHorizon, roiPct, paybackMonths };
      }

      function calcRiskProfile(profile) {
        const p = profile || {};
        const vals = [
          clamp(p.operational || 2, 1, 5),
          clamp(p.financial || 2, 1, 5),
          clamp(p.technical || 2, 1, 5),
          clamp(p.quality || 2, 1, 5),
          clamp(p.experience || 2, 1, 5)
        ];
        const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
        const indexPct = Math.round((avg / 5) * 100);
        const mitigationEffectivenessPct = clamp(p.mitigationEffectivenessPct || 0, 0, 100);
        const residualPct = Math.round(indexPct * (1 - (mitigationEffectivenessPct / 100)));
        const level = residualPct >= 70 ? "مرتفع" : (residualPct >= 40 ? "متوسط" : "منخفض");
        return { indexPct, residualPct, level };
      }

      function rubricScoreFromObject(rubric) {
        const r = rubric || {};
        const vals = ["problem", "feasible", "impact", "prototype", "risk"]
          .map((k) => clamp(r[k] || 0, 0, 5));
        const sum = vals.reduce((a, b) => a + b, 0);
        return Math.round((sum / 25) * 100);
      }

      function getRubricScore(initiative) {
        const s = Number(initiative?.score);
        if (Number.isFinite(s)) return clamp(s, 0, 100);
        return rubricScoreFromObject(initiative?.rubric);
      }

      function calcIndicators(initiative) {
        const ini = initiative || {};
        const rubricPct = getRubricScore(ini);
        const validationPct = Math.round(([
          String(ini.validation?.problem || "").trim(),
          String(ini.validation?.beneficiary || "").trim(),
          String(ini.validation?.evidence || "").trim()
        ].filter(Boolean).length / 3) * 100);
        const execPct = clamp(ini.prototype?.progress ?? ini.progress ?? 0, 0, 100);
        const econ = calcEconomicImpact(ini.impact || {});
        const econPct = clamp(Math.round((econ.roiPct + 100) / 2), 0, 100);
        const risk = calcRiskProfile(ini.riskProfile || {});
        const safeRiskPct = 100 - risk.residualPct;
        const timePct = clamp(ini.impact?.timeSavingPct || 0, 0, 100);
        const confPct = clamp(ini.impact?.confidencePct || 75, 10, 100);

        const maturity = clamp(Math.round((rubricPct * 0.45) + (execPct * 0.35) + (validationPct * 0.20)), 0, 100);
        const readiness = clamp(Math.round((execPct * 0.34) + (validationPct * 0.26) + (safeRiskPct * 0.25) + (econPct * 0.15)), 0, 100);
        const expectedImpact = clamp(Math.round((econPct * 0.45) + (timePct * 0.35) + (confPct * 0.20)), 0, 100);
        const scalability = clamp(Math.round((expectedImpact * 0.40) + (readiness * 0.30) + (safeRiskPct * 0.20) + (validationPct * 0.10)), 0, 100);

        return {
          maturity,
          readiness,
          expectedImpact,
          scalability,
          riskPct: risk.residualPct,
          riskLevel: risk.level
        };
      }

      function calcSuccessPrediction(initiative) {
        const ini = initiative || {};
        const indicators = calcIndicators(ini);
        const score = Math.round(
          (getRubricScore(ini) * 0.30) +
          (indicators.readiness * 0.22) +
          (indicators.expectedImpact * 0.22) +
          ((100 - indicators.riskPct) * 0.18) +
          (indicators.scalability * 0.08)
        );
        const level = score >= 75 ? "مرتفع" : (score >= 55 ? "متوسط" : "منخفض");
        const confidencePct = clamp(55 + Math.round(indicators.readiness * 0.35), 45, 95);

        const reasons = [];
        if (!isValidationComplete(ini.validation)) reasons.push("استكمال التحقق من المشكلة والمستفيد قبل الاعتماد.");
        if (indicators.riskPct >= 60) reasons.push("الخطر المتبقي مرتفع ويحتاج خطة تخفيف أكثر صرامة.");
        if (calcEconomicImpact(ini.impact || {}).netAnnual <= 0) reasons.push("الجدوى الاقتصادية السنوية غير إيجابية حتى الآن.");
        if (indicators.readiness < 60) reasons.push("جاهزية التنفيذ تحتاج تحسين قبل قرار اللجنة.");
        if (!reasons.length) reasons.push("المعطيات الحالية متوازنة وتدعم قرارًا إيجابيًا.");

        const recommendation = score >= 75
          ? "جاهز للتوسع"
          : score >= 55
            ? "تحسين قبل الاعتماد"
            : "إعادة ضبط الفرضيات";

        return { score, level, confidencePct, recommendation, reasons };
      }

      function inferPhase(initiative) {
        const ini = initiative || {};
        const stage = String(ini.stage || "");
        const status = String(ini.status || "");
        if (stage.includes("اعتماد") || stage.includes("تطبيق") || status === "معتمد" || status === "مرفوض") return "اعتماد";
        if (stage.includes("تجربة") || stage.includes("نموذج")) return "تدقيق";
        if (stage.includes("تقييم") || status.includes("تحكيم")) return "تحكيم";
        return "فرز أولي";
      }

      function inferInnovationType(initiative) {
        const tags = Array.isArray(initiative?.tags) ? initiative.tags : [];
        const known = IS.state.taxonomy || ["تقني", "تشغيلي", "سريري", "تجربة مستفيد", "جودة", "مالي", "رقمنة"];
        for (const t of tags) {
          if (known.includes(t)) return t;
        }
        return tags[0] || known[0] || "تقني";
      }

      function inferEvalState(initiative) {
        const status = String(initiative?.status || "");
        if (status === "معتمد" || status === "مرفوض") return "مكتمل";
        if (status.includes("تطوير") || status.includes("تعديل")) return "يحتاج تعديل";
        if (status.includes("تحكيم")) return "بانتظار اللجنة";
        return "بانتظار المحكم";
      }

      function inferOrganization(initiative) {
        return String(
          initiative?.organization ||
          initiative?.org ||
          initiative?.department ||
          initiative?.ownerOrg ||
          "التجمع الصحي بالطائف"
        );
      }

      function inferPriority(initiative) {
        const k = calcIndicators(initiative || {});
        const urgency = Math.round((k.riskPct * 0.44) + ((100 - k.readiness) * 0.36) + (k.expectedImpact * 0.20));
        if (urgency >= 72) return "حرجة";
        if (urgency >= 56) return "عالية";
        if (urgency >= 40) return "متوسطة";
        return "منخفضة";
      }

      function normalizeInitiative(ini) {
        ini.tags = Array.isArray(ini.tags) ? ini.tags : [];
        ini.validation = ini.validation || { problem: "", beneficiary: "", evidence: "" };
        ini.impact = ini.impact || {};
        ini.riskProfile = ini.riskProfile || {};
        ini.rubric = ini.rubric || null;
        ini.judgeScores = Array.isArray(ini.judgeScores) ? ini.judgeScores : [];
        ini.decisionTrail = Array.isArray(ini.decisionTrail) ? ini.decisionTrail : [];

        ini.phase = String(ini.phase || inferPhase(ini));
        ini.innovationType = String(ini.innovationType || inferInnovationType(ini));
        ini.evalState = String(ini.evalState || inferEvalState(ini));
        ini.organization = inferOrganization(ini);
        ini.priority = String(ini.priority || inferPriority(ini));

        const prediction = calcSuccessPrediction(ini);
        ini.aiPrediction = {
          ...(ini.aiPrediction || {}),
          score: clamp(ini.aiPrediction?.score ?? prediction.score, 0, 100),
          level: String(ini.aiPrediction?.level || prediction.level),
          confidencePct: clamp(ini.aiPrediction?.confidencePct ?? prediction.confidencePct, 10, 100),
          recommendation: String(ini.aiPrediction?.recommendation || prediction.recommendation),
          reasons: Array.isArray(ini.aiPrediction?.reasons) ? ini.aiPrediction.reasons : prediction.reasons,
          updatedAt: ini.aiPrediction?.updatedAt || ini.updatedAt || nowISO()
        };
      }

      function normalizeState() {
        IS.state.initiatives = IS.state.initiatives || [];
        IS.state.initiatives.forEach(normalizeInitiative);
      }

      function apiRowToLocal(row) {
        const average = Number(row?.averageScore);
        return {
          id: row?.id,
          title: row?.title || "مبادرة بدون عنوان",
          stage: mapStageToLocal(row?.stage),
          status: mapStatusToLocal(row?.status),
          score: Number.isFinite(average) ? clamp(average, 0, 100) : null,
          finalScore: Number.isFinite(average) ? clamp(average, 0, 100) : null,
          progress: row?.stage ? clamp(({
            "idea_submission": 12,
            "screening": 22,
            "evaluation": 34,
            "team_formation": 44,
            "prototype": 56,
            "development": 66,
            "pilot": 76,
            "approval": 86,
            "launch": 96
          }[String(row.stage)] || 26), 0, 100) : 26,
          updatedAt: row?.updatedAt || row?.createdAt || nowISO(),
          tags: []
        };
      }

      async function syncInitiativesFromApi({ silent = true } = {}) {
        try {
          const payload = await apiRequest("/api/v2/initiatives", { method: "GET", timeoutMs: 3200 });
          const rows = Array.isArray(payload?.data) ? payload.data : [];
          if (!rows.length) return { loaded: false, count: 0 };

          const remote = rows.map(apiRowToLocal).filter((r) => r?.id);
          const local = IS.state.initiatives || [];
          const localMap = new Map(local.map((x) => [x.id, x]));

          const merged = remote.map((r) => ({
            ...(localMap.get(r.id) || {}),
            ...r,
            tags: Array.isArray(localMap.get(r.id)?.tags) ? localMap.get(r.id).tags : [],
            validation: localMap.get(r.id)?.validation || { problem: "", beneficiary: "", evidence: "" },
            impact: localMap.get(r.id)?.impact || {},
            riskProfile: localMap.get(r.id)?.riskProfile || {},
            rubric: localMap.get(r.id)?.rubric || null,
            judgeScores: Array.isArray(localMap.get(r.id)?.judgeScores) ? localMap.get(r.id).judgeScores : [],
            decisionTrail: Array.isArray(localMap.get(r.id)?.decisionTrail) ? localMap.get(r.id).decisionTrail : []
          }));

          local.forEach((item) => {
            if (!merged.some((x) => x.id === item.id)) merged.push(item);
          });

          IS.state.initiatives = merged;
          normalizeState();
          IS.save();
          if (!silent) IS.toast(`تمت مزامنة ${fmt(remote.length)} مبادرة من API`, "ok", 1500);
          return { loaded: true, count: remote.length };
        } catch (err) {
          if (!silent) IS.toast("تعذر المزامنة من API، تم الاعتماد على البيانات المحلية.", "warn", 1800);
          return { loaded: false, count: 0, error: err?.message || "API_UNAVAILABLE" };
        }
      }

      function buildMarksForApi(initiative) {
        const r = initiative?.rubric || {};
        return {
          problem: clamp(Number(r.problem || 0) * 20, 0, 100),
          feasible: clamp(Number(r.feasible || 0) * 20, 0, 100),
          impact: clamp(Number(r.impact || 0) * 20, 0, 100),
          prototype: clamp(Number(r.prototype || 0) * 20, 0, 100),
          risk: clamp(Number(r.risk || 0) * 20, 0, 100)
        };
      }

      async function pushScoreToApi(initiative, points) {
        if (!initiative?.id) return false;
        const judgeName = String($("#judgeName").value || "Demo Judge").trim() || "Demo Judge";
        await apiRequest(`/api/v2/judging/${encodeURIComponent(initiative.id)}/scores`, {
          method: "POST",
          body: {
            judgeId: `judge-${normalize(judgeName).replace(/\s+/g, "-") || "demo"}`,
            judgeName,
            marks: buildMarksForApi(initiative),
            score: points?.totalPts ?? initiative.finalScore ?? initiative.score ?? 0
          },
          timeoutMs: 3200
        });
        return true;
      }

      async function pushInitiativePatchToApi(initiative) {
        if (!initiative?.id) return false;
        await apiRequest(`/api/v2/initiatives/${encodeURIComponent(initiative.id)}`, {
          method: "PATCH",
          body: {
            stage: mapStageToApi(initiative.stage),
            status: mapStatusToApi(initiative.status)
          },
          timeoutMs: 3200
        });
        return true;
      }

      function paintValidationState(validation) {
        const ok = isValidationComplete(validation);
        const node = $("#vState");
        node.textContent = ok ? "مكتمل" : "غير مكتمل";
        node.className = `panel-note status-badge ${ok ? "is-good" : "is-mid"}`;
      }

      function paintEconomicSummary(impact) {
        const econ = calcEconomicImpact(impact);
        $("#eNetAnnual").textContent = `${fmt(econ.netAnnual)} SAR`;
        $("#eRoi").textContent = `${econ.roiPct}%`;
        $("#ePayback").textContent = econ.paybackMonths == null ? "غير متاح" : `${fmt(econ.paybackMonths)} شهر`;
        $("#eBudgetImpact").textContent = `${fmt(econ.netOverHorizon)} SAR`;
      }

      function paintRiskSummary(profile) {
        const r = calcRiskProfile(profile);
        $("#rIndex").textContent = `${r.indexPct}%`;
        $("#rResidual").textContent = `${r.residualPct}%`;
        const levelNode = $("#rLevel");
        levelNode.textContent = r.level;
        levelNode.className = `status-badge ${r.level === "مرتفع" ? "is-bad" : (r.level === "متوسط" ? "is-mid" : "is-good")}`;
      }

      function paintAiPrediction(prediction) {
        if (!prediction) {
          $("#aiScore").textContent = "—";
          $("#aiBar").style.width = "0%";
          $("#aiMeta").textContent = "—";
          $("#aiLevel").textContent = "—";
          $("#aiLevel").className = "status-badge is-low";
          $("#aiRecommendation").textContent = "—";
          $("#aiRecommendation").className = "status-badge is-low";
          $("#aiReasons").innerHTML = "";
          return;
        }

        $("#aiScore").textContent = `${prediction.score}%`;
        $("#aiBar").style.width = `${prediction.score}%`;
        $("#aiMeta").textContent = `مستوى الثقة: ${prediction.confidencePct}%`;
        $("#aiLevel").textContent = `توقع النجاح: ${prediction.level}`;
        $("#aiLevel").className = `status-badge ${prediction.level === "مرتفع" ? "is-good" : (prediction.level === "متوسط" ? "is-mid" : "is-bad")}`;
        $("#aiRecommendation").textContent = prediction.recommendation;
        $("#aiRecommendation").className = `status-badge ${prediction.level === "مرتفع" ? "is-good" : (prediction.level === "متوسط" ? "is-mid" : "is-bad")}`;
        $("#aiReasons").innerHTML = (prediction.reasons || []).map((r) => `<li>${esc(r)}</li>`).join("");
      }

      function rubricTotal() {
        const vals = $$(".inScore").map((i) => clamp(i.value || 0, 0, 5));
        const sum = vals.reduce((a, b) => a + b, 0);
        const pct = Math.round((sum / 25) * 100);
        $("#score").textContent = `${pct}%`;
        $("#bar").style.width = `${pct}%`;
        return pct;
      }

      function riskClass(riskPct) {
        if (riskPct >= 70) return "is-bad";
        if (riskPct >= 40) return "is-mid";
        return "is-good";
      }

      function priorityClass(p) {
        if (p === "حرجة") return "is-bad";
        if (p === "عالية") return "is-mid";
        if (p === "متوسطة") return "is-low";
        return "is-good";
      }

      function evalStateClass(s) {
        if (s === "مكتمل") return "is-good";
        if (s === "يحتاج تعديل") return "is-mid";
        return "is-low";
      }

      function paintKpis(initiative) {
        const cards = $$("#judgeKpiCards .judging-kpi-card strong");
        if (!cards.length) return;
        if (!initiative) {
          cards.forEach((c) => { c.textContent = "—"; c.className = ""; });
          return;
        }
        const k = calcIndicators(initiative);
        cards[0].textContent = `${k.maturity}%`;
        cards[1].textContent = `${k.readiness}%`;
        cards[2].textContent = `${k.expectedImpact}%`;
        cards[3].textContent = `${k.scalability}%`;
        cards[4].textContent = `${k.riskPct}% (${k.riskLevel})`;
        cards[4].className = riskClass(k.riskPct);
      }

      function calculatePoints(initiative) {
        if (!initiative) return { autoPts: 0, judgePts: 0, aiPts: 0, totalPts: 0, variance: 0, judgeName: "محكم" };

        const manual = clamp($("#judgeManualPts").value || 0, 0, 30);
        const aiWeight = clamp($("#judgeAiWeight").value || 30, 0, 100) / 100;
        const judgeName = String($("#judgeName").value || "محكم 1").trim() || "محكم 1";
        const rubricPct = getRubricScore(initiative);
        const aiScore = clamp(initiative.aiPrediction?.score ?? calcSuccessPrediction(initiative).score, 0, 100);

        const autoPool = 70;
        const autoPts = Math.round((autoPool * (1 - aiWeight)) * (rubricPct / 100));
        const aiPts = Math.round((autoPool * aiWeight) * (aiScore / 100));
        const judgePts = manual;
        const totalPts = clamp(autoPts + aiPts + judgePts, 0, 100);

        const scores = Array.isArray(initiative.judgeScores) ? initiative.judgeScores : [];
        const otherTotals = scores
          .filter((x) => String(x.judgeName || "") !== judgeName)
          .map((x) => clamp(x.total || 0, 0, 100));
        const spread = otherTotals.length
          ? Math.max(totalPts, ...otherTotals) - Math.min(totalPts, ...otherTotals)
          : 0;

        return { autoPts, judgePts, aiPts, totalPts, variance: spread, judgeName };
      }

      function upsertJudgeScore(initiative, points) {
        const ini = initiative;
        ini.judgeScores = Array.isArray(ini.judgeScores) ? ini.judgeScores : [];
        const idx = ini.judgeScores.findIndex((x) => String(x.judgeName || "") === points.judgeName);
        const row = {
          judgeName: points.judgeName,
          auto: points.autoPts,
          judge: points.judgePts,
          ai: points.aiPts,
          total: points.totalPts,
          updatedAt: nowISO()
        };
        if (idx >= 0) ini.judgeScores[idx] = row;
        else ini.judgeScores.push(row);
        ini.finalScore = points.totalPts;
      }

      function paintPoints(initiative) {
        const ini = initiative || getSelected();
        const p = calculatePoints(ini);
        $("#ptsAuto").textContent = `${p.autoPts}`;
        $("#ptsJudge").textContent = `${p.judgePts}`;
        $("#ptsAi").textContent = `${p.aiPts}`;
        $("#ptsTotal").textContent = `${p.totalPts}%`;

        const threshold = clamp($("#judgeVarianceThreshold").value || 15, 5, 40);
        if (!ini) {
          $("#varianceState").textContent = "—";
          return;
        }

        const count = (ini.judgeScores || []).length;
        if (count < 1) {
          $("#varianceState").textContent = `لا توجد تقييمات متعددة بعد. حد التباين: ${threshold} نقطة.`;
          return;
        }

        if (p.variance >= threshold) {
          $("#varianceState").textContent = `تنبيه: التباين بين المحكمين مرتفع (${p.variance} نقطة) ويتجاوز الحد ${threshold}.`;
        } else {
          $("#varianceState").textContent = `التباين ضمن المقبول (${p.variance} نقطة من حد ${threshold}).`;
        }
      }

      function paintFastSummary(initiative) {
        if (!initiative) {
          $("#fastSummary").textContent = "اختر مبادرة لعرض ملخص التحكيم السريع.";
          return;
        }
        const k = calcIndicators(initiative);
        const ai = initiative.aiPrediction || calcSuccessPrediction(initiative);
        const score = Number.isFinite(Number(initiative.finalScore))
          ? clamp(initiative.finalScore, 0, 100)
          : getRubricScore(initiative);
        $("#fastSummary").textContent = `${initiative.id} • ${initiative.title} | النتيجة: ${score}% | الجاهزية: ${k.readiness}% | الأثر: ${k.expectedImpact}% | المخاطر: ${k.riskPct}% (${k.riskLevel}) | توصية AI: ${ai.recommendation}`;
      }

      function toggleFastMode(force) {
        fastMode = typeof force === "boolean" ? force : !fastMode;
        document.body.classList.toggle("judging-fast-mode", fastMode);
        $("#btnFastMode").textContent = `تحكيم سريع: ${fastMode ? "ON" : "OFF"}`;
        const s = $("#fastModeState");
        s.textContent = fastMode ? "مفعل" : "غير مفعل";
        s.className = `status-badge ${fastMode ? "is-good" : "is-low"}`;
        paintFastSummary(getSelected());
      }

      function addDecisionTrail(initiative, action, details = "") {
        if (!initiative) return;
        initiative.decisionTrail = Array.isArray(initiative.decisionTrail) ? initiative.decisionTrail : [];
        initiative.decisionTrail.unshift({
          at: nowISO(),
          actor: String($("#judgeName").value || "محكم").trim() || "محكم",
          action: String(action || "إجراء"),
          details: String(details || "")
        });
        if (initiative.decisionTrail.length > 60) {
          initiative.decisionTrail = initiative.decisionTrail.slice(0, 60);
        }
      }

      function paintDecisionTrail(initiative) {
        const node = $("#decisionTrail");
        if (!initiative) {
          node.innerHTML = "<li>اختر مبادرة لعرض مسار القرارات.</li>";
          return;
        }
        const trail = Array.isArray(initiative.decisionTrail) ? initiative.decisionTrail : [];
        if (!trail.length) {
          node.innerHTML = "<li>لا يوجد سجل بعد. ابدأ بحفظ التقييم أو اتخاذ قرار.</li>";
          return;
        }
        node.innerHTML = trail.slice(0, 25).map((t) => `
          <li>
            <strong>${esc(t.action || "إجراء")}</strong>
            <div>${esc(t.details || "—")}</div>
            <span class="trail-time">${fmtDate(t.at)} • ${esc(t.actor || "محكم")}</span>
          </li>
        `).join("");
      }

      function paintAudit() {
        const inis = IS.state.initiatives || [];
        const total = inis.length || 1;
        const approved = inis.filter((i) => i.status === "معتمد").length;
        const approveRate = Math.round((approved / total) * 100);

        const variances = [];
        const alerts = [];
        let anomalies = 0;

        const loadMap = {};

        inis.forEach((ini) => {
          const scores = Array.isArray(ini.judgeScores) ? ini.judgeScores : [];
          if (scores.length >= 2) {
            const vals = scores.map((s) => clamp(s.total || 0, 0, 100));
            variances.push(Math.max(...vals) - Math.min(...vals));
          }

          scores.forEach((s) => {
            loadMap[s.judgeName] = (loadMap[s.judgeName] || 0) + 1;
          });

          const finalScore = Number.isFinite(Number(ini.finalScore)) ? clamp(ini.finalScore, 0, 100) : getRubricScore(ini);
          const risk = calcRiskProfile(ini.riskProfile || {}).residualPct;
          const validationOk = isValidationComplete(ini.validation);

          if (ini.status === "معتمد" && finalScore < 45) {
            anomalies += 1;
            alerts.push(`اعتماد بدرجة منخفضة: ${ini.id}`);
          }
          if (ini.status === "معتمد" && risk >= 75) {
            anomalies += 1;
            alerts.push(`اعتماد مع مخاطر مرتفعة: ${ini.id}`);
          }
          if (ini.status === "معتمد" && !validationOk) {
            anomalies += 1;
            alerts.push(`اعتماد دون Validation مكتمل: ${ini.id}`);
          }
          if (ini.status === "مرفوض" && finalScore >= 80) {
            anomalies += 1;
            alerts.push(`رفض مبادرة عالية النتيجة: ${ini.id}`);
          }
        });

        const avgVariance = variances.length
          ? Math.round(variances.reduce((a, b) => a + b, 0) / variances.length)
          : 0;

        const loads = Object.values(loadMap);
        if (loads.length >= 2) {
          const spread = Math.max(...loads) - Math.min(...loads);
          if (spread >= 3) alerts.push("احتمال تحيز في توزيع الأعمال: تفاوت واضح في عدد التقييمات بين المحكمين.");
        }
        if (avgVariance >= 18) alerts.push("تباين مرتفع بين تقييمات المحكمين؛ يوصى بمراجعة جماعية.");
        if (approveRate >= 85) alerts.push("معدل الاعتماد مرتفع جدًا؛ راجع معايير الصرامة.");
        if (!alerts.length) alerts.push("لا توجد مؤشرات تدقيق حرجة حاليًا.");

        const quality = clamp(100 - Math.round((avgVariance * 0.6) + (anomalies * 9)), 35, 100);

        $("#auditApproveRate").textContent = `${approveRate}%`;
        $("#auditVariance").textContent = `${avgVariance} نقطة`;
        $("#auditAnomalies").textContent = `${anomalies}`;
        $("#auditQuality").textContent = `${quality}%`;
        $("#auditAlerts").innerHTML = alerts.slice(0, 6).map((a) => `<li>${esc(a)}</li>`).join("");
      }

      function fillFilterOptions() {
        const inis = IS.state.initiatives || [];
        const typeNode = $("#innovationType");
        const orgNode = $("#orgFilter");
        const keepType = typeNode.value;
        const keepOrg = orgNode.value;

        const typeSet = new Set(IS.state.taxonomy || []);
        inis.forEach((i) => {
          if (i.innovationType) typeSet.add(i.innovationType);
          (i.tags || []).forEach((t) => typeSet.add(String(t)));
        });
        const types = Array.from(typeSet).filter(Boolean);
        typeNode.innerHTML = `<option value="">نوع الابتكار</option>${types.map((t) => `<option>${esc(t)}</option>`).join("")}`;
        if (types.includes(keepType)) typeNode.value = keepType;

        const orgs = Array.from(new Set(inis.map((i) => String(i.organization || "").trim()).filter(Boolean)));
        orgNode.innerHTML = `<option value="">الجهة المشاركة</option>${orgs.map((o) => `<option>${esc(o)}</option>`).join("")}`;
        if (orgs.includes(keepOrg)) orgNode.value = keepOrg;
      }

      function fillComparisonOptions() {
        const inis = IS.state.initiatives || [];
        const opts = inis.map((i) => `<option value="${esc(i.id)}">${esc(i.id)} — ${esc(i.title)}</option>`).join("");
        [["#cmpA", "المبادرة A"], ["#cmpB", "المبادرة B"], ["#cmpC", "المبادرة C"]].forEach(([id, label]) => {
          const node = $(id);
          const keep = node.value;
          node.innerHTML = `<option value="">${label}</option>${opts}`;
          if (inis.some((x) => x.id === keep)) node.value = keep;
        });
      }

      function matchSmart(initiative, query) {
        const q = normalize(query);
        if (!q) return true;
        const i = initiative || {};
        const hay = normalize([
          i.id,
          i.title,
          i.phase,
          i.stage,
          i.status,
          i.evalState,
          i.innovationType,
          i.priority,
          i.organization,
          ...(i.tags || []),
          i.minutes || ""
        ].join(" "));
        const tokens = q.split(" ").filter(Boolean);
        return tokens.every((tok) => {
          const alias = SEARCH_ALIASES[tok];
          return hay.includes(tok) || (alias && hay.includes(normalize(alias)));
        });
      }

      function applyFilters() {
        const inis = IS.state.initiatives || [];
        const q = normalize($("#q").value || "");
        const qAi = normalize($("#qAi").value || "");
        const phase = ($("#phase").value || "").trim();
        const type = ($("#innovationType").value || "").trim();
        const evalState = ($("#evalState").value || "").trim();
        const priority = ($("#priority").value || "").trim();
        const org = ($("#orgFilter").value || "").trim();

        return inis.filter((i) => {
          const hay = normalize(`${i.id} ${i.title}`);
          const okQ = !q || hay.includes(q);
          const okSmart = !qAi || matchSmart(i, qAi);
          const okPhase = !phase || i.phase === phase;
          const okType = !type || i.innovationType === type;
          const okEval = !evalState || i.evalState === evalState;
          const okPriority = !priority || i.priority === priority;
          const okOrg = !org || i.organization === org;
          return okQ && okSmart && okPhase && okType && okEval && okPriority && okOrg;
        }).sort((a, b) => {
          const pa = PRIORITY_RANK[a.priority] || 0;
          const pb = PRIORITY_RANK[b.priority] || 0;
          if (pb !== pa) return pb - pa;
          return new Date(b.updatedAt || 0).getTime() - new Date(a.updatedAt || 0).getTime();
        });
      }

      function renderTable() {
        normalizeState();
        fillFilterOptions();
        fillComparisonOptions();

        const inis = IS.state.initiatives || [];
        const filtered = applyFilters();

        $("#count").textContent = `إجمالي: ${fmt(inis.length)} • مكتمل: ${fmt(inis.filter((x) => x.evalState === "مكتمل").length)}`;
        $("#pill").textContent = `${fmt(filtered.length)} نتائج`;
        $("#empty").style.display = filtered.length ? "none" : "flex";

        $("#tb").innerHTML = filtered.map((i) => {
          const k = calcIndicators(i);
          const score = Number.isFinite(Number(i.finalScore)) ? clamp(i.finalScore, 0, 100) : getRubricScore(i);
          return `
            <tr>
              <td><strong>${esc(i.id)}</strong></td>
              <td>${esc(i.title)}</td>
              <td><span class="status-badge is-low">${esc(i.phase || "—")}</span></td>
              <td><span class="status-badge ${priorityClass(i.priority)}">${esc(i.priority || "—")}</span></td>
              <td><span class="status-badge ${evalStateClass(i.evalState)}">${esc(i.evalState || "—")}</span></td>
              <td>
                <div class="row-indicators">
                  <small>نضج ${k.maturity}% • جاهزية ${k.readiness}%</small>
                  <small>أثر ${k.expectedImpact}% • توسع ${k.scalability}%</small>
                  <small>مخاطر <span class="status-badge ${riskClass(k.riskPct)}">${k.riskPct}%</span></small>
                </div>
              </td>
              <td>${score}%</td>
              <td><button class="btn btn-soft" data-pick="${esc(i.id)}">اختيار</button></td>
            </tr>
          `;
        }).join("");

        $$('[data-pick]').forEach((b) => b.addEventListener("click", () => {
          selectedId = b.getAttribute("data-pick");
          IS.setSelectedInitiative(selectedId);
          IS.audit("اختيار مبادرة للتحكيم", selectedId);
          IS.save();
          loadSelectedToUI();
          IS.toast("تم اختيار المبادرة ✅", "ok", 1200);
        }));

        paintAudit();
      }

      function buildDraftInitiative() {
        const ini = getSelected();
        if (!ini) return null;
        const draft = { ...ini };
        draft.validation = readValidationInputs();
        draft.impact = { ...(ini.impact || {}), ...readEconomicInputs() };
        draft.riskProfile = { ...(ini.riskProfile || {}), ...readRiskInputs() };
        draft.rubric = { ...(ini.rubric || {}) };
        $$(".inScore").forEach((input) => {
          const key = input.getAttribute("data-k");
          draft.rubric[key] = clamp(input.value || 0, 0, 5);
        });
        draft.score = rubricScoreFromObject(draft.rubric);
        draft.aiPrediction = calcSuccessPrediction(draft);
        draft.priority = inferPriority(draft);
        return draft;
      }

      function refreshPreview() {
        const draft = buildDraftInitiative();
        if (!draft) {
          paintAiPrediction(null);
          paintValidationState(null);
          paintEconomicSummary(null);
          paintRiskSummary(null);
          paintKpis(null);
          paintPoints(null);
          paintFastSummary(null);
          return;
        }
        paintValidationState(draft.validation);
        paintEconomicSummary(draft.impact);
        paintRiskSummary(draft.riskProfile);
        paintAiPrediction(draft.aiPrediction);
        paintKpis(draft);
        paintPoints(draft);
        paintFastSummary(draft);
      }

      function loadSelectedToUI() {
        const ini = getSelected();
        if (!ini) {
          $("#sel").textContent = "اختر مبادرة";
          $("#minutes").value = "";
          $("#vProblem").value = "";
          $("#vBeneficiary").value = "";
          $("#vEvidence").value = "";
          $("#eSaving").value = 0;
          $("#eImplCost").value = 0;
          $("#eOpex").value = 0;
          $("#eHorizon").value = 3;
          $("#eConfidence").value = 75;
          $("#eTimeSaving").value = 0;
          $("#rOperational").value = 2;
          $("#rFinancial").value = 2;
          $("#rTechnical").value = 2;
          $("#rQuality").value = 2;
          $("#rExperience").value = 2;
          $("#rMitigationPct").value = 0;
          $("#rPlan").value = "";
          $("#rOwner").value = "";
          $("#rCycle").value = "شهري";
          $$(".inScore").forEach((i) => { i.value = 0; });
          rubricTotal();
          paintValidationState(null);
          paintEconomicSummary(null);
          paintRiskSummary(null);
          paintAiPrediction(null);
          paintKpis(null);
          paintDecisionTrail(null);
          paintPoints(null);
          paintFastSummary(null);
          $("#hint").textContent = "املأ المعايير ثم احفظ القرار.";
          return;
        }

        $("#sel").textContent = `${ini.title} — ${ini.id}`;
        const r = ini.rubric || {};
        $$(".inScore").forEach((i) => {
          const k = i.getAttribute("data-k");
          i.value = r[k] ?? 0;
        });
        $("#minutes").value = ini.minutes || "";

        $("#vProblem").value = ini.validation?.problem || "";
        $("#vBeneficiary").value = ini.validation?.beneficiary || "";
        $("#vEvidence").value = ini.validation?.evidence || "";

        $("#eSaving").value = Math.max(0, Number(ini.impact?.costSaving || 0));
        $("#eImplCost").value = Math.max(0, Number(ini.impact?.implementationCost || 0));
        $("#eOpex").value = Math.max(0, Number(ini.impact?.operatingCost || 0));
        $("#eHorizon").value = clamp(ini.impact?.horizonYears || 3, 1, 5);
        $("#eConfidence").value = clamp(ini.impact?.confidencePct || 75, 10, 100);
        $("#eTimeSaving").value = clamp(ini.impact?.timeSavingPct || 0, 0, 100);

        $("#rOperational").value = clamp(ini.riskProfile?.operational || 2, 1, 5);
        $("#rFinancial").value = clamp(ini.riskProfile?.financial || 2, 1, 5);
        $("#rTechnical").value = clamp(ini.riskProfile?.technical || 2, 1, 5);
        $("#rQuality").value = clamp(ini.riskProfile?.quality || 2, 1, 5);
        $("#rExperience").value = clamp(ini.riskProfile?.experience || 2, 1, 5);
        $("#rMitigationPct").value = clamp(ini.riskProfile?.mitigationEffectivenessPct || 0, 0, 100);
        $("#rPlan").value = ini.riskProfile?.mitigationPlan || "";
        $("#rOwner").value = ini.riskProfile?.owner || "";
        $("#rCycle").value = ini.riskProfile?.reviewCycle || "شهري";

        rubricTotal();
        paintValidationState(ini.validation);
        paintEconomicSummary(ini.impact);
        paintRiskSummary(ini.riskProfile);
        paintAiPrediction(ini.aiPrediction || calcSuccessPrediction(ini));
        paintKpis(ini);
        paintDecisionTrail(ini);
        paintPoints(ini);
        paintFastSummary(ini);
        $("#hint").textContent = `الحالة: ${ini.status || "مسودة"} • التقييم: ${ini.evalState || "—"} • الأولوية: ${ini.priority || "—"}`;
      }

      async function saveRubric(opts = {}) {
        const ini = getSelected();
        if (!ini) {
          if (!opts.silent) IS.toast("اختر مبادرة أولاً.", "warn");
          return false;
        }

        ini.rubric = ini.rubric || {};
        $$(".inScore").forEach((i) => {
          const k = i.getAttribute("data-k");
          ini.rubric[k] = clamp(i.value || 0, 0, 5);
        });

        ini.score = rubricTotal();
        ini.minutes = ($("#minutes").value || "").trim();
        ini.validation = readValidationInputs();
        ini.impact = { ...(ini.impact || {}), ...readEconomicInputs() };
        ini.riskProfile = { ...(ini.riskProfile || {}), ...readRiskInputs() };
        ini.aiPrediction = { ...calcSuccessPrediction(ini), updatedAt: nowISO() };

        if (ini.status === "مسودة") ini.status = "قيد التحكيم";
        if (ini.evalState === "بانتظار المحكم") ini.evalState = "بانتظار اللجنة";
        ini.phase = "تحكيم";
        ini.priority = inferPriority(ini);

        const points = calculatePoints(ini);
        upsertJudgeScore(ini, points);

        if (!opts.skipTrail) {
          addDecisionTrail(ini, "حفظ تقييم", `النتيجة ${ini.score}% • نقاط نهائية ${points.totalPts}%`);
        }

        ini.updatedAt = nowISO();
        IS.audit("حفظ نتيجة Rubric", `${ini.id} • ${ini.score}%`);
        IS.save();

        try {
          await pushScoreToApi(ini, points);
        } catch {
          if (!opts.silent) IS.toast("تعذر رفع نتيجة التحكيم إلى API. تم الحفظ محليًا.", "warn", 2000);
        }

        renderTable();
        loadSelectedToUI();
        if (!opts.silent) IS.toast("تم حفظ النتيجة ✅", "ok");
        return true;
      }

      function recommendationText(initiative) {
        if (!initiative) return "";
        const k = calcIndicators(initiative);
        const ai = initiative.aiPrediction || calcSuccessPrediction(initiative);
        const decision = (ai.level === "مرتفع" && k.riskPct < 60)
          ? "التوصية: اعتماد مرحلي مع متابعة شهرية."
          : (ai.level === "متوسط"
            ? "التوصية: يحتاج تحسين قبل الاعتماد مع خطة تخفيف واضحة."
            : "التوصية: إعادة ضبط الفرضيات وتحسين النموذج قبل إعادة التحكيم.");
        return `ملخص ${initiative.id}: النضج ${k.maturity}%، الجاهزية ${k.readiness}%، الأثر ${k.expectedImpact}%، المخاطر ${k.riskPct}% (${k.riskLevel}). ${decision}`;
      }

      async function decide(type, options = {}) {
        const ini = getSelected();
        if (!ini) { IS.toast("اختر مبادرة أولاً.", "warn"); return; }

        if (options.fast && !($("#minutes").value || "").trim()) {
          $("#minutes").value = recommendationText(ini);
        }

        const mins = ($("#minutes").value || "").trim();
        if (!mins) {
          IS.toast("اكتب محضر/ملاحظات اللجنة أولاً.", "warn", 2200);
          return;
        }

        if (!await saveRubric({ silent: true })) return;

        if (type === "approve") {
          if (!isValidationComplete(ini.validation)) {
            IS.toast("اكمل بيانات Validation قبل الاعتماد.", "warn", 2400);
            return;
          }
          const risk = calcRiskProfile(ini.riskProfile || {});
          if (risk.residualPct >= 70 && !String(ini.riskProfile?.mitigationPlan || "").trim()) {
            IS.toast("مطلوب خطة تخفيف عند الخطر المرتفع قبل الاعتماد.", "warn", 2600);
            return;
          }
          if (calcEconomicImpact(ini.impact || {}).netAnnual <= 0) {
            IS.toast("تنبيه: الأثر الاقتصادي السنوي غير إيجابي.", "warn", 2200);
          }

          ini.status = "معتمد";
          ini.stage = "الاعتماد";
          ini.phase = "اعتماد";
          ini.evalState = "مكتمل";
          ini.progress = Math.max(Number(ini.progress || 0), 80);
          addDecisionTrail(ini, "قرار اعتماد", options.fast ? "تم الاعتماد عبر التحكيم السريع." : "تم الاعتماد بعد مراجعة كاملة.");
          IS.audit("قرار: اعتماد", ini.id);
          IS.toast("تم اعتماد المبادرة ✅", "ok");
        } else {
          ini.status = "مرفوض";
          ini.stage = "التقييم";
          ini.phase = "تدقيق";
          ini.evalState = "مكتمل";
          addDecisionTrail(ini, "قرار رفض", "تم الرفض مع حفظ محضر اللجنة.");
          IS.audit("قرار: رفض", ini.id);
          IS.toast("تم رفض المبادرة (مع حفظ المحضر) ⚠️", "warn", 2400);
        }

        ini.priority = inferPriority(ini);
        ini.updatedAt = nowISO();
        IS.save();
        try {
          await pushInitiativePatchToApi(ini);
        } catch {
          IS.toast("تعذر تحديث حالة المبادرة في API. التحديث محفوظ محليًا.", "warn", 2000);
        }
        renderTable();
        loadSelectedToUI();
      }

      function renderComparison() {
        const ids = [$("#cmpA").value, $("#cmpB").value, $("#cmpC").value].filter(Boolean);
        const unique = Array.from(new Set(ids));
        if (unique.length < 2) {
          IS.toast("اختر مبادرتين على الأقل للمقارنة.", "warn");
          return;
        }

        const rows = unique.map((id) => (IS.state.initiatives || []).find((x) => x.id === id)).filter(Boolean);

        const metrics = [
          ["النتيجة النهائية", (i) => `${Number.isFinite(Number(i.finalScore)) ? clamp(i.finalScore, 0, 100) : getRubricScore(i)}%`],
          ["مستوى النضج", (i) => `${calcIndicators(i).maturity}%`],
          ["جاهزية التنفيذ", (i) => `${calcIndicators(i).readiness}%`],
          ["الأثر المتوقع", (i) => `${calcIndicators(i).expectedImpact}%`],
          ["قابلية التوسع", (i) => `${calcIndicators(i).scalability}%`],
          ["المخاطر", (i) => `${calcIndicators(i).riskPct}% (${calcIndicators(i).riskLevel})`],
          ["ROI", (i) => `${calcEconomicImpact(i.impact || {}).roiPct}%`],
          ["الأولوية", (i) => i.priority || "—"]
        ];

        $("#compareBody").innerHTML = metrics.map(([label, pick]) => `
          <tr>
            <td><strong>${esc(label)}</strong></td>
            <td>${rows[0] ? esc(pick(rows[0])) : "—"}</td>
            <td>${rows[1] ? esc(pick(rows[1])) : "—"}</td>
            <td>${rows[2] ? esc(pick(rows[2])) : "—"}</td>
          </tr>
        `).join("");

        const ranked = rows.map((i) => {
          const k = calcIndicators(i);
          const composite = Math.round((k.readiness * 0.28) + (k.expectedImpact * 0.25) + (k.maturity * 0.22) + (k.scalability * 0.17) + ((100 - k.riskPct) * 0.08));
          return { ini: i, composite };
        }).sort((a, b) => b.composite - a.composite);

        if (ranked.length) {
          $("#compareReco").textContent = `التوصية الآلية: ${ranked[0].ini.id} — ${ranked[0].ini.title} (درجة مركبة ${ranked[0].composite}%).`;
        } else {
          $("#compareReco").textContent = "—";
        }
      }

      function clearComparison() {
        ["#cmpA", "#cmpB", "#cmpC"].forEach((id) => { $(id).value = ""; });
        $("#compareBody").innerHTML = "";
        $("#compareReco").textContent = "—";
      }

      function ensureTeam() {
        IS.state.teams = IS.state.teams || [{
          id: "T-1001", name: "فريق أفق", members: [
            { id: "U-1", name: "موظف مبتكر", role: "قائد الفريق", weight: 35 },
            { id: "U-2", name: "عضو 2", role: "تحليل/بحث", weight: 25 },
            { id: "U-3", name: "عضو 3", role: "تصميم/UX", weight: 20 },
            { id: "U-4", name: "عضو 4", role: "تطوير/تنفيذ", weight: 20 }
          ]
        }];
      }

      function openPrize() {
        const ini = getSelected();
        if (!ini) { IS.toast("اختر مبادرة أولاً.", "warn"); return; }
        ensureTeam();

        const saved = (ini.prizes && ini.prizes[0]) || null;
        $("#prTotal").value = saved?.total ?? 100000;
        $("#prMode").value = saved?.mode ?? "weighted";

        renderPrizeRows();
        openModal();
      }

      function renderPrizeRows() {
        ensureTeam();
        const team = IS.state.teams[0];
        const mode = $("#prMode").value;
        const total = Number($("#prTotal").value || 0);

        $("#prHint").textContent = mode === "manual"
          ? "في الوضع اليدوي: اجعل مجموع النسب = 100%."
          : "في الوضع الآلي: سيتم التوزيع حسب أوزان الفريق.";

        $("#prBody").innerHTML = team.members.map((m) => {
          const val = (mode === "manual") ? (m.manual ?? m.weight) : m.weight;
          const amount = Math.round((val / 100) * total);
          return `
            <tr>
              <td>${esc(m.name)}</td>
              <td>${esc(m.role)}</td>
              <td>
                <input class="inScore" data-m="${esc(m.id)}" type="number" min="0" max="100" step="1"
                  value="${val}" ${mode === "weighted" ? "disabled" : ""}>
              </td>
              <td>${fmt(amount)}</td>
            </tr>
          `;
        }).join("");
      }

      function applyPrize() {
        const ini = getSelected();
        if (!ini) return;
        ensureTeam();

        const team = IS.state.teams[0];
        const mode = $("#prMode").value;
        const total = Number($("#prTotal").value || 0);
        let percents = [];

        if (mode === "weighted") {
          const sum = team.members.reduce((a, b) => a + (b.weight || 0), 0) || 1;
          percents = team.members.map((m) => ({ name: m.name, percent: Math.round(((m.weight || 0) / sum) * 100) }));
        } else {
          percents = team.members.map((m) => {
            const input = document.querySelector(`[data-m="${m.id}"]`);
            const p = clamp(input?.value || 0, 0, 100);
            m.manual = p;
            return { name: m.name, percent: p };
          });
          const sum = percents.reduce((a, b) => a + b.percent, 0);
          if (sum !== 100) {
            IS.toast(`مجموع النسب = ${sum}% (لازم 100%)`, "warn", 2600);
            return;
          }
        }

        ini.prizes = [{
          mode,
          total,
          currency: "SAR",
          breakdown: percents.map((x) => ({
            name: x.name,
            percent: x.percent,
            amount: Math.round((x.percent / 100) * total)
          }))
        }];

        addDecisionTrail(ini, "تحديث الجوائز", `آلية ${mode} بإجمالي ${fmt(total)} SAR`);
        IS.audit("حفظ توزيع الجوائز", `${ini.id} • ${mode} • ${fmt(total)} SAR`);
        ini.updatedAt = nowISO();
        IS.save();
        paintDecisionTrail(ini);
        IS.toast("تم حفظ التوزيع ✅", "ok");
        closeModal();
      }

      function seedIfNeeded() {
        const inis = IS.state.initiatives || [];
        if (inis.length >= 6) {
          IS.toast("البيانات موجودة بالفعل 👌", "warn");
          return;
        }

        IS.state.initiatives = IS.state.initiatives || [];
        IS.state.initiatives.unshift(
          {
            id: "I-3102",
            title: "نظام تذاكر داخلي ذكي",
            stage: "التقييم",
            phase: "تحكيم",
            status: "قيد التحكيم",
            evalState: "بانتظار اللجنة",
            innovationType: "تقني",
            organization: "إدارة التشغيل",
            priority: "عالية",
            updatedAt: nowISO(),
            progress: 40,
            tags: ["رقمنة", "تقني"],
            validation: { problem: "بطء متابعة الطلبات", beneficiary: "الإدارات التشغيلية", evidence: "عينة 3 أشهر" },
            impact: { costSaving: 160000, timeSavingPct: 22, implementationCost: 90000, operatingCost: 15000, horizonYears: 3, confidencePct: 76 },
            riskProfile: { operational: 3, financial: 3, technical: 2, quality: 2, experience: 2, mitigationEffectivenessPct: 25, mitigationPlan: "حوكمة تفعيل تدريجية", owner: "مدير التشغيل", reviewCycle: "شهري" },
            tasks: [],
            prototype: null,
            judgeScores: [],
            decisionTrail: []
          },
          {
            id: "I-3109",
            title: "مؤشر جودة يومي للأقسام",
            stage: "النموذج الأولي",
            phase: "تدقيق",
            status: "قيد التطوير",
            evalState: "يحتاج تعديل",
            innovationType: "جودة",
            organization: "إدارة الجودة",
            priority: "متوسطة",
            updatedAt: nowISO(),
            progress: 58,
            tags: ["جودة"],
            validation: { problem: "عدم توفر رؤية يومية فورية", beneficiary: "الإدارات الإشرافية", evidence: "ورشة داخلية + احتياج رسمي" },
            impact: { costSaving: 210000, timeSavingPct: 28, implementationCost: 125000, operatingCost: 24000, horizonYears: 3, confidencePct: 80 },
            riskProfile: { operational: 2, financial: 2, technical: 3, quality: 2, experience: 2, mitigationEffectivenessPct: 35, mitigationPlan: "مراجعة أسبوعية للمؤشرات", owner: "مدير الجودة", reviewCycle: "أسبوعي" },
            tasks: [],
            prototype: { id: "P-4101", template: "Dashboard", support: "Prototype Support Unit", scope: "مؤشر + تقرير", progress: 44, status: "قيد التطوير", createdAt: nowISO() },
            judgeScores: [],
            decisionTrail: []
          }
        );

        normalizeState();
        IS.audit("إضافة عينات للتحكيم", "seed");
        IS.save();
        renderTable();
      }

      function bindVoiceSearch() {
        $("#btnVoiceSearch").addEventListener("click", () => {
          const SpeechAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (!SpeechAPI) {
            IS.toast("البحث الصوتي غير مدعوم في هذا المتصفح.", "warn", 2200);
            return;
          }
          const rec = new SpeechAPI();
          rec.lang = "ar-SA";
          rec.interimResults = false;
          rec.maxAlternatives = 1;
          rec.onresult = (ev) => {
            const transcript = (ev.results?.[0]?.[0]?.transcript || "").trim();
            $("#qAi").value = transcript;
            renderTable();
            IS.toast("تم تطبيق البحث الصوتي ✅", "ok", 1400);
          };
          rec.onerror = () => IS.toast("تعذر تنفيذ البحث الصوتي.", "warn", 2000);
          rec.start();
        });
      }

      async function init() {
        await syncInitiativesFromApi({ silent: true });
        normalizeState();
        IS.audit("فتح مسار التحكيم", "judging");
        IS.save();

        const pre = IS.getSelectedInitiative();
        if (pre) selectedId = pre;
        if (!selectedId && (IS.state.initiatives || []).length) {
          selectedId = IS.state.initiatives[0].id;
          IS.setSelectedInitiative(selectedId);
        }

        renderTable();
        loadSelectedToUI();
        toggleFastMode(false);

        $("#q").addEventListener("input", renderTable);
        $("#qAi").addEventListener("input", renderTable);
        $("#btnSmartSearch").addEventListener("click", () => {
          renderTable();
          IS.toast("تم تحديث نتائج البحث الذكي.", "ok", 1200);
        });
        bindVoiceSearch();

        ["phase", "innovationType", "evalState", "priority", "orgFilter"].forEach((id) => {
          const node = document.getElementById(id);
          if (node) node.addEventListener("change", renderTable);
        });

        ["vProblem", "vBeneficiary", "vEvidence"].forEach((id) => document.getElementById(id).addEventListener("input", refreshPreview));
        ["eSaving", "eImplCost", "eOpex", "eHorizon", "eConfidence", "eTimeSaving"].forEach((id) => document.getElementById(id).addEventListener("input", refreshPreview));
        ["rOperational", "rFinancial", "rTechnical", "rQuality", "rExperience", "rMitigationPct", "rOwner", "rPlan"].forEach((id) => document.getElementById(id).addEventListener("input", refreshPreview));
        document.getElementById("rCycle").addEventListener("change", refreshPreview);
        $$(".inScore").forEach((input) => input.addEventListener("input", refreshPreview));

        ["judgeManualPts", "judgeAiWeight", "judgeName", "judgeVarianceThreshold"].forEach((id) => {
          document.getElementById(id).addEventListener("input", () => paintPoints(getSelected()));
        });

        $("#btnSave").addEventListener("click", async () => { await saveRubric(); });
        $("#btnApprove").addEventListener("click", async () => { await decide("approve"); });
        $("#btnReject").addEventListener("click", async () => { await decide("reject"); });
        $("#btnPrize").addEventListener("click", openPrize);
        $("#btnSeed").addEventListener("click", seedIfNeeded);
        $("#btnPrint").addEventListener("click", () => {
          IS.audit("طباعة محضر التحكيم", selectedId || "");
          IS.save();
          window.print();
        });

        $("#btnFastMode").addEventListener("click", () => toggleFastMode());
        $("#btnFastRecommend").addEventListener("click", () => {
          const ini = getSelected();
          if (!ini) { IS.toast("اختر مبادرة أولاً.", "warn"); return; }
          $("#minutes").value = recommendationText(ini);
          addDecisionTrail(ini, "توصية آلية", "تم توليد توصية سريعة من Fast Judging Mode.");
          ini.updatedAt = nowISO();
          IS.save();
          paintDecisionTrail(ini);
          paintFastSummary(ini);
          IS.toast("تم توليد توصية آلية ✅", "ok", 1300);
        });
        $("#btnFastApprove").addEventListener("click", async () => { await decide("approve", { fast: true }); });

        $("#btnCompare").addEventListener("click", renderComparison);
        $("#btnClearCompare").addEventListener("click", clearComparison);

        $("#prMode").addEventListener("change", renderPrizeRows);
        $("#prTotal").addEventListener("input", renderPrizeRows);
        $("#prApply").addEventListener("click", applyPrize);

        $("#btnApiSettings").addEventListener("click", openApiModal);
        $("#btnApiSave").addEventListener("click", async () => {
          const nextBase = setApiBase($("#apiBaseInput").value);
          if (!nextBase) {
            $("#apiStateHint").textContent = "اكتب عنوان API صحيح أولاً.";
            return;
          }
          $("#apiStateHint").textContent = "جارِ التحقق من الاتصال...";
          const result = await syncInitiativesFromApi({ silent: true });
          if (result.loaded) {
            $("#apiStateHint").textContent = `تم الحفظ والاتصال ناجح (${fmt(result.count)} مبادرة).`;
            refreshPreview();
            renderTable();
          } else {
            $("#apiStateHint").textContent = "تم حفظ العنوان لكن الاتصال غير متاح حاليًا.";
          }
        });
        $("#btnApiTest").addEventListener("click", async () => {
          $("#apiStateHint").textContent = "جارِ اختبار الاتصال...";
          const result = await syncInitiativesFromApi({ silent: true });
          if (result.loaded) {
            $("#apiStateHint").textContent = `الاتصال ناجح (${fmt(result.count)} مبادرة).`;
            renderTable();
          } else {
            $("#apiStateHint").textContent = "فشل الاتصال. راجع العنوان أو تشغيل الـbackend.";
          }
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        init().catch(() => {
          normalizeState();
          renderTable();
          loadSelectedToUI();
          toggleFastMode(false);
        });
      });
    })();
  </script>

</body>

</html>
