<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <title>Ø¯Ø±Ø¹ Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø± | Policy Center</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/app.css" />
    <style>
        .workflow-track {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .workflow-step {
            border: 1px solid rgba(9, 52, 74, 0.12);
            border-radius: 12px;
            padding: 8px;
            background: #fff;
            text-align: center;
            font-size: 12px;
            font-weight: 800;
            color: #496677;
        }

        .workflow-step.is-active {
            border-color: rgba(20, 129, 101, 0.35);
            color: #0d664a;
            background: rgba(20, 129, 101, 0.1);
        }

        .workflow-step.is-done {
            border-color: rgba(26, 112, 161, 0.3);
            color: #175e88;
            background: rgba(26, 112, 161, 0.1);
        }

        .workflow-bar {
            margin-top: 10px;
            height: 8px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(9, 52, 74, 0.12);
        }

        .workflow-bar span {
            display: block;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #14866e, #1a6f96);
            transition: width .25s ease;
        }

        .policy-table th,
        .policy-table td {
            font-size: 12px;
        }

        .policy-table td small {
            display: block;
            color: #5b7688;
            font-weight: 700;
            margin-top: 2px;
        }

        .policy-alerts {
            margin: 0;
            padding-right: 18px;
            display: grid;
            gap: 6px;
        }

        .policy-register-tools {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .governance-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .link-table th,
        .link-table td {
            font-size: 12px;
        }

        .policy-history {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 8px;
        }

        .policy-history li {
            border: 1px solid rgba(9, 52, 74, 0.12);
            border-radius: 12px;
            background: #fff;
            padding: 8px 10px;
        }

        .api-hint {
            color: #496577;
            font-size: 12px;
            font-weight: 700;
            margin-top: 8px;
        }

        @media (max-width: 1024px) {
            .workflow-track {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .policy-register-tools {
                grid-template-columns: 1fr 1fr;
            }

            .governance-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 700px) {
            .workflow-track,
            .policy-register-tools {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body class="career-body">

    <div class="platform-bg">
        <div class="mesh mesh-1"></div>
        <div class="mesh mesh-2"></div>
        <div class="mesh mesh-3"></div>
    </div>

    <div class="platform-shell">

        <header class="platform-topbar reveal">
            <div class="topbar-brand">
                <div class="brand-mark">IS</div>
                <div>
                    <h1 class="topbar-title">Policy Center</h1>
                    <p class="topbar-sub">Workflow â€¢ Compliance KPIs â€¢ Audit â€¢ Expiry Alerts â€¢ Map Linking</p>
                </div>
            </div>

            <nav class="nav">
                <a href="../../index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <a href="../map/index.html">Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±</a>
                <a href="../prototype/index.html">Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</a>
                <a href="../employee/index.html">Ù…Ø³Ø§Ø± Ø§Ù„Ù…ÙˆØ¸Ù</a>
                <a href="../judging/index.html">Ø§Ù„ØªØ­ÙƒÙŠÙ…</a>
                <a href="../command/index.html">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</a>
                <a href="../policies/index.html" class="active">Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª</a>
                <a href="../report/index.html">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ</a>
            </nav>

            <div class="topbar-actions">
                <span class="live-pill">ğŸ›ï¸ Governance Active</span>
                <button class="btn btn-soft" id="btnWorkflowNext">Ù…Ø±Ø­Ù„Ø© ØªØ§Ù„ÙŠØ©</button>
                <button class="btn btn-soft" id="btnApiSettings">API</button>
                <button class="btn btn-primary" id="btnAccept">Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØªØ¹Ù‡Ø¯</button>
                <button class="btn btn-ghost" id="btnExport">Ø·Ø¨Ø§Ø¹Ø© PDF</button>
            </div>
        </header>

        <section class="stats-grid reveal">
            <div class="stat-card stat-a">
                <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª</p>
                <h3 id="kPolicies">â€”</h3>
                <small>Policy Register</small>
            </div>
            <div class="stat-card stat-b">
                <p>Ø³ÙŠØ§Ø³Ø§Øª Ù…Ù†Ø´ÙˆØ±Ø©</p>
                <h3 id="kActive">â€”</h3>
                <small>Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚</small>
            </div>
            <div class="stat-card stat-c">
                <p>Ø³ÙŠØ§Ø³Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ© Ù‚Ø±ÙŠØ¨Ù‹Ø§</p>
                <h3 id="kExpiring">â€”</h3>
                <small>Ø®Ù„Ø§Ù„ 60 ÙŠÙˆÙ…</small>
            </div>
            <div class="stat-card stat-d">
                <p>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„</p>
                <h3 id="kCompliance">â€”</h3>
                <small>Compliance KPIs</small>
            </div>
            <div class="stat-card stat-e">
                <p>Ø­Ø§Ù„Ø© NDA</p>
                <h3 id="kNda">â€”</h3>
                <small id="ndaAt">â€”</small>
            </div>
        </section>

        <section class="insights-grid reveal">
            <section class="panel">
                <div class="panel-head">
                    <h3>ØªØ¹Ù‡Ø¯ Ø§Ù„Ø³Ø±ÙŠØ© (NDA)</h3>
                    <span class="panel-note" id="ndaState">â€”</span>
                </div>
                <p class="hero-sub" style="margin-top:0;">
                    Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØªØ¹Ù‡Ø¯ Ø´Ø±Ø· Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„Ù…Ù„ÙØ§ØªØŒ Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙÙŠ Ø§Ù„ØªØ­ÙƒÙŠÙ…ØŒ ÙˆØ±Ø¨Ø· Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±Ø§Øª Ù…Ø¹ Ø§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©.
                </p>
                <div class="readiness-box" style="margin-top:10px;">
                    <div class="readiness-meta">
                        <span>Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³Ø±ÙŠØ©</span>
                        <strong id="ndaBadge">â€”</strong>
                    </div>
                    <div class="progress-track"><span id="ndaBar"></span></div>
                    <p class="points-line" id="ndaHint">â€”</p>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
                    <button class="btn btn-primary" data-accept-policy>Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù‡Ø¯</button>
                    <button class="btn btn-soft" id="btnRevoke">Ø¥Ù„ØºØ§Ø¡ (ØªØ¬Ø±ÙŠØ¨ÙŠ)</button>
                </div>
            </section>

            <section class="panel">
                <div class="panel-head">
                    <h3>Workflow Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª</h3>
                    <span class="panel-note" id="workflowState">â€”</span>
                </div>
                <div class="workflow-track" id="workflowSteps"></div>
                <div class="workflow-bar"><span id="workflowBar"></span></div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
                    <button class="btn btn-soft" id="btnWorkflowBack">Ø±Ø¬ÙˆØ¹ Ù…Ø±Ø­Ù„Ø©</button>
                    <button class="btn btn-primary" id="btnWorkflowForward">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</button>
                </div>
            </section>
        </section>

        <section class="insights-grid reveal">
            <section class="panel">
                <div class="panel-head">
                    <h3>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª</h3>
                    <span class="panel-note">Expiry Alerts</span>
                </div>
                <ul class="policy-alerts" id="expiryAlerts"></ul>
            </section>

            <section class="panel">
                <div class="panel-head">
                    <h3>Governance Dashboard</h3>
                    <span class="panel-note">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</span>
                </div>
                <ul class="metric-list" id="governanceKpis"></ul>
            </section>
        </section>

        <section class="panel reveal">
            <div class="panel-head">
                <h3>Ø³Ø¬Ù„ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª</h3>
                <span class="panel-note">Policy Center Register</span>
            </div>
            <div class="policy-register-tools">
                <input id="pQ" placeholder="Ø¨Ø­Ø« Ø¨Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù..." />
                <select id="pStatus">
                    <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                </select>
                <input id="pOwner" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø§Ù„Ùƒ..." />
                <select id="pStage">
                    <option value="">ÙƒÙ„ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±</option>
                </select>
            </div>
            <div class="table-wrap" style="margin-top:10px;">
                <table class="proto-table policy-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ø¹Ø±Ù</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø³Ø©</th>
                            <th>Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ù…Ø§Ù„Ùƒ</th>
                            <th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                            <th>Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„</th>
                            <th>Ø§Ù„Ø±Ø¨Ø·</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="policyBody"></tbody>
                </table>
            </div>
            <div class="empty-line" id="policyEmpty" style="display:none; margin-top:10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø³Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ±.</div>
        </section>

        <section class="insights-grid reveal">
            <section class="panel">
                <div class="panel-head">
                    <h3>Ø±Ø¨Ø· Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø¨Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±</h3>
                    <span class="panel-note">Policy â†’ Initiative Mapping</span>
                </div>
                <div class="table-wrap">
                    <table class="proto-table link-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø¹Ø±Ù</th>
                                <th>Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø©</th>
                                <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                <th>Ø³ÙŠØ§Ø³Ø§Øª Ù…Ø·Ø¨Ù‚Ø©</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                            </tr>
                        </thead>
                        <tbody id="linkBody"></tbody>
                    </table>
                </div>
            </section>

            <section class="panel">
                <div class="panel-head">
                    <h3>Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</h3>
                    <span class="panel-note">Ø¢Ø®Ø± 16 Ø­Ø¯Ø«</span>
                </div>
                <ul class="timeline" id="audit"></ul>
            </section>
        </section>

    </div>

    <div class="modal hidden" id="modalPolicy">
        <div class="modal-backdrop" data-close-policy></div>
        <div class="modal-card" style="max-width:760px; width:min(760px, calc(100vw - 24px));">
            <div class="modal-head">
                <h3 id="policyModalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø³Ø©</h3>
                <button class="modal-close" data-close-policy>âœ•</button>
            </div>
            <div class="form-grid">
                <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                <select id="pmStatus"></select>
                <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ (%)</label>
                <input id="pmCompliance" type="number" min="0" max="100" />
                <label>Ù…Ù„Ø§Ø­Ø¸Ø© ØªØºÙŠÙŠØ±</label>
                <input id="pmNote" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„..." />
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                <button class="btn btn-soft" id="pmAddNote">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„</button>
                <button class="btn btn-primary" id="pmSave">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
            <h4 style="margin:14px 0 8px;">Ø³Ø¬Ù„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</h4>
            <ul class="policy-history" id="policyHistory"></ul>
        </div>
    </div>

    <div class="modal hidden" id="modalApi">
        <div class="modal-backdrop" data-close-api></div>
        <div class="modal-card" style="max-width:560px; width:min(560px, calc(100vw - 24px));">
            <div class="modal-head">
                <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API</h3>
                <button class="modal-close" data-close-api>âœ•</button>
            </div>
            <div class="form-grid">
                <label>API Base URL</label>
                <input id="apiBaseInput" placeholder="http://127.0.0.1:8080" dir="ltr" />
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                <button class="btn btn-soft" id="btnApiTest">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</button>
                <button class="btn btn-primary" id="btnApiSave">Ø­ÙØ¸</button>
            </div>
            <p class="api-hint" id="apiStateHint">Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ø°Ø§ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„.</p>
        </div>
    </div>

    <script src="../../assets/js/app.js"></script>
    <script>
        (() => {
            "use strict";
            const $ = (s, r = document) => r.querySelector(s);
            const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
            const IS = window.IS;
            const API_BASE_KEY = "IS_API_BASE";

            const fmt = (n) => new Intl.NumberFormat("ar-SA").format(Number(n || 0));
            const esc = (v) => String(v ?? "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, "&quot;")
                .replace(/'/g, "&#39;");
            const clamp = (n, a, b) => Math.max(a, Math.min(b, Number(n || 0)));
            const nowISO = () => new Date().toISOString();
            const normalize = (t) => String(t || "").toLowerCase().trim().replace(/\s+/g, " ");

            const WORKFLOW_STEPS = ["ØµÙŠØ§ØºØ©", "Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©", "Ø§Ø¹ØªÙ…Ø§Ø¯ Ù„Ø¬Ù†Ø©", "Ù†Ø´Ø± Ø±Ø³Ù…ÙŠ", "Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù…ØªØ«Ø§Ù„"];
            const POLICY_STATUS = ["Ù…Ø³ÙˆØ¯Ø©", "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©", "Ù…Ø¹ØªÙ…Ø¯Ø©", "Ù…Ù†Ø´ÙˆØ±Ø©", "Ù…Ù†ØªÙ‡ÙŠØ©"];

            let activePolicyId = null;

            function defaultPolicyCenter() {
                return {
                    workflowStage: WORKFLOW_STEPS[0],
                    policies: [
                        {
                            id: "POL-1001",
                            title: "Ø³ÙŠØ§Ø³Ø© Ø³Ø±ÙŠØ© Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±",
                            owner: "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©",
                            version: "2.1",
                            status: "Ù…Ù†Ø´ÙˆØ±Ø©",
                            compliancePct: 94,
                            effectiveDate: "2026-01-01",
                            expiryDate: "2026-12-31",
                            linkedStages: ["Ø§Ù„ÙÙƒØ±Ø©", "Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ÙˆÙ„ÙŠ", "Ø§Ù„ØªØ­ÙƒÙŠÙ…"],
                            linkedTags: ["ØªÙ‚Ù†ÙŠ", "Ø¬ÙˆØ¯Ø©", "Ø±Ù‚Ù…Ù†Ø©"],
                            history: [
                                { at: "2026-01-04T10:15:00", by: "Legal", note: "ØªØ­Ø¯ÙŠØ« Ø¨Ù†ÙˆØ¯ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„ÙØ§Øª" },
                                { at: "2026-01-22T14:30:00", by: "Governance", note: "Ø§Ø¹ØªÙ…Ø§Ø¯ Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù„Ø¬Ù†Ø©" }
                            ]
                        },
                        {
                            id: "POL-1002",
                            title: "Ø³ÙŠØ§Ø³Ø© ØªØ¹Ø§Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ù„Ø­ Ù„Ù„Ù…Ø­ÙƒÙ…ÙŠÙ†",
                            owner: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙˆÙƒÙ…Ø©",
                            version: "1.4",
                            status: "Ù…Ø¹ØªÙ…Ø¯Ø©",
                            compliancePct: 88,
                            effectiveDate: "2026-01-15",
                            expiryDate: "2026-08-30",
                            linkedStages: ["Ø§Ù„ØªÙ‚ÙŠÙŠÙ…", "Ø§Ù„ØªØ­ÙƒÙŠÙ…", "Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯"],
                            linkedTags: ["ØªØ´ØºÙŠÙ„ÙŠ", "Ù…Ø§Ù„ÙŠ"],
                            history: [
                                { at: "2026-01-18T11:10:00", by: "Audit", note: "Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø§Ù„Ø¥ÙØµØ§Ø­ Ø§Ù„Ù…Ø³Ø¨Ù‚" }
                            ]
                        },
                        {
                            id: "POL-1003",
                            title: "Ø³ÙŠØ§Ø³Ø© Ø­Ù…Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©",
                            owner: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ",
                            version: "1.2",
                            status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
                            compliancePct: 79,
                            effectiveDate: "2026-02-01",
                            expiryDate: "2026-06-20",
                            linkedStages: ["Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ÙˆÙ„ÙŠ", "Ø§Ù„ØªØ¬Ø±Ø¨Ø©", "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"],
                            linkedTags: ["ØªÙ‚Ù†ÙŠ", "Ø³Ø±ÙŠØ±ÙŠ", "Ø±Ù‚Ù…Ù†Ø©"],
                            history: [
                                { at: "2026-02-03T09:05:00", by: "Cyber", note: "Ø¥Ø¯Ø±Ø§Ø¬ Ù…ØªØ·Ù„Ø¨Ø§Øª ØªØ´ÙÙŠØ± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø£ÙˆÙ„ÙŠØ©" }
                            ]
                        }
                    ],
                    updatedAt: nowISO()
                };
            }

            function ensurePolicyCenter() {
                if (!IS.state.policyCenter || typeof IS.state.policyCenter !== "object") {
                    IS.state.policyCenter = defaultPolicyCenter();
                }
                IS.state.policyCenter.workflowStage = IS.state.policyCenter.workflowStage || WORKFLOW_STEPS[0];
                IS.state.policyCenter.policies = Array.isArray(IS.state.policyCenter.policies)
                    ? IS.state.policyCenter.policies
                    : defaultPolicyCenter().policies;

                IS.state.policyCenter.policies = IS.state.policyCenter.policies.map((p) => ({
                    id: String(p.id || `POL-${Math.floor(1000 + Math.random() * 9000)}`),
                    title: String(p.title || "Ø³ÙŠØ§Ø³Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"),
                    owner: String(p.owner || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"),
                    version: String(p.version || "1.0"),
                    status: POLICY_STATUS.includes(p.status) ? p.status : "Ù…Ø³ÙˆØ¯Ø©",
                    compliancePct: clamp(Number(p.compliancePct || 0), 0, 100),
                    effectiveDate: String(p.effectiveDate || nowISO().slice(0, 10)),
                    expiryDate: String(p.expiryDate || nowISO().slice(0, 10)),
                    linkedStages: Array.isArray(p.linkedStages) ? p.linkedStages.map((x) => String(x || "")).filter(Boolean) : [],
                    linkedTags: Array.isArray(p.linkedTags) ? p.linkedTags.map((x) => String(x || "")).filter(Boolean) : [],
                    history: Array.isArray(p.history) ? p.history : []
                }));
            }

            function daysTo(dateText) {
                const t = new Date(dateText).getTime();
                if (!Number.isFinite(t)) return 999;
                return Math.ceil((t - Date.now()) / (24 * 60 * 60 * 1000));
            }

            function statusClass(status) {
                if (status === "Ù…Ù†Ø´ÙˆØ±Ø©" || status === "Ù…Ø¹ØªÙ…Ø¯Ø©") return "is-good";
                if (status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©") return "is-mid";
                if (status === "Ù…Ù†ØªÙ‡ÙŠØ©") return "is-bad";
                return "is-low";
            }

            function getPolicies() {
                return (IS.state.policyCenter?.policies || []);
            }

            function getApiBase() {
                return (localStorage.getItem(API_BASE_KEY) || "http://127.0.0.1:8080").trim();
            }

            function setApiBase(v) {
                const base = String(v || "").trim().replace(/\/$/, "");
                localStorage.setItem(API_BASE_KEY, base);
                return base;
            }

            function openApiModal() {
                $("#apiBaseInput").value = getApiBase();
                $("#apiStateHint").textContent = "Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ø°Ø§ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„.";
                $("#modalApi").classList.remove("hidden");
            }

            function closeApiModal() {
                $("#modalApi").classList.add("hidden");
            }

            function withTimeout(promise, timeoutMs = 3200) {
                return Promise.race([
                    promise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), timeoutMs))
                ]);
            }

            async function apiRequest(path, { method = "GET", body, timeoutMs = 3400 } = {}) {
                const res = await withTimeout(fetch(`${getApiBase()}${path}`, {
                    method,
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: body ? JSON.stringify(body) : undefined
                }), timeoutMs);
                if (!res.ok) {
                    const txt = await res.text().catch(() => "");
                    throw new Error(`HTTP ${res.status} ${txt}`);
                }
                return await res.json().catch(() => null);
            }

            function renderNDA() {
                const accepted = !!(IS.state.policies && IS.state.policies.accepted);
                const acceptedAt = IS.state.policies?.acceptedAt;
                $("#ndaState").textContent = accepted ? "Ù…Ù‚Ø¨ÙˆÙ„ âœ…" : "ØºÙŠØ± Ù…Ù‚Ø¨ÙˆÙ„";
                $("#ndaBadge").textContent = accepted ? "Ù…ÙØ¹Ù‘Ù„" : "ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„";
                $("#ndaBar").style.width = accepted ? "100%" : "24%";
                $("#ndaHint").textContent = accepted
                    ? "Ø§Ù„ØªØ¹Ù‡Ø¯ Ù…ÙØ¹Ù‘Ù„: Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØªØ­ÙƒÙŠÙ… Ù…ØªØ§Ø­Ø© Ø¶Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª."
                    : "Ø§Ù„ØªØ¹Ù‡Ø¯ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„: Ø³ÙŠØªÙ… ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§Ù„Ø±ÙØ¹ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©.";
                $("#btnAccept").disabled = accepted;
                $("#btnAccept").textContent = accepted ? "ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„" : "Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØªØ¹Ù‡Ø¯";
                $("#kNda").textContent = accepted ? "Ù…ÙØ¹Ù‘Ù„" : "ØºÙŠØ± Ù…ÙØ¹Ù„";
                $("#ndaAt").textContent = acceptedAt ? `Ù…Ù†Ø° ${(acceptedAt || "").slice(0, 10)}` : "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„";
            }

            function renderWorkflow() {
                const stage = IS.state.policyCenter.workflowStage;
                const idx = Math.max(0, WORKFLOW_STEPS.indexOf(stage));

                $("#workflowState").textContent = `Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${stage}`;
                $("#workflowSteps").innerHTML = WORKFLOW_STEPS.map((step, i) => {
                    const cls = i < idx ? "workflow-step is-done" : (i === idx ? "workflow-step is-active" : "workflow-step");
                    return `<div class="${cls}">${esc(step)}</div>`;
                }).join("");
                $("#workflowBar").style.width = `${Math.round(((idx + 1) / WORKFLOW_STEPS.length) * 100)}%`;
            }

            function renderKpis() {
                const policies = getPolicies();
                const total = policies.length;
                const active = policies.filter((p) => p.status === "Ù…Ù†Ø´ÙˆØ±Ø©").length;
                const expiring = policies.filter((p) => {
                    const d = daysTo(p.expiryDate);
                    return d >= 0 && d <= 60;
                }).length;
                const complianceAvg = total
                    ? Math.round(policies.reduce((sum, p) => sum + Number(p.compliancePct || 0), 0) / total)
                    : 0;

                $("#kPolicies").textContent = fmt(total);
                $("#kActive").textContent = fmt(active);
                $("#kExpiring").textContent = fmt(expiring);
                $("#kCompliance").textContent = `${fmt(complianceAvg)}%`;
            }

            function renderExpiryAlerts() {
                const policies = getPolicies();
                const alerts = policies
                    .map((p) => ({ p, days: daysTo(p.expiryDate) }))
                    .filter((x) => x.days <= 60)
                    .sort((a, b) => a.days - b.days);

                if (!alerts.length) {
                    $("#expiryAlerts").innerHTML = `<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø³Ø§Øª ØªÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ 60 ÙŠÙˆÙ….</li>`;
                    return;
                }

                $("#expiryAlerts").innerHTML = alerts.map((x) => {
                    const state = x.days < 0 ? "Ø§Ù†ØªÙ‡Øª" : (x.days === 0 ? "ØªÙ†ØªÙ‡ÙŠ Ø§Ù„ÙŠÙˆÙ…" : `Ù…ØªØ¨Ù‚ÙŠ ${fmt(x.days)} ÙŠÙˆÙ…`);
                    return `<li><strong>${esc(x.p.id)}</strong> â€” ${esc(x.p.title)} <span>(${state})</span></li>`;
                }).join("");
            }

            function renderGovernanceKpis() {
                const policies = getPolicies();
                const ndaAccepted = !!IS.state.policies?.accepted;
                const draft = policies.filter((p) => p.status === "Ù…Ø³ÙˆØ¯Ø©").length;
                const review = policies.filter((p) => p.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©").length;
                const published = policies.filter((p) => p.status === "Ù…Ù†Ø´ÙˆØ±Ø©").length;
                const avgCompliance = policies.length
                    ? Math.round(policies.reduce((sum, p) => sum + Number(p.compliancePct || 0), 0) / policies.length)
                    : 0;

                $("#governanceKpis").innerHTML = `
                    <li><span>Ø¬Ø§Ù‡Ø²ÙŠØ© NDA</span><strong>${ndaAccepted ? "Ù…ÙØ¹Ù„Ø©" : "ØºÙŠØ± Ù…ÙØ¹Ù„Ø©"}</strong></li>
                    <li><span>Ø³ÙŠØ§Ø³Ø§Øª Ù…Ø³ÙˆØ¯Ø©</span><strong>${fmt(draft)}</strong></li>
                    <li><span>Ø³ÙŠØ§Ø³Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span><strong>${fmt(review)}</strong></li>
                    <li><span>Ø³ÙŠØ§Ø³Ø§Øª Ù…Ù†Ø´ÙˆØ±Ø©</span><strong>${fmt(published)}</strong></li>
                    <li><span>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„</span><strong>${fmt(avgCompliance)}%</strong></li>
                    <li><span>Ù…Ø±Ø­Ù„Ø© Workflow Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span><strong>${esc(IS.state.policyCenter.workflowStage)}</strong></li>
                `;
            }

            function readPolicyFilters() {
                return {
                    q: normalize($("#pQ").value),
                    status: $("#pStatus").value || "",
                    owner: normalize($("#pOwner").value),
                    stage: $("#pStage").value || ""
                };
            }

            function fillPolicyFilters() {
                const policies = getPolicies();
                const keepStatus = $("#pStatus").value;
                const keepStage = $("#pStage").value;
                const stages = Array.from(new Set((IS.state.stages || []).concat(policies.flatMap((p) => p.linkedStages || [])).filter(Boolean)));

                $("#pStatus").innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>` + POLICY_STATUS.map((s) => `<option>${esc(s)}</option>`).join("");
                $("#pStage").innerHTML = `<option value="">ÙƒÙ„ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±</option>` + stages.map((s) => `<option>${esc(s)}</option>`).join("");

                $("#pStatus").value = keepStatus;
                $("#pStage").value = keepStage;
            }

            function filteredPolicies() {
                const filters = readPolicyFilters();
                return getPolicies().filter((p) => {
                    const hay = normalize(`${p.id} ${p.title} ${p.owner} ${p.version} ${(p.linkedStages || []).join(" ")}`);
                    const okQ = !filters.q || hay.includes(filters.q);
                    const okStatus = !filters.status || p.status === filters.status;
                    const okOwner = !filters.owner || normalize(p.owner).includes(filters.owner);
                    const okStage = !filters.stage || (p.linkedStages || []).includes(filters.stage);
                    return okQ && okStatus && okOwner && okStage;
                });
            }

            function renderPolicyTable() {
                const rows = filteredPolicies();
                $("#policyEmpty").style.display = rows.length ? "none" : "flex";

                $("#policyBody").innerHTML = rows.map((p) => {
                    const d = daysTo(p.expiryDate);
                    const expiryText = d < 0 ? `Ù…Ù†ØªÙ‡ÙŠØ© Ù…Ù†Ø° ${fmt(Math.abs(d))} ÙŠÙˆÙ…` : `Ø¨Ø¹Ø¯ ${fmt(d)} ÙŠÙˆÙ…`;
                    return `
                        <tr>
                            <td><strong>${esc(p.id)}</strong></td>
                            <td>${esc(p.title)}<small>${esc((p.linkedStages || []).join(" â€¢ ") || "Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø·")}</small></td>
                            <td>${esc(p.version)}</td>
                            <td><span class="status-badge ${statusClass(p.status)}">${esc(p.status)}</span></td>
                            <td>${esc(p.owner)}</td>
                            <td>${esc(p.expiryDate)}<small>${esc(expiryText)}</small></td>
                            <td>${fmt(p.compliancePct)}%</td>
                            <td>${fmt((p.linkedTags || []).length)} ÙˆØ³ÙˆÙ…</td>
                            <td><button class="btn btn-soft" data-open-policy="${esc(p.id)}">Ø¥Ø¯Ø§Ø±Ø©</button></td>
                        </tr>
                    `;
                }).join("");
            }

            function renderMapLinks() {
                const initiatives = (IS.state.initiatives || []);
                const policies = getPolicies().filter((p) => p.status !== "Ù…Ù†ØªÙ‡ÙŠØ©");

                const rows = initiatives.slice(0, 18).map((i) => {
                    const tags = Array.isArray(i.tags) ? i.tags : [];
                    const matched = policies.filter((p) => {
                        const stageMatch = (p.linkedStages || []).includes(i.stage);
                        const tagMatch = tags.some((t) => (p.linkedTags || []).includes(t));
                        return stageMatch || tagMatch;
                    });
                    return { i, matched };
                });

                $("#linkBody").innerHTML = rows.length
                    ? rows.map((row) => `
                        <tr>
                            <td><strong>${esc(row.i.id)}</strong></td>
                            <td>${esc(row.i.title || "â€”")}</td>
                            <td>${esc(row.i.stage || "â€”")}</td>
                            <td>${esc((row.i.tags || ["â€”"])[0])}</td>
                            <td>${fmt(row.matched.length)} Ø³ÙŠØ§Ø³Ø©</td>
                            <td><button class="btn btn-soft" data-open-map="${esc(row.i.id)}">ÙØªØ­ Ø¨Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button></td>
                        </tr>
                    `).join("")
                    : `<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø¯Ø±Ø§Øª Ù„Ù„Ø±Ø¨Ø· Ø­Ø§Ù„ÙŠÙ‹Ø§.</td></tr>`;
            }

            function renderAudit() {
                const items = (IS.state.audit || []).slice(0, 16);
                $("#audit").innerHTML = items.map((a) => `
                    <li class="timeline-item">
                        <h4>${esc(a.title || "Ø­Ø¯Ø«")}</h4>
                        <p>${esc(a.meta || "")}</p>
                        <div class="time">${esc((a.at || "").slice(0, 19).replace("T", " â€¢ "))}</div>
                    </li>
                `).join("");
            }

            function getPolicyById(id) {
                return getPolicies().find((p) => p.id === id) || null;
            }

            function openPolicyModal(id) {
                const p = getPolicyById(id);
                if (!p) return;
                activePolicyId = id;
                $("#policyModalTitle").textContent = `${p.id} â€” ${p.title}`;
                $("#pmStatus").innerHTML = POLICY_STATUS.map((s) => `<option>${esc(s)}</option>`).join("");
                $("#pmStatus").value = p.status;
                $("#pmCompliance").value = p.compliancePct;
                $("#pmNote").value = "";

                $("#policyHistory").innerHTML = (p.history || []).length
                    ? p.history.map((h) => `
                        <li>
                            <strong>${esc((h.at || "").slice(0, 19).replace("T", " â€¢ "))}</strong>
                            <div>${esc(h.note || "")}</div>
                            <small>${esc(h.by || "System")}</small>
                        </li>
                    `).join("")
                    : `<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ø¹Ø¯.</li>`;

                $("#modalPolicy").classList.remove("hidden");
            }

            function closePolicyModal() {
                activePolicyId = null;
                $("#modalPolicy").classList.add("hidden");
            }

            function mutateActivePolicy(mutator) {
                if (!activePolicyId) return null;
                const policies = getPolicies();
                const idx = policies.findIndex((p) => p.id === activePolicyId);
                if (idx < 0) return null;
                mutator(policies[idx]);
                IS.state.policyCenter.updatedAt = nowISO();
                IS.save();
                return policies[idx];
            }

            function addPolicyHistory(policy, note, by = "Policy Center") {
                policy.history = policy.history || [];
                policy.history.unshift({ at: nowISO(), by, note });
                policy.history = policy.history.slice(0, 30);
            }

            async function syncPoliciesFromApi({ silent = true } = {}) {
                try {
                    const payload = await apiRequest("/api/v2/governance/policies", { method: "GET", timeoutMs: 3600 });
                    const rows = Array.isArray(payload?.items) ? payload.items : (Array.isArray(payload) ? payload : []);
                    if (rows.length) {
                        const normalized = rows.map((p) => ({
                            id: String(p.id || p.policyId || `POL-${Math.floor(1000 + Math.random() * 9000)}`),
                            title: String(p.title || p.name || "Ø³ÙŠØ§Ø³Ø©"),
                            owner: String(p.owner || p.department || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"),
                            version: String(p.version || "1.0"),
                            status: POLICY_STATUS.includes(String(p.status || "")) ? String(p.status) : "Ù…Ø³ÙˆØ¯Ø©",
                            compliancePct: clamp(Number(p.compliancePct || p.compliance || 0), 0, 100),
                            effectiveDate: String(p.effectiveDate || nowISO().slice(0, 10)),
                            expiryDate: String(p.expiryDate || nowISO().slice(0, 10)),
                            linkedStages: Array.isArray(p.linkedStages) ? p.linkedStages : [],
                            linkedTags: Array.isArray(p.linkedTags) ? p.linkedTags : [],
                            history: Array.isArray(p.history) ? p.history : []
                        }));
                        IS.state.policyCenter.policies = normalized;
                        IS.audit("Ù…Ø²Ø§Ù…Ù†Ø© Policy Center Ù…Ù† API", `${fmt(normalized.length)} Ø³ÙŠØ§Ø³Ø©`);
                        IS.save();
                    }
                    if (!silent) IS.toast("ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª âœ…", "ok", 1700);
                    return { ok: true, count: rows.length };
                } catch (err) {
                    if (!silent) IS.toast("ØªØ¹Ø°Ø± Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø³Ø§ØªØŒ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.", "warn", 2300);
                    return { ok: false, error: String(err?.message || err) };
                }
            }

            function renderAll() {
                fillPolicyFilters();
                renderNDA();
                renderWorkflow();
                renderKpis();
                renderExpiryAlerts();
                renderGovernanceKpis();
                renderPolicyTable();
                renderMapLinks();
                renderAudit();

                $$('[data-open-policy]').forEach((b) => {
                    b.addEventListener('click', () => openPolicyModal(b.getAttribute('data-open-policy')));
                });
                $$('[data-open-map]').forEach((b) => {
                    b.addEventListener('click', () => {
                        localStorage.setItem('is_selected_initiative', b.getAttribute('data-open-map'));
                        window.location.href = '../map/index.html';
                    });
                });
            }

            async function init() {
                ensurePolicyCenter();
                IS.audit("ÙØªØ­ Policy Center", "policies");
                IS.save();

                await syncPoliciesFromApi({ silent: true });
                renderAll();

                $("#btnAccept").addEventListener("click", () => {
                    const btn = document.querySelector("[data-accept-policy]");
                    if (btn) btn.click();
                    IS.audit("ØªØ£ÙƒÙŠØ¯ ØªØ¹Ù‡Ø¯ Ø§Ù„Ø³Ø±ÙŠØ© Ù…Ù† Policy Center", "NDA");
                    IS.save();
                    renderAll();
                });

                $("#btnRevoke").addEventListener("click", () => {
                    IS.state.policies.accepted = false;
                    IS.state.policies.acceptedAt = null;
                    IS.audit("Ø¥Ù„ØºØ§Ø¡ ØªØ¹Ù‡Ø¯ Ø§Ù„Ø³Ø±ÙŠØ© (ØªØ¬Ø±ÙŠØ¨ÙŠ)", "NDA");
                    IS.save();
                    IS.toast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ù‡Ø¯ (ØªØ¬Ø±ÙŠØ¨ÙŠ)", "warn", 1900);
                    renderAll();
                });

                $("#btnWorkflowForward").addEventListener("click", () => {
                    const idx = WORKFLOW_STEPS.indexOf(IS.state.policyCenter.workflowStage);
                    if (idx < WORKFLOW_STEPS.length - 1) {
                        IS.state.policyCenter.workflowStage = WORKFLOW_STEPS[idx + 1];
                        IS.audit("ØªÙ‚Ø¯Ù… Workflow Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª", IS.state.policyCenter.workflowStage);
                        IS.save();
                        renderAll();
                    }
                });

                $("#btnWorkflowBack").addEventListener("click", () => {
                    const idx = WORKFLOW_STEPS.indexOf(IS.state.policyCenter.workflowStage);
                    if (idx > 0) {
                        IS.state.policyCenter.workflowStage = WORKFLOW_STEPS[idx - 1];
                        IS.audit("Ø¥Ø±Ø¬Ø§Ø¹ Workflow Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª", IS.state.policyCenter.workflowStage);
                        IS.save();
                        renderAll();
                    }
                });

                $("#btnWorkflowNext").addEventListener("click", () => {
                    const idx = WORKFLOW_STEPS.indexOf(IS.state.policyCenter.workflowStage);
                    IS.state.policyCenter.workflowStage = WORKFLOW_STEPS[(idx + 1) % WORKFLOW_STEPS.length];
                    IS.audit("ØªØ­Ø¯ÙŠØ« Ø³Ø±ÙŠØ¹ Ù„Ù…Ø³Ø§Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª", IS.state.policyCenter.workflowStage);
                    IS.save();
                    renderAll();
                });

                $("#btnExport").addEventListener("click", () => {
                    IS.audit("Ø·Ø¨Ø§Ø¹Ø© Policy Center", "export/pdf");
                    IS.save();
                    window.print();
                });

                $("#pQ").addEventListener("input", renderAll);
                $("#pOwner").addEventListener("input", renderAll);
                $("#pStatus").addEventListener("change", renderAll);
                $("#pStage").addEventListener("change", renderAll);

                $("#pmAddNote").addEventListener("click", () => {
                    const note = String($("#pmNote").value || "").trim();
                    if (!note) {
                        IS.toast("Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© Ø£ÙˆÙ„Ù‹Ø§", "warn", 1400);
                        return;
                    }
                    const p = mutateActivePolicy((policy) => {
                        addPolicyHistory(policy, note, "Policy Manager");
                    });
                    if (!p) return;
                    IS.audit("Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ø³Ø¬Ù„ Ø³ÙŠØ§Ø³Ø©", p.id);
                    $("#pmNote").value = "";
                    renderAll();
                    openPolicyModal(p.id);
                });

                $("#pmSave").addEventListener("click", () => {
                    const nextStatus = $("#pmStatus").value;
                    const nextCompliance = clamp(Number($("#pmCompliance").value || 0), 0, 100);
                    const note = String($("#pmNote").value || "").trim();

                    const p = mutateActivePolicy((policy) => {
                        const beforeStatus = policy.status;
                        const beforeCompliance = policy.compliancePct;
                        policy.status = POLICY_STATUS.includes(nextStatus) ? nextStatus : policy.status;
                        policy.compliancePct = nextCompliance;
                        if (note) addPolicyHistory(policy, note, "Policy Manager");
                        if (beforeStatus !== policy.status || beforeCompliance !== policy.compliancePct) {
                            addPolicyHistory(policy, `ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ${policy.status} ÙˆØ§Ù…ØªØ«Ø§Ù„ ${policy.compliancePct}%`, "Policy Center");
                        }
                    });
                    if (!p) return;
                    IS.audit("ØªØ­Ø¯ÙŠØ« Ø³ÙŠØ§Ø³Ø©", p.id);
                    IS.save();
                    renderAll();
                    openPolicyModal(p.id);
                    IS.toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª âœ…", "ok", 1600);
                });

                $("#btnApiSettings").addEventListener("click", openApiModal);
                $("#btnApiSave").addEventListener("click", async () => {
                    const base = setApiBase($("#apiBaseInput").value);
                    $("#apiStateHint").textContent = `ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${base || "(ÙØ§Ø±Øº)"}`;
                    const res = await syncPoliciesFromApi({ silent: true });
                    if (res.ok) {
                        IS.toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­ âœ…", "ok", 1800);
                        closeApiModal();
                        renderAll();
                    } else {
                        IS.toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¹ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.", "warn", 2000);
                    }
                });

                $("#btnApiTest").addEventListener("click", async () => {
                    const base = setApiBase($("#apiBaseInput").value);
                    $("#apiStateHint").textContent = "Ø¬Ø§Ø±Ù Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...";
                    const res = await syncPoliciesFromApi({ silent: true });
                    if (res.ok) {
                        $("#apiStateHint").textContent = `Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§ØªØµØ§Ù„ (${base}) â€¢ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª: ${fmt(res.count || 0)}`;
                        IS.toast("Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­ âœ…", "ok", 1600);
                        renderAll();
                    } else {
                        $("#apiStateHint").textContent = "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.";
                        IS.toast("Ø§Ù„Ø§ØªØµØ§Ù„ ØºÙŠØ± Ù…ØªØ§Ø­", "warn", 1700);
                    }
                });

                $$('[data-close-policy]').forEach((el) => el.addEventListener('click', closePolicyModal));
                $$('[data-close-api]').forEach((el) => el.addEventListener('click', closeApiModal));

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closePolicyModal();
                        closeApiModal();
                    }
                });
            }

            document.addEventListener("DOMContentLoaded", init);
        })();
    </script>

</body>

</html>
